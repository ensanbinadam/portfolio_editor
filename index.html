
<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>محرر ملف الإنجاز | portfolio_editor</title>
    <style>
      :root {
        --primary: #4361ee;
        --secondary: #3f37c9;
        --success: #4cc9f0;
        --dark: #1e1e2c;
        --light: #f8f9fa;
        --gray: #6c757d;
        --danger: #e5383b;
        --warning: #fca311;
        --sidebar-width: 280px;
        --editor-font-size: 16px;
        --page-print-bg: #f5f7fb;
        --editor-print-bg: #ffffff;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", "Cairo", Tahoma, Geneva, Verdana, sans-serif;
      }
      body {
        background: #f5f7fb;
        color: #333;
        line-height: 1.6;
      }
      .container {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(135deg, var(--dark), var(--secondary));
        color: #fff;
        padding: 20px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      .app-title {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }
      .app-title h1 {
        font-size: 1.5rem;
        margin-bottom: 5px;
      }
      .app-title p {
        font-size: 0.9rem;
        opacity: 0.8;
      }
      .tabs-container {
        margin-bottom: 20px;
      }
      .tab {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 8px;
        color: #fff;
        padding: 12px 15px;
        margin-bottom: 10px;
        cursor: pointer;
        width: 100%;
        text-align: right;
        transition: all 0.25s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .tab:hover {
        filter: brightness(1.06);
      }
      .tab.active {
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
        outline: 2px solid rgba(255, 255, 255, 0.7);
        outline-offset: -2px;
        transform: translateY(-1px);
      }
      .tabs-container .tab:nth-child(6n + 1) {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      }
      .tabs-container .tab:nth-child(6n + 2) {
        background: linear-gradient(135deg, #10b981, #047857);
      }
      .tabs-container .tab:nth-child(6n + 3) {
        background: linear-gradient(135deg, #f59e0b, #b45309);
      }
      .tabs-container .tab:nth-child(6n + 4) {
        background: linear-gradient(135deg, #ef4444, #b91c1c);
      }
      .tabs-container .tab:nth-child(6n + 5) {
        background: linear-gradient(135deg, #06b6d4, #0e7490);
      }
      .tabs-container .tab:nth-child(6n) {
        background: linear-gradient(135deg, #a855f7, #6b21a8);
      }
      .tab-actions {
        display: flex;
        gap: 5px;
      }
      .tab-btn {
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 14px;
        opacity: 0.7;
        transition: opacity 0.3s;
      }
      .tab-btn:hover {
        opacity: 1;
      }
      .sidebar-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
      }
      .sidebar-btn {
        background: rgba(255, 255, 255, 0.15);
        border: none;
        border-radius: 8px;
        color: #fff;
        padding: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
      }
      .sidebar-btn:hover {
        background: rgba(255, 255, 255, 0.25);
      }
      .sidebar-btn.delete {
        background: rgba(229, 56, 59, 0.2);
      }
      .sidebar-btn.delete:hover {
        background: rgba(229, 56, 59, 0.3);
      }
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .toolbar {
        background: #fff;
        padding: 15px 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .toolbar-group {
        display: flex;
        gap: 6px;
        padding: 5px;
        border-radius: 6px;
        background: #f0f2f5;
        align-items: center;
      }
      .toolbar-btn {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      .toolbar-btn:hover {
        background: #f0f2f5;
        border-color: #ccc;
      }
      .toolbar-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #fff;
        cursor: pointer;
      }
      .color-input {
        width: 34px;
        height: 34px;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 0;
        background: #fff;
        cursor: pointer;
      }
      .color-label {
        font-size: 18px;
        line-height: 1;
      }
      .editor {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        background: #fff;
        margin: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      .editor-content {
        min-height: 500px;
        padding: 20px;
        border: 1px solid #eaeaea;
        border-radius: 8px;
        outline: none;
        font-size: var(--editor-font-size);
      }
      .editor-content h1 {
        font-size: 2em;
        margin: 0.6em 0 0.4em;
      }
      .editor-content h2 {
        font-size: 1.6em;
        margin: 0.6em 0 0.4em;
      }
      .editor-content h3 {
        font-size: 1.3em;
        margin: 0.6em 0 0.4em;
      }
      .action-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
        padding: 20px;
        background: #fff;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }
      .action-btn {
        padding: 12px 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .action-btn.export {
        background: var(--primary);
        color: #fff;
      }
      .action-btn.import {
        background: #fff;
        color: var(--primary);
        border: 2px solid var(--primary);
      }
      .action-btn.generate {
        background: var(--success);
        color: #fff;
      }
      .action-btn.pdf {
        background: #111827;
        color: #fff;
      }
      .action-btn:hover {
        filter: brightness(0.95);
      }
      #jsError {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: #e5383b;
        color: #fff;
        padding: 10px 14px;
        border-radius: 8px;
        z-index: 1300;
        display: none;
      }

      /* ===== Embeds ===== */
      .embed-container {
        margin: 15px 0;
        border: 1px dashed #ddd;
        border-radius: 8px;
        padding: 10px;
        position: relative;
        background: #fff;
      }
      .embed-container:focus-within {
        outline: 2px dashed var(--secondary);
        outline-offset: 6px;
      }
      .embed-actions {
        position: absolute;
        top: -15px;
        left: 10px;
        background: #fff;
        padding: 5px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: none;
        gap: 6px;
        z-index: 5;
      }
      .embed-container:hover .embed-actions {
        display: flex;
      }
      .embed-btn {
        background: #f0f2f5;
        border: none;
        border-radius: 4px;
        padding: 5px 8px;
        cursor: pointer;
        margin: 0 2px;
        font-size: 12px;
      }
      .embed-caption {
        margin-top: 8px;
        font-size: 0.92rem;
        color: #444;
        background: #fafafa;
        border: 1px dashed #ddd;
        border-radius: 6px;
        padding: 6px 8px;
      }
      .embed-caption:empty:before {
        content: attr(data-placeholder);
        color: #9aa1a9;
      }
      .download-link {
        display: block;
        text-align: center;
        margin-top: 10px;
        color: var(--primary);
        text-decoration: none;
      }
      .download-link:hover {
        text-decoration: underline;
      }
      .embed-media {
        display: inline-block;
        max-width: 100%;
      }
      .resizable-x {
        resize: horizontal;
        overflow: auto;
      }
      .resizable-both {
        resize: both;
        overflow: auto;
      }
      .embed-media > img {
        display: block;
        width: 100%;
        height: auto;
      }
      .embed-media > video,
      .embed-media > iframe {
        display: block;
        width: 100%;
        height: 100%;
      }

      /* ===== جدول المحرر + الشريط العائم ===== */
      .rte-table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
      }
      .rte-table th,
      .rte-table td {
        border: 1px solid #e5e7eb;
        padding: 8px;
        background: #fff;
        vertical-align: top;
      }
      .rte-table th {
        background: #f8fafc;
        font-weight: 700;
      }
      .rte-table td:focus,
      .rte-table th:focus {
        outline: 2px solid rgba(67, 97, 238, 0.35);
      }
      .table-bubble {
        position: absolute;
        display: none;
        z-index: 1200;
        background: #111827;
        color: #fff;
        border-radius: 8px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        padding: 6px;
        gap: 6px;
        align-items: center;
      }
      .table-bubble .tb-btn {
        border: none;
        border-radius: 6px;
        background: #1f2937;
        color: #fff;
        padding: 6px 8px;
        cursor: pointer;
        font-size: 12px;
      }
      .table-bubble .tb-btn:hover {
        background: #374151;
      }
      .table-bubble .sep {
        width: 1px;
        height: 20px;
        background: rgba(255, 255, 255, 0.18);
        margin: 0 4px;
      }
      .table-bubble .tb-color {
        width: 30px;
        height: 30px;
        border: 1px solid #444;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        padding: 0;
      }

      /* ===== Notification ===== */
      .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 20px;
        background: var(--dark);
        color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s;
        z-index: 1200;
      }
      .notification.show {
        transform: translateY(0);
        opacity: 1;
      }
      .notification.success {
        background: var(--success);
      }
      .notification.error {
        background: var(--danger);
      }

      /* ===== Preview ===== */
      .final-portfolio {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--page-print-bg);
        z-index: 1100;
        overflow-y: auto;
      }
      .portfolio-header {
        background: var(--primary);
        color: #fff;
        padding: 20px;
        padding-right: calc(280px + 20px);
      }
      .header-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }
      .header-btn {
        background: #ffffff;
        border: none;
        color: #1f2937;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      .header-btn.export {
        background: #111827;
        color: #fff;
      }
      .portfolio-header-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }
      .portfolio-logo {
        width: 80px;
        height: 80px;
        object-fit: contain;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
      }
      .portfolio-logo:not([src]),
      .portfolio-logo[src=""] {
        display: none;
      }
      .portfolio-titles h1 {
        margin: 0;
      }
      .portfolio-subtitle {
        opacity: 0.95;
        font-size: 1.05rem;
      }
      .portfolio-sidebar {
        width: 250px;
        background: #f0f2f5;
        height: 100vh;
        position: fixed;
        top: 0;
        right: 0;
        padding: 20px;
        overflow-y: auto;
      }
      .portfolio-sidebar a {
        display: block;
        padding: 8px 10px;
        margin-bottom: 5px;
        text-decoration: none;
        border-radius: 6px;
        color: #fff !important;
        transition: filter 0.2s ease;
      }
      .portfolio-sidebar a:hover {
        filter: brightness(1.06);
      }
      .portfolio-sidebar a:nth-of-type(6n + 1) {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      }
      .portfolio-sidebar a:nth-of-type(6n + 2) {
        background: linear-gradient(135deg, #10b981, #047857);
      }
      .portfolio-sidebar a:nth-of-type(6n + 3) {
        background: linear-gradient(135deg, #f59e0b, #b45309);
      }
      .portfolio-sidebar a:nth-of-type(6n + 4) {
        background: linear-gradient(135deg, #ef4444, #b91c1c);
      }
      .portfolio-sidebar a:nth-of-type(6n + 5) {
        background: linear-gradient(135deg, #06b6d4, #0e7490);
      }
      .portfolio-sidebar a:nth-of-type(6n) {
        background: linear-gradient(135deg, #a855f7, #6b21a8);
      }
      .portfolio-content {
        margin-right: 250px;
        padding: 20px;
        background: var(--editor-print-bg);
      }
      .portfolio-footer {
        margin: 20px auto 0;
        text-align: center;
        color: #333;
        border-top: 1px solid #e0e0e0;
        padding-top: 12px;
      }
      .tab-content {
        display: none;
        border: 2px dashed #e5e7eb;
        border-radius: 10px;
        padding: 16px;
        background: #fff;
        margin-bottom: 16px;
      }
      .portfolio-content .tab-content:nth-of-type(6n + 1) {
        border-color: #1d4ed8;
      }
      .portfolio-content .tab-content:nth-of-type(6n + 2) {
        border-color: #047857;
      }
      .portfolio-content .tab-content:nth-of-type(6n + 3) {
        border-color: #b45309;
      }
      .portfolio-content .tab-content:nth-of-type(6n + 4) {
        border-color: #b91c1c;
      }
      .portfolio-content .tab-content:nth-of-type(6n + 5) {
        border-color: #0e7490;
      }
      .portfolio-content .tab-content:nth-of-type(6n) {
        border-color: #6b21a8;
      }
      .tab-content.active {
        display: block;
      }
      .close-portfolio {
        position: absolute;
        top: 20px;
        left: 20px;
        background: #fff;
        color: #4361ee;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* ===== مودالات (الإصلاح هنا) ===== */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1400;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .modal-content {
        width: min(680px, 100%);
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        direction: rtl;
      }
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .modal-title {
        font-size: 1.15rem;
        margin: 0;
      }
      .close-modal {
        background: transparent;
        border: none;
        font-size: 26px;
        cursor: pointer;
        line-height: 1;
      }
      .form-group {
        margin-bottom: 12px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }
      .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        background: #fff;
      }
      .form-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
      }
      .btn {
        padding: 10px 14px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn-primary {
        background: var(--primary);
        color: #fff;
      }
      .btn-secondary {
        background: #f0f2f5;
        color: #111827;
      }
      .file-preview {
        margin-top: 8px;
        background: #f8fafc;
        border: 1px dashed #e5e7eb;
        border-radius: 8px;
        padding: 8px;
      }

      @media (max-width: 992px) {
        .container {
          flex-direction: column;
        }
        .sidebar {
          width: 100%;
          height: auto;
        }
        .toolbar {
          overflow-x: auto;
        }
      }
      @media print {
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        html,
        body {
          background: var(--page-print-bg) !important;
        }
        .header-actions,
        .header-btn,
        .sidebar,
        .toolbar,
        .action-buttons,
        .modal,
        .notification,
        .close-portfolio {
          display: none !important;
        }
        .final-portfolio {
          position: static !important;
          display: block !important;
          background: var(--page-print-bg) !important;
          height: auto !important;
        }
        .portfolio-sidebar {
          display: none !important;
        }
        .portfolio-content {
          margin: 0 !important;
          background: var(--editor-print-bg) !important;
          box-shadow: none !important;
          font-size: inherit !important;
        }
        .tab-content {
          display: block !important;
          break-inside: avoid;
          page-break-inside: avoid;
          margin-bottom: 16px;
        }
        .portfolio-header {
          background: var(--primary) !important;
          color: #fff !important;
          padding-right: 20px !important;
          padding-left: 20px !important;
        }
        .portfolio-header-inner {
          justify-content: flex-start !important;
        }
        @page {
          size: A4;
          margin: 12mm;
        }
      }

      .footer {
        font-family: "Cairo", Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text);
        text-align: center;
        padding: 14px 12px;
        border-top: 1px solid #e5e7eb;
        background: transparent;
        line-height: 1.7;
        font-size: 0.95rem;
      }
      .footer .line {
        margin: 2px 0;
      }
      .footer a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 700;
      }
      .footer a:hover {
        text-decoration: underline;
      }
      .footer .sep {
        margin: 0 6px;
        color: var(--muted);
      }
      @media print {
        .footer {
          page-break-inside: avoid;
          font-size: 0.9rem;
        }
        .footer a {
          color: #1f3af5 !important;
          text-decoration: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="jsError"></div>
    <div class="container">
      <aside class="sidebar">
        <div class="app-title">
          <h1>محرر ملف الإنجاز</h1>
          <p>نسخةالإصدار الاول ـ مرحبا بك</p>
        </div>
        <div class="tabs-container" id="tabsContainer"></div>
        <div class="sidebar-actions">
          <button class="sidebar-btn" type="button" onclick="UI.addTab()">
            تبويب جديد
          </button>
          <button
            class="sidebar-btn delete"
            type="button"
            onclick="UI.deleteActive()"
          >
            حذف التبويب
          </button>
          <button class="sidebar-btn" type="button" onclick="UI.newProject()">
            مشروع جديد
          </button>
        </div>
      </aside>

      <main class="main-content">
        <div class="toolbar">
          <div class="toolbar-group">
            <select
              class="toolbar-select"
              id="formatSelect"
              aria-label="تنسيق"
              onchange="UI.format(this.value)"
            >
              <option value="p">نص عادي</option>
              <option value="h1">عنوان رئيسي</option>
              <option value="h2">عنوان فرعي</option>
              <option value="h3">عنوان ثانوي</option>
            </select>
          </div>

          <div class="toolbar-group">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="عريض"
              onclick="UI.exec('bold')"
            >
              <b>B</b>
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="مائل"
              onclick="UI.exec('italic')"
            >
              <i>I</i>
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="تحته خط"
              onclick="UI.exec('underline')"
            >
              <u>U</u>
            </button>
          </div>

          <div class="toolbar-group">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="قائمة نقطية"
              onclick="UI.exec('insertUnorderedList')"
            >
              • قائمة
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="قائمة رقمية"
              onclick="UI.exec('insertOrderedList')"
            >
              1. قائمة
            </button>
          </div>

          <div class="toolbar-group">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="محاذاة يمين"
              onclick="UI.exec('justifyRight')"
            >
              ⟸
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="توسيط"
              onclick="UI.exec('justifyCenter')"
            >
              ↔
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="محاذاة يسار"
              onclick="UI.exec('justifyLeft')"
            >
              ⟹
            </button>
          </div>

          <div class="toolbar-group" title="تكبير/تصغير الخط">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="تصغير الخط"
              onclick="UI.font(-2)"
            >
              A−
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="تكبير الخط"
              onclick="UI.font(+2)"
            >
              A+
            </button>
          </div>

          <div class="toolbar-group" title="لون الخط">
            <span class="color-label">🎨</span>
            <input
              type="color"
              id="fontColorPicker"
              class="color-input"
              aria-label="لون الخط"
              onchange="UI.color(this.value)"
            />
          </div>

          <div class="toolbar-group" title="الخلفيات">
            <span class="color-label">🖼️</span>
            <input
              type="color"
              id="editorBgPicker"
              class="color-input"
              aria-label="خلفية المحرر"
              value="#ffffff"
              onchange="UI.setEditorBg(this.value)"
            />
            <span class="color-label">🧩</span>
            <input
              type="color"
              id="pageBgPicker"
              class="color-input"
              aria-label="خلفية الصفحة"
              value="#f5f7fb"
              onchange="UI.setPageBg(this.value)"
            />
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إعادة المظهر"
              onclick="UI.resetAppearance()"
            >
              إعادة
            </button>
          </div>

          <div class="toolbar-group" title="روابط">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إضافة رابط"
              onclick="UI.openLinkModalForSelection()"
            >
              🔗 رابط
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="فك الرابط"
              onclick="UI.unlinkSelection()"
            >
              ⛓️ فك
            </button>
          </div>

          <div class="toolbar-group">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إدراج صورة"
              onclick="UI.openMedia()"
            >
              صورة
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إدراج ملف"
              onclick="UI.openMedia()"
            >
              ملف
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إدراج فيديو"
              onclick="UI.openMedia()"
            >
              فيديو
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إدراج ملف أوفيس"
              onclick="UI.openOffice()"
            >
              أوفيس
            </button>
          </div>

          <div class="toolbar-group" title="اللصق">
            <span style="padding: 0 6px; font-size: 13px">اللصق:</span>
            <button
              class="toolbar-btn"
              type="button"
              onclick="UI.setPasteMode('smart')"
            >
              ذكي
            </button>
            <button
              class="toolbar-btn"
              type="button"
              onclick="UI.setPasteMode('plain')"
            >
              نصي
            </button>
          </div>

          <div class="toolbar-group" title="جدول">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إدراج جدول"
              onclick="UI.openTableModal()"
            >
              جدول
            </button>
          </div>
        </div>

        <div class="editor" id="editorWrapper">
          <div class="editor-content" id="editor" contenteditable="true">
            <h1>محرر ملف الإنجاز | portfolio_editor</h1>
            <p>
              إصلاح ظهور نصوص المودالات أسفل الصفحة + مزايا اللصق الذكي وتلوين
              خلايا الجداول كما في النسخة السابقة.
            </p>
          </div>

          <!-- شريط تحكم الجداول العائم -->
          <div class="table-bubble" id="tableBubble" dir="rtl">
            <button class="tb-btn" data-act="row-before" title="إضافة صف قبل">
              صف ↑
            </button>
            <button class="tb-btn" data-act="row-after" title="إضافة صف بعد">
              صف ↓
            </button>
            <span class="sep"></span>
            <button class="tb-btn" data-act="col-before" title="إضافة عمود قبل">
              عمود ←
            </button>
            <button class="tb-btn" data-act="col-after" title="إضافة عمود بعد">
              عمود →
            </button>
            <span class="sep"></span>
            <button
              class="tb-btn"
              data-act="toggle-header"
              title="تبديل صف العنوان"
            >
              رأس
            </button>
            <span class="sep"></span>
            <input
              type="color"
              id="cellBgPicker"
              class="tb-color"
              title="لون خلفية الخلية"
            />
            <button class="tb-btn" data-act="cell-bg" title="تطبيق اللون">
              لون
            </button>
            <button class="tb-btn" data-act="cell-bg-clear" title="مسح اللون">
              مسح
            </button>
            <span class="sep"></span>
            <button class="tb-btn" data-act="del-row" title="حذف الصف">
              حذف صف
            </button>
            <button class="tb-btn" data-act="del-col" title="حذف العمود">
              حذف عمود
            </button>
            <button class="tb-btn" data-act="del-table" title="حذف الجدول">
              حذف الجدول
            </button>
          </div>
        </div>

        <div class="action-buttons">
          <button
            class="action-btn export"
            type="button"
            aria-label="تصدير المشروع"
            onclick="UI.exportProject()"
          >
            تصدير المشروع
          </button>
          <button
            class="action-btn import"
            type="button"
            aria-label="استيراد مشروع"
            onclick="UI.importProject()"
          >
            استيراد مشروع
          </button>
          <button
            class="action-btn generate"
            type="button"
            aria-label="معاينة ملف الإنجاز"
            onclick="UI.previewPortfolio()"
          >
            معاينة ملف الإنجاز
          </button>
          <button
            class="action-btn pdf"
            style="display: none"
            type="button"
            aria-label="تصدير PDF"
            onclick="UI.exportPDF()"
          >
            تصدير PDF (بنفس الألوان)
          </button>
        </div>
      </main>
    </div>

    <!-- النوافذ -->
    <div class="modal" id="newTabModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">إنشاء تبويب جديد</h2>
          <button
            class="close-modal"
            onclick="UI.hide(document.getElementById('newTabModal'))"
          >
            &times;
          </button>
        </div>
        <div class="form-group">
          <label for="tabTitle">اسم التبويب</label>
          <input
            type="text"
            class="form-control"
            id="tabTitle"
            placeholder="أدخل اسم التبويب"
            onkeypress="if(event.key==='Enter'){UI.createTab()}"
          />
        </div>
        <div class="form-actions">
          <button
            class="btn btn-secondary"
            onclick="UI.hide(document.getElementById('newTabModal'))"
          >
            إلغاء
          </button>
          <button class="btn btn-primary" onclick="UI.createTab()">
            إنشاء
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="mediaModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="mediaModalTitle">إدراج وسائط</h2>
          <button
            class="close-modal"
            onclick="UI.hide(document.getElementById('mediaModal'))"
          >
            &times;
          </button>
        </div>
        <div
          class="file-type-buttons"
          style="display: flex; gap: 10px; margin-bottom: 10px"
        >
          <button
            class="toolbar-btn"
            onclick="UI.toggleMediaType('upload')"
            id="btnUpload"
          >
            رفع ملف
          </button>
          <button
            class="toolbar-btn"
            onclick="UI.toggleMediaType('url')"
            id="btnUrl"
          >
            رابط خارجي
          </button>
        </div>
        <div id="uploadFileSection">
          <div class="form-group">
            <label for="mediaFile">اختر ملف للرفع</label>
            <input
              type="file"
              class="form-control"
              id="mediaFile"
              accept=".jpg,.jpeg,.png,.gif,.webp,.mp4,.webm,.ogg,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx"
            />
            <small>يدعم الصور، الفيديو، PDF، وملفات Office</small>
          </div>
          <div
            class="file-preview"
            id="filePreview"
            style="display: none"
          ></div>
        </div>
        <div id="urlFileSection" style="display: none">
          <div class="form-group">
            <label for="mediaUrl">أدخل رابط الملف</label>
            <input
              type="text"
              class="form-control"
              id="mediaUrl"
              placeholder="https://example.com/file.pdf"
            />
          </div>
          <div class="form-group">
            <label for="fileType">نوع الملف</label>
            <select class="form-control" id="fileType">
              <option value="auto">تحديد تلقائي</option>
              <option value="image">صورة</option>
              <option value="video">فيديو</option>
              <option value="pdf">PDF</option>
              <option value="word">Word</option>
              <option value="excel">Excel</option>
              <option value="powerpoint">PowerPoint</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="mediaCaption">وصف (اختياري)</label>
          <input
            type="text"
            class="form-control"
            id="mediaCaption"
            placeholder="وصف الملف"
          />
        </div>
        <div class="form-actions">
          <button
            class="btn btn-secondary"
            onclick="UI.hide(document.getElementById('mediaModal'))"
          >
            إلغاء
          </button>
          <button class="btn btn-primary" onclick="UI.insertMedia()">تم</button>
        </div>
      </div>
    </div>

    <div class="modal" id="linkModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">إدراج/تعديل رابط</h2>
          <button
            class="close-modal"
            onclick="UI.hide(document.getElementById('linkModal'))"
          >
            &times;
          </button>
        </div>
        <div class="form-group">
          <label for="linkUrl">عنوان الرابط (URL)</label>
          <input
            type="text"
            class="form-control"
            id="linkUrl"
            placeholder="https://example.com أو mailto:user@example.com"
          />
        </div>
        <div
          class="form-group"
          style="display: flex; gap: 8px; align-items: center"
        >
          <input type="checkbox" id="linkNewTab" checked />
          <label for="linkNewTab">فتح في تبويب جديد</label>
        </div>
        <div class="form-actions">
          <button
            class="btn btn-secondary"
            onclick="UI.hide(document.getElementById('linkModal'))"
          >
            إلغاء
          </button>
          <button class="btn btn-primary" onclick="UI.confirmLink()">
            حفظ الرابط
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="tableModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">إدراج جدول</h2>
          <button
            class="close-modal"
            onclick="UI.hide(document.getElementById('tableModal'))"
          >
            &times;
          </button>
        </div>
        <div class="form-group">
          <label>عدد الصفوف</label>
          <input
            type="number"
            min="1"
            max="50"
            value="3"
            id="tblRows"
            class="form-control"
          />
        </div>
        <div class="form-group">
          <label>عدد الأعمدة</label>
          <input
            type="number"
            min="1"
            max="20"
            value="3"
            id="tblCols"
            class="form-control"
          />
        </div>
        <div class="form-actions">
          <button
            class="btn btn-secondary"
            onclick="UI.hide(document.getElementById('tableModal'))"
          >
            إلغاء
          </button>
          <button class="btn btn-primary" onclick="UI.createTable()">
            إدراج
          </button>
        </div>
      </div>
    </div>

    <div class="final-portfolio" id="finalPortfolio">
      <button class="close-portfolio" onclick="UI.closePreview()">
        &times;
      </button>
      <div class="portfolio-header">
        <div class="portfolio-header-inner" dir="rtl">
          <img id="portfolioHeaderLogo" class="portfolio-logo" alt="شعار" />
          <div class="portfolio-titles">
            <h1 id="portfolioHeaderTitle">ملف الإنجاز</h1>
            <div id="portfolioHeaderSubtitle" class="portfolio-subtitle"></div>
          </div>
          <div class="header-actions">
            <button
              class="header-btn"
              type="button"
              onclick="UI.closePreview()"
            >
              رجوع للمحرر
            </button>
            <button
              class="header-btn"
              type="button"
              onclick="UI.exportZIP()"
              title="حزمة ZIP (للنشر)"
              aria-label="حزمة ZIP (للنشر)"
            >
              حزمة ZIP (للنشر)
            </button>
            <button
              class="header-btn export"
              type="button"
              onclick="UI.exportHTML()"
              title="تصدير HTML (ملف واحد)"
              aria-label="تصدير HTML (ملف واحد)"
            >
              تصدير HTML
            </button>
          </div>
        </div>
      </div>
      <div class="portfolio-sidebar" id="portfolioSidebar">
        <h3>فهرس المحتويات</h3>
      </div>
      <div class="portfolio-content" id="portfolioContent"></div>
    </div>

    <div class="notification" id="notification">
      <span id="notificationMessage"></span>
    </div>

    <footer class="footer" dir="rtl">
      <div class="line">
        <span>برمجة: أ/فاطمة هزازي، أ/عبدالعزيز العبدالجبار</span
        ><span class="sep">•</span><span>باستخدام</span>
        <a href="https://chatgpt.com" target="_blank" rel="noopener noreferrer"
          >ChatGPT</a
        >
      </div>
      <div class="line">جميع الحقوق محفوظة لملتقى معلمي ومعلمات الرياضيات</div>
      <div class="line">
        <span>للاستفسار والتواصل: </span>
        <a href="https://t.me/ITG_KSA" target="_blank" rel="noopener noreferrer"
          >ملتقى التعليم التفاعلي</a
        >
      </div>
    </footer>

    <script>
      (function () {
        window.onerror = function (msg) {
          const b = document.getElementById("jsError");
          b.textContent = "خطأ: " + msg;
          b.style.display = "block";
        };
        window.onunhandledrejection = function (e) {
          const b = document.getElementById("jsError");
          b.textContent =
            "وعد مرفوض: " + ((e.reason && e.reason.message) || e.reason || "");
          b.style.display = "block";
        };

        const state = {
          tabs: [{ id: id(), title: "الغلاف", content: "" }],
          activeTabId: null,
          mediaType: "upload",
          settings: {
            editorFontSize: 16,
            pageBg: "#f5f7fb",
            editorBg: "#ffffff",
          },
          portfolio: {
            teacherName: "",
            teacherLabel: "المعلم/ـة",
            footerText: "",
            logoData: "",
          },
          savedRange: null,
          linkContext: null,
          currentCell: null,
          pasteMode: "smart",
        };

        const el = {
          tabsContainer: document.getElementById("tabsContainer"),
          editor: document.getElementById("editor"),
          editorWrapper: document.getElementById("editorWrapper"),
          finalPortfolio: document.getElementById("finalPortfolio"),
          portfolioSidebar: document.getElementById("portfolioSidebar"),
          portfolioContent: document.getElementById("portfolioContent"),
          portfolioHeaderTitle: document.getElementById("portfolioHeaderTitle"),
          filePreview: document.getElementById("filePreview"),
          linkUrl: document.getElementById("linkUrl"),
          linkNewTab: document.getElementById("linkNewTab"),
          tableBubble: document.getElementById("tableBubble"),
          cellBgPicker: document.getElementById("cellBgPicker"),
        };

        function note(msg, type) {
          const n = document.getElementById("notification");
          document.getElementById("notificationMessage").textContent = msg;
          n.className = "notification " + (type || "success");
          n.classList.add("show");
          setTimeout(() => n.classList.remove("show"), 2200);
        }
        function show(m) {
          m.style.display = "flex";
        }
        function hide(m) {
          m.style.display = "none";
        }
        function id() {
          return Date.now().toString(36) + Math.random().toString(36).slice(2);
        }
        function esc(s) {
          return (s || "").replace(
            /[&<>\"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[m])
          );
        }
        function sanitizeUrl(url) {
          const t = (url || "").trim();
          if (!t) return "";
          if (/^(https?:|mailto:|tel:)/i.test(t)) return t;
          return "https://" + t.replace(/^\/+/, "");
        }

        function applySettings() {
          el.editor.style.setProperty(
            "--editor-font-size",
            state.settings.editorFontSize + "px"
          );
          document.body.style.backgroundColor = state.settings.pageBg;
          el.editorWrapper.style.backgroundColor = state.settings.editorBg;
          document.documentElement.style.setProperty(
            "--page-print-bg",
            state.settings.pageBg
          );
          document.documentElement.style.setProperty(
            "--editor-print-bg",
            state.settings.editorBg
          );
        }

        const STORAGE_KEY = "portfolio_v36";
        function saveToStorage() {
          try {
            const a = state.tabs.find((x) => x.id === state.activeTabId);
            if (a) a.content = el.editor.innerHTML;
            const data = {
              version: "3.6",
              tabs: state.tabs,
              settings: state.settings,
              portfolio: state.portfolio,
              activeTabId: state.activeTabId,
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          } catch (_) {}
        }
        function loadFromStorage() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return null;
            const d = JSON.parse(raw);
            if (!d || !Array.isArray(d.tabs) || !d.tabs.length) return null;
            state.tabs = d.tabs;
            state.settings = d.settings || state.settings;
            state.portfolio = d.portfolio || state.portfolio;
            applySettings();
            const eb = document.getElementById("editorBgPicker");
            if (eb) eb.value = state.settings.editorBg || "#ffffff";
            const pb = document.getElementById("pageBgPicker");
            if (pb) pb.value = state.settings.pageBg || "#f5f7fb";
            return d.activeTabId || state.tabs[0].id;
          } catch (_) {
            return null;
          }
        }

        function ensureRangeInEditor() {
          const sel = window.getSelection();
          if (
            !sel ||
            sel.rangeCount === 0 ||
            !el.editor.contains(sel.anchorNode)
          ) {
            el.editor.focus();
            const r = document.createRange();
            r.selectNodeContents(el.editor);
            r.collapse(false);
            const s = window.getSelection();
            s.removeAllRanges();
            s.addRange(r);
            return r;
          }
          return sel.getRangeAt(0);
        }
        function saveSel() {
          const s = window.getSelection();
          if (s && s.rangeCount > 0 && el.editor.contains(s.anchorNode))
            state.savedRange = s.getRangeAt(0);
        }
        function restoreSel() {
          const s = window.getSelection();
          const r = state.savedRange;
          if (!r) return;
          try {
            const c = r.commonAncestorContainer;
            if (!document.contains(c) || !el.editor.contains(c)) throw 0;
            s.removeAllRanges();
            s.addRange(r);
          } catch (_) {
            state.savedRange = null;
          }
        }

        /* === جداول: أدوات === */
        function getCellFromSelection() {
          const s = window.getSelection();
          if (!s || s.rangeCount === 0) return null;
          let n = s.anchorNode;
          if (n && n.nodeType === 3) n = n.parentElement;
          while (n && n !== el.editor) {
            if (n.tagName === "TD" || n.tagName === "TH") return n;
            n = n.parentElement;
          }
          return null;
        }
        function tableInfo(td) {
          if (!td) return null;
          const tr = td.parentElement;
          const table = td.closest("table");
          if (!table) return null;
          const rows = [...table.rows];
          const rIndex = tr.rowIndex;
          const cells = [...tr.cells];
          let cIndex = cells.indexOf(td);
          return { table, tr, td, rows, rIndex, cIndex };
        }
        function showTableBubbleFor(td) {
          if (!td) return hideTableBubble();
          state.currentCell = td;
          const cur = getComputedStyle(td).backgroundColor;
          const hex = rgbToHex(cur) || "#ffffff";
          if (el.cellBgPicker) el.cellBgPicker.value = hex;

          const rect = td.getBoundingClientRect();
          const host = el.editorWrapper.getBoundingClientRect();
          const b = el.tableBubble;
          b.style.top =
            rect.top -
            host.top +
            el.editorWrapper.scrollTop -
            b.offsetHeight -
            8 +
            "px";
          b.style.left =
            rect.left - host.left + el.editorWrapper.scrollLeft + "px";
          b.style.display = "flex";
        }
        function hideTableBubble() {
          el.tableBubble.style.display = "none";
          state.currentCell = null;
        }
        function rgbToHex(rgb) {
          const m = /rgba?\((\d+),\s*(\d+),\s*(\d+)/.exec(rgb || "");
          if (!m) return null;
          const r = Number(m[1]),
            g = Number(m[2]),
            b = Number(m[3]);
          const to = (n) => ("0" + n.toString(16)).slice(-2);
          return "#" + to(r) + to(g) + to(b);
        }

        /* === لصق ذكي (Word Tables) === */
        function sanitizeHTMLBasic(html) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const allowed = new Set([
            "P",
            "BR",
            "B",
            "STRONG",
            "I",
            "EM",
            "U",
            "A",
            "UL",
            "OL",
            "LI",
            "H1",
            "H2",
            "H3",
          ]);
          doc.body.querySelectorAll("*").forEach((n) => {
            const tag = n.tagName;
            if (!allowed.has(tag)) {
              const p = n.parentNode;
              while (n.firstChild) p.insertBefore(n.firstChild, n);
              p.removeChild(n);
              return;
            }
            [...n.attributes].forEach((a) => {
              if (!(tag === "A" && a.name.toLowerCase() === "href"))
                n.removeAttribute(a.name);
            });
            if (tag === "A") {
              const h = n.getAttribute("href") || "";
              n.setAttribute("href", sanitizeUrl(h));
            }
          });
          doc.body.innerHTML = doc.body.innerHTML.replace(
            /<\/?o:p[^>]*>/gi,
            ""
          );
          return doc.body.innerHTML;
        }

        function sanitizeTablesHTML(html) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");

          const allowed = new Set([
            "P",
            "BR",
            "B",
            "STRONG",
            "I",
            "EM",
            "U",
            "A",
            "UL",
            "OL",
            "LI",
            "H1",
            "H2",
            "H3",
            "TABLE",
            "TBODY",
            "THEAD",
            "TR",
            "TD",
            "TH",
            "CAPTION",
            "COLGROUP",
            "COL",
          ]);

          const keepAttrsPerTag = {
            A: ["href"],
            TD: ["rowspan", "colspan", "style"],
            TH: ["rowspan", "colspan", "style"],
            TABLE: ["style"],
            P: ["style"],
            H1: ["style"],
            H2: ["style"],
            H3: ["style"],
            LI: ["style"],
          };

          const allowStyles = (el) => {
            const tag = el.tagName;
            const raw = (el.getAttribute("style") || "").toLowerCase();
            if (!raw) {
              el.removeAttribute("style");
              return;
            }

            const map = {};
            raw.split(";").forEach((part) => {
              const kv = part.split(":");
              if (kv.length < 2) return;
              const k = kv[0].trim(),
                v = kv.slice(1).join(":").trim();
              if (!k) return;
              map[k] = v;
            });

            const out = [];
            if (tag === "TD" || tag === "TH") {
              if (map["background"])
                out.push("background-color:" + map["background"]);
              if (map["background-color"])
                out.push("background-color:" + map["background-color"]);
              if (map["text-align"])
                out.push("text-align:" + map["text-align"]);
              if (map["vertical-align"])
                out.push("vertical-align:" + map["vertical-align"]);
            } else {
              if (map["text-align"])
                out.push("text-align:" + map["text-align"]);
            }
            if (out.length) el.setAttribute("style", out.join("; "));
            else el.removeAttribute("style");
          };

          [...doc.body.querySelectorAll("*")].forEach((n) => {
            const tag = n.tagName;

            if (!allowed.has(tag)) {
              const p = n.parentNode;
              while (n.firstChild) p.insertBefore(n.firstChild, n);
              p.removeChild(n);
              return;
            }

            const keep = keepAttrsPerTag[tag] || [];
            [...n.attributes].forEach((a) => {
              const name = a.name.toLowerCase();
              if (!keep.includes(a.name)) n.removeAttribute(a.name);
              if (tag === "A" && name === "href") {
                n.setAttribute(
                  "href",
                  sanitizeUrl(n.getAttribute("href") || "")
                );
              }
            });

            if (keep.includes("style")) allowStyles(n);

            if (tag === "TABLE") {
              n.className = "rte-table";
              n.removeAttribute("border");
              n.removeAttribute("cellpadding");
              n.removeAttribute("cellspacing");
            }
          });

          doc.body.innerHTML = doc.body.innerHTML
            .replace(/<\/?o:p[^>]*>/gi, "")
            .replace(/\sclass="?Mso[^"]*"?/gi, "")
            .replace(/\smso-[^:]+:[^;"]+;?/gi, "");

          if (!doc.body.querySelector("table")) return sanitizeHTMLBasic(html);
          return doc.body.innerHTML;
        }

        /* === واجهة المستخدم === */
        window.UI = {
          show,
          hide,
          note,
          setPasteMode: (m) => {
            state.pasteMode = m === "plain" ? "plain" : "smart";
            note(
              "تم اختيار اللصق: " +
                (state.pasteMode === "smart" ? "ذكي" : "نصي")
            );
          },
          exec: (cmd) => {
            try {
              ensureRangeInEditor();
              document.execCommand(cmd, false, null);
              el.editor.focus();
              saveToStorage();
            } catch (_) {}
          },
          format: (tag) => {
            ensureRangeInEditor();
            const block = tag.toLowerCase() === "p" ? "P" : tag.toUpperCase();
            try {
              document.execCommand("formatBlock", false, "<" + block + ">");
            } catch (_) {
              try {
                document.execCommand("formatBlock", false, block);
              } catch (__) {}
            }
            el.editor.focus();
            saveToStorage();
          },
          font: (d) => {
            state.settings.editorFontSize = Math.max(
              10,
              Math.min(36, state.settings.editorFontSize + d)
            );
            applySettings();
            saveToStorage();
          },
          color: (val) => {
            ensureRangeInEditor();
            try {
              document.execCommand("foreColor", false, val);
            } catch (_) {}
            el.editor.focus();
            saveToStorage();
          },
          setEditorBg: (v) => {
            state.settings.editorBg = v;
            applySettings();
            saveToStorage();
          },
          setPageBg: (v) => {
            state.settings.pageBg = v;
            applySettings();
            saveToStorage();
          },
          resetAppearance: () => {
            state.settings.editorFontSize = 16;
            state.settings.pageBg = "#f5f7fb";
            state.settings.editorBg = "#ffffff";
            applySettings();
            saveToStorage();
          },

          addTab: () => {
            show(document.getElementById("newTabModal"));
          },
          createTab: () => {
            const t = document.getElementById("tabTitle").value.trim();
            if (!t) return note("أدخل اسم التبويب", "error");
            const nt = { id: id(), title: t, content: "" };
            state.tabs.push(nt);
            UI.setActiveTab(nt.id);
            hide(document.getElementById("newTabModal"));
            document.getElementById("tabTitle").value = "";
            saveToStorage();
          },
          setActiveTab: (tid) => {
            if (state.activeTabId) {
              const a = state.tabs.find((x) => x.id === state.activeTabId);
              if (a) a.content = el.editor.innerHTML;
            }
            state.activeTabId = tid;
            const n = state.tabs.find((x) => x.id === tid);
            el.editor.innerHTML = n ? n.content || "" : "";
            upgradeEmbeds(el.editor);
            renderTabs();
            saveToStorage();
            hideTableBubble();
          },
          renameTab: (tid) => {
            const t = state.tabs.find((x) => x.id === tid);
            if (!t) return;
            const v = prompt("اسم جديد:", t.title);
            if (v && v.trim()) {
              t.title = v.trim();
              renderTabs();
              saveToStorage();
              note("تم التعديل");
            }
          },
          duplicateTab: (tid) => {
            const t = state.tabs.find((x) => x.id === tid);
            if (!t) return;
            const nt = {
              id: id(),
              title: t.title + " - نسخة",
              content: t.content,
            };
            state.tabs.push(nt);
            UI.setActiveTab(nt.id);
            saveToStorage();
            note("تم النسخ");
          },
          deleteActive: () => {
            if (state.tabs.length <= 1)
              return note("لا يمكن حذف جميع التبويبات", "error");
            const i = state.tabs.findIndex((x) => x.id === state.activeTabId);
            if (confirm(`حذف التبويب "${state.tabs[i].title}"؟`)) {
              state.tabs.splice(i, 1);
              UI.setActiveTab(state.tabs[Math.max(0, i - 1)].id);
              saveToStorage();
              note("تم الحذف");
            }
          },
          newProject: () => {
            if (
              !confirm(
                "هل تريد بدء مشروع جديد؟ سيؤدي هذا لمسح المحفوظات المحلية."
              )
            )
              return;
            try {
              localStorage.removeItem(STORAGE_KEY);
            } catch (_) {}
            state.tabs = [{ id: id(), title: "الغلاف", content: "" }];
            state.activeTabId = null;
            state.mediaType = "upload";
            state.settings = {
              editorFontSize: 16,
              pageBg: "#f5f7fb",
              editorBg: "#ffffff",
            };
            state.portfolio = {
              teacherName: "",
              teacherLabel: "المعلم/ـة",
              footerText: "",
              logoData: "",
              title: "الغلاف",
            };
            applySettings();
            renderTabs();
            UI.setActiveTab(state.tabs[0].id);
            note("تم بدء مشروع جديد");
          },

          openMedia: () => {
            saveSel();
            state.mode = "insert";
            state.replaceTarget = null;
            document.getElementById("mediaModalTitle").textContent =
              "إدراج وسائط";
            UI.toggleMediaType("upload");
            const fInp = document.getElementById("mediaFile");
            if (fInp) fInp.value = "";
            el.filePreview.innerHTML = "";
            el.filePreview.style.display = "none";
            const uInp = document.getElementById("mediaUrl");
            if (uInp) uInp.value = "";
            const fType = document.getElementById("fileType");
            if (fType) fType.value = "auto";
            const cap = document.getElementById("mediaCaption");
            if (cap) cap.value = "";
            show(document.getElementById("mediaModal"));
          },
          openOffice: () => {
            UI.openMedia();
            UI.toggleMediaType("url");
            document.getElementById("fileType").value = "word";
          },
          toggleMediaType: (t) => {
            state.mediaType = t;
            document.getElementById("uploadFileSection").style.display =
              t === "upload" ? "block" : "none";
            document.getElementById("urlFileSection").style.display =
              t === "url" ? "block" : "none";
          },
          insertMedia: insertMediaImpl,

          openLinkModalForSelection: () => {
            state.linkContext = null;
            saveSel();
            const sel = window.getSelection();
            const a =
              sel && sel.anchorNode
                ? closest("A", sel.anchorNode.parentElement)
                : null;
            document.getElementById("linkUrl").value = a
              ? a.getAttribute("href") || ""
              : "";
            document.getElementById("linkNewTab").checked = a
              ? a.getAttribute("target") === "_blank"
              : true;
            show(document.getElementById("linkModal"));
          },
          unlinkSelection: () => {
            const sel = window.getSelection();
            const a =
              sel && sel.anchorNode
                ? closest("A", sel.anchorNode.parentElement)
                : null;
            if (a) {
              unwrapAnchor(a);
              saveToStorage();
            }
            note("تم فك الرابط");
          },
          confirmLink: confirmLinkImpl,

          exportProject,
          importProject,
          previewPortfolio,
          showTab,
          exportPDF,

          openTableModal: () => {
            saveSel();
            show(document.getElementById("tableModal"));
          },
          createTable: () => {
            restoreSel();
            ensureRangeInEditor();
            const r = Math.max(
              1,
              Math.min(
                50,
                parseInt(document.getElementById("tblRows").value || "3", 10)
              )
            );
            const c = Math.max(
              1,
              Math.min(
                20,
                parseInt(document.getElementById("tblCols").value || "3", 10)
              )
            );
            const table = document.createElement("table");
            table.className = "rte-table";
            const tbody = document.createElement("tbody");
            for (let i = 0; i < r; i++) {
              const tr = document.createElement("tr");
              for (let j = 0; j < c; j++) {
                const td = document.createElement("td");
                td.innerHTML = "";
                tr.appendChild(td);
              }
              tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            const sel = window.getSelection();
            const range = sel.getRangeAt(0);
            range.deleteContents();
            range.insertNode(table);
            range.setStart(table.rows[0].cells[0], 0);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
            hide(document.getElementById("tableModal"));
            saveToStorage();
            note("تم إدراج جدول");
          },
        };

        function renderTabs() {
          el.tabsContainer.innerHTML = "";
          state.tabs.forEach((t) => {
            const b = document.createElement("button");
            b.className = "tab " + (t.id === state.activeTabId ? "active" : "");
            b.type = "button";
            b.innerHTML = `<span>${t.title}</span><div class="tab-actions"><button class="tab-btn" onclick="event.stopPropagation(); UI.renameTab('${t.id}')">✎</button><button class="tab-btn" onclick="event.stopPropagation(); UI.duplicateTab('${t.id}')">⧉</button></div>`;
            b.onclick = () => UI.setActiveTab(t.id);
            el.tabsContainer.appendChild(b);
          });
          enableTabReorder();
        }
        function closest(tag, node) {
          while (node && node.nodeType === 1) {
            if (node.tagName === tag) return node;
            node = node.parentElement;
          }
          return null;
        }
        function unwrapAnchor(a) {
          const p = a.parentNode;
          while (a.firstChild) p.insertBefore(a.firstChild, a);
          p.removeChild(a);
        }
        function wrapWithLink(node, url, newTab) {
          const a = document.createElement("a");
          a.href = url;
          if (newTab) {
            a.target = "_blank";
            a.rel = "noopener noreferrer";
          }
          node.parentNode.insertBefore(a, node);
          a.appendChild(node);
        }

        function getFileType(name) {
          const ext = (name.split(".").pop() || "").toLowerCase();
          if (["jpg", "jpeg", "png", "gif", "webp", "bmp"].includes(ext))
            return "image";
          if (["mp4", "webm", "ogg", "mov", "avi"].includes(ext))
            return "video";
          if (ext === "pdf") return "pdf";
          if (["doc", "docx"].includes(ext)) return "word";
          if (["xls", "xlsx"].includes(ext)) return "excel";
          if (["ppt", "pptx"].includes(ext)) return "powerpoint";
          return "other";
        }
        function office(url) {
          return (
            "https://view.officeapps.live.com/op/embed.aspx?src=" +
            encodeURIComponent(url)
          );
        }
        function makeEmbedHTML({
          fType,
          src,
          name,
          caption,
          downloadHref,
          origin,
        }) {
          const eid = id();
          let inner = "";
          if (fType === "image") {
            inner = `<div class="embed-media resizable-x" style="width:100%"><img src="${src}" alt="${esc(
              caption || name || "صورة"
            )}"/></div>`;
          } else if (fType === "video") {
            inner = `<div class="embed-media resizable-both" style="width:100%;height:360px"><video src="${src}" controls></video></div>`;
          } else if (
            fType === "pdf" ||
            ["word", "excel", "powerpoint"].includes(fType)
          ) {
            inner = `<div class="embed-media resizable-both" style="width:100%;height:500px"><iframe src="${src}"></iframe></div>`;
          } else {
            inner = `<div class="embed-media resizable-x" style="width:100%"><p><strong>${esc(
              caption || name || "ملف مرفق"
            )}</strong></p></div>`;
          }
          const d = downloadHref
            ? `<a href="${downloadHref}" download class="download-link">تحميل</a>`
            : "";
          return `<div class="embed-container" contenteditable="false" data-embed-id="${eid}" data-type="${fType}" data-origin="${
            origin || ""
          }" data-name="${esc(name || "")}">
                  <div class="embed-actions">
                    <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'edit')">✎</button>
                    <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'replace')">🔁</button>
                    <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'link')">🔗</button>
                    <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'unlink')">⛓️</button>
                    <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'smaller')">−</button>
                    <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'bigger')">+</button>
                    <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'fit')">100%</button>
                    <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'setwidth')">↔</button>
                    <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'setheight')">↕</button>
                    <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'remove')">🗑</button>
                  </div>
                  ${inner}
                  <div class="embed-caption" contenteditable="true" data-placeholder="أدخل وصفًا...">${esc(
                    caption || ""
                  )}</div>
                  ${d}
                </div>`;
        }
        function upgradeEmbeds(scope) {
          scope.querySelectorAll(".embed-container").forEach((c) => {
            if (!c.querySelector(".embed-actions")) {
              const bar = document.createElement("div");
              bar.className = "embed-actions";
              bar.innerHTML = `<button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'edit')">✎</button>
                      <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'replace')">🔁</button>
                      <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'link')">🔗</button>
                      <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'unlink')">⛓️</button>
                      <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'smaller')">−</button>
                      <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'bigger')">+</button>
                      <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'fit')">100%</button>
                      <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'setwidth')">↔</button>
                      <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'setheight')">↕</button>
                      <button class="embed-btn" onclick="event.preventDefault();event.stopPropagation();UI.embedAction(this,'remove')">🗑</button>`;
              c.insertBefore(bar, c.firstChild);
            }
            if (!c.querySelector(".embed-media")) {
              const m = c.querySelector("img,video,iframe");
              if (m) {
                const wrap = document.createElement("div");
                const isImg = m.tagName === "IMG";
                wrap.className =
                  "embed-media " + (isImg ? "resizable-x" : "resizable-both");
                wrap.style.width = "100%";
                m.style.width = isImg ? "100%" : "100%";
                m.style.height = isImg ? "auto" : "100%";
                m.parentNode.insertBefore(wrap, m);
                wrap.appendChild(m);
              }
            }
            c.setAttribute("contenteditable", "false");
          });
        }

        function insertMediaImpl() {
          const caption = (
            document.getElementById("mediaCaption").value || ""
          ).trim();
          let html = "";
          if (state.mediaType === "upload") {
            const inp = document.getElementById("mediaFile");
            if (!inp.files || !inp.files[0]) return note("اختر ملفًا", "error");
            const f = inp.files[0];
            const t = getFileType(f.name || "");
            const url = URL.createObjectURL(f);
            const useType = ["image", "video", "pdf"].includes(t) ? t : "other";
            html = makeEmbedHTML({
              fType: useType,
              src: url,
              name: f.name,
              caption,
              downloadHref: url,
              origin: "upload",
            });
          } else {
            const url = (
              document.getElementById("mediaUrl").value || ""
            ).trim();
            if (!url) return note("أدخل الرابط", "error");

            let t = document.getElementById("fileType").value;
            if (t === "auto") {
              const fake = url.split("?")[0].split("#")[0];
              t = getFileType(fake);
            }

            let preview = url;
            if (["word", "excel", "powerpoint"].includes(t))
              preview = office(url);

            html = makeEmbedHTML({
              fType: t,
              src: preview,
              name: url.split("/").pop(),
              caption: caption, // أو اتركها caption فقط إن أردت الاختصار
              downloadHref: url, // ← كانت خطأ: downloadHref=url
              origin: "url",
            });
          }

          restoreSel();
          ensureRangeInEditor();
          const sel = window.getSelection();
          if (sel && sel.rangeCount > 0) {
            const r = sel.getRangeAt(0);
            const frag = r.createContextualFragment(html);
            r.deleteContents();
            r.insertNode(frag);
            r.collapse(false);
            sel.removeAllRanges();
            sel.addRange(r);
          } else {
            el.editor.insertAdjacentHTML("beforeend", html);
          }
          hide(document.getElementById("mediaModal"));
          note("تم الإدراج");
          upgradeEmbeds(el.editor);
          saveToStorage();
        }

        function confirmLinkImpl() {
          const raw = document.getElementById("linkUrl").value || "";
          const url = sanitizeUrl(raw);
          if (!url) return note("أدخل رابطًا صحيحًا", "error");
          const newTab = document.getElementById("linkNewTab").checked;
          if (state.linkContext) {
            const media = state.linkContext;
            const existing = closest("A", media.parentElement);
            if (existing) {
              existing.setAttribute("href", url);
              if (newTab) {
                existing.setAttribute("target", "_blank");
                existing.setAttribute("rel", "noopener noreferrer");
              } else {
                existing.removeAttribute("target");
                existing.removeAttribute("rel");
              }
            } else {
              wrapWithLink(media, url, newTab);
            }
            state.linkContext = null;
            UI.hide(document.getElementById("linkModal"));
            saveToStorage();
            return note("تم ربط الوسائط");
          }
          restoreSel();
          const sel = window.getSelection();
          if (sel && !sel.isCollapsed) {
            const r = sel.getRangeAt(0);
            const a = document.createElement("a");
            a.href = url;
            if (newTab) {
              a.target = "_blank";
              a.rel = "noopener noreferrer";
            }
            const contents = r.extractContents();
            a.appendChild(contents);
            r.insertNode(a);
            r.selectNodeContents(a);
            sel.removeAllRanges();
            sel.addRange(r);
            UI.hide(document.getElementById("linkModal"));
            saveToStorage();
            return note("تم إنشاء الرابط");
          }
          note("حدّدي نصًا أو استخدمي زر 🔗 على الوسائط", "error");
        }

        function exportProject() {
          const a = state.tabs.find((x) => x.id === state.activeTabId);
          if (a) a.content = el.editor.innerHTML;
          const data = {
            version: "3.6",
            exportDate: new Date().toISOString(),
            tabs: state.tabs,
            settings: state.settings,
            portfolio: state.portfolio,
          };
          const uri =
            "data:application/json;charset=utf-8," +
            encodeURIComponent(JSON.stringify(data, null, 2));
          const link = document.createElement("a");
          link.href = uri;
          link.download = "ملف_الإنجاز_v3_6.json";
          link.click();
          note("تم التصدير");
        }
        function importProject() {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = ".json";
          input.onchange = (e) => {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = (v) => {
              try {
                const d = JSON.parse(v.target.result);
                if (d.tabs && Array.isArray(d.tabs)) {
                  state.tabs = d.tabs;
                  state.settings = d.settings || state.settings;
                  state.portfolio = d.portfolio || state.portfolio;
                  applySettings();
                  const eb = document.getElementById("editorBgPicker");
                  if (eb) eb.value = state.settings.editorBg || "#ffffff";
                  const pb = document.getElementById("pageBgPicker");
                  if (pb) pb.value = state.settings.pageBg || "#f5f7fb";
                  UI.setActiveTab(state.tabs[0].id);
                  note("تم الاستيراد");
                } else note("ملف غير صالح", "error");
              } catch (err) {
                note("خطأ في قراءة الملف", "error");
              }
            };
            r.readAsText(f);
          };
          input.click();
        }
        function previewPortfolio() {
          const a = state.tabs.find((x) => x.id === state.activeTabId);
          if (a) a.content = el.editor.innerHTML;
          document.getElementById("portfolioHeaderTitle").textContent =
            (state.portfolio && state.portfolio.title) || "ملف الإنجاز";
          UI.refreshPortfolioHeaderFooter();
          UI.buildPortfolioSidebar();
          el.portfolioSidebar.innerHTML = "<h3>فهرس المحتويات</h3>";
          state.tabs.forEach((t, i) => {
            const link = document.createElement("a");
            link.href = "#tab-" + i;
            link.textContent = t.title;
            link.onclick = (e) => {
              e.preventDefault();
              UI.showTab(i);
            };
            el.portfolioSidebar.appendChild(link);
          });
          el.portfolioContent.innerHTML = "";
          state.tabs.forEach((t, i) => {
            const w = document.createElement("div");
            w.className = "tab-content";
            w.id = "tab-" + i;
            const h2 = document.createElement("h2");
            h2.textContent = t.title;
            Object.assign(h2.style, {
              color: "var(--primary)",
              borderBottom: "2px solid var(--primary)",
              paddingBottom: "10px",
              marginBottom: "20px",
            });
            const body = document.createElement("div");
            body.innerHTML = t.content;
            body.querySelectorAll(".embed-actions").forEach((x) => x.remove());
            w.appendChild(h2);
            w.appendChild(body);
            el.portfolioContent.appendChild(w);
          });
          const f = document.createElement("div");
          f.className = "portfolio-footer";
          f.id = "portfolioFooterBlock";
          f.setAttribute("contenteditable", "true");
          f.textContent = (state.portfolio && state.portfolio.footerText) || "";
          f.addEventListener("input", () => {
            state.portfolio.footerText = f.textContent || "";
            saveToStorage();
          });
          el.portfolioContent.appendChild(f);
          el.finalPortfolio.style.display = "block";
          UI.showTab(0);
        }
        // تنقّل بين أقسام المعاينة
        function showTab(idx) {
          // أظهر القسم المطلوب و أخفِ الباقي
          document.querySelectorAll(".tab-content").forEach((sec, i) => {
            sec.classList.toggle("active", i === idx);
            // لمن يعتمد العرض/الإخفاء بـ style
            sec.style.display = i === idx ? "" : "none";
          });

          // فعِّل الرابط الموافق داخل الفهرس
          const sb = document.getElementById("portfolioSidebar");
          if (sb) {
            const links = [...sb.querySelectorAll('a[href^="#tab-"]')];
            links.forEach((a, i) => a.classList.toggle("active", i === idx));
          }

          // ارجع لأعلى المحتوى
          document
            .querySelector(".portfolio-content")
            ?.scrollTo({ top: 0, behavior: "smooth" });
        }

        // ربط نقرات الفهرس بالعرض
        (function bindTOCClicks() {
          const sb = document.getElementById("portfolioSidebar");
          if (!sb) return;
          sb.addEventListener("click", (e) => {
            const a = e.target.closest('a[href^="#tab-"]');
            if (!a) return;
            e.preventDefault();
            const idx =
              parseInt(a.getAttribute("href").split("-").pop(), 10) || 0;
            showTab(idx);
          });
        })();
        function exportPDF() {
          UI.previewPortfolio();
          setTimeout(() => {
            window.print();
          }, 400);
        }

        // ==== (B) تصدير صفحة واحدة (HTML) ====
        UI.exportHTML = async function () {
          try {
            // احفظ محتوى التبويب الحالي
            var active = state.tabs.find(function (x) {
              return x.id === state.activeTabId;
            });
            if (active) active.content = el.editor.innerHTML;

            // مساعد: blob/http -> dataURL
            async function toDataURL(url) {
              try {
                var res = await fetch(url);
                var blob = await res.blob();
                return await new Promise(function (resolve) {
                  var fr = new FileReader();
                  fr.onload = function () {
                    resolve(fr.result);
                  };
                  fr.readAsDataURL(blob);
                });
              } catch (e) {
                return url; // fallback
              }
            }

            // ابنِ الـ DOM النهائي مشابه للمعاينة
            var container = document.createElement("div");

            // رأس
            var header = document.createElement("div");
            header.className = "portfolio-header";
            header.innerHTML =
              '<div class="portfolio-header-inner" dir="rtl">' +
              '<img id="expLogo" class="portfolio-logo" alt="شعار"/>' +
              '<div class="portfolio-titles">' +
              '<h1 id="expTitle"></h1>' +
              '<div id="expSubtitle" class="portfolio-subtitle"></div>' +
              "</div>" +
              '<div class="header-actions">' +
              '<button class="header-btn export" type="button" onclick="window.print()">طباعة</button>' +
              "</div>" +
              "</div>";
            container.appendChild(header);

            var sidebar = document.createElement("div");
            sidebar.className = "portfolio-sidebar";
            var contentRoot = document.createElement("div");
            contentRoot.className = "portfolio-content";

            // الفهرس + الأقسام
            state.tabs.forEach(function (t, i) {
              var link = document.createElement("a");
              link.href = "#tab-" + i;
              link.textContent = t.title;
              sidebar.appendChild(link);

              var w = document.createElement("div");
              w.className = "tab-content";
              w.id = "tab-" + i;

              var h2 = document.createElement("h2");
              h2.textContent = t.title;
              h2.style.color = "var(--primary)";
              h2.style.borderBottom = "2px solid var(--primary)";
              h2.style.paddingBottom = "10px";
              h2.style.marginBottom = "20px";

              var body = document.createElement("div");
              body.innerHTML = t.content || "";
              var bars = body.querySelectorAll(".embed-actions");
              bars.forEach(function (x) {
                x.remove();
              });

              w.appendChild(h2);
              w.appendChild(body);
              contentRoot.appendChild(w);
            });

            // تذييل
            var f = document.createElement("div");
            f.className = "portfolio-footer";
            f.textContent =
              (state.portfolio && state.portfolio.footerText) || "";
            contentRoot.appendChild(f);

            container.appendChild(sidebar);
            container.appendChild(contentRoot);

            // عنوان/اسم/صفة/شعار
            var expTitle = container.querySelector("#expTitle");
            expTitle.textContent =
              (state.portfolio && state.portfolio.title) || "ملف الإنجاز";
            var expSubtitle = container.querySelector("#expSubtitle");
            var nm = (state.portfolio && state.portfolio.teacherName) || "";
            var label =
              (state.portfolio && state.portfolio.teacherLabel) || "المعلم/ـة";
            expSubtitle.textContent = nm ? label + " / " + nm : "";

            var expLogo = container.querySelector("#expLogo");
            var logoSrc = (state.portfolio && state.portfolio.logoData) || "";
            if (!logoSrc) {
              // أول صورة داخل التبويبات
              for (var k = 0; k < state.tabs.length; k++) {
                var tmp = document.createElement("div");
                tmp.innerHTML = state.tabs[k].content || "";
                var im = tmp.querySelector("img[src]");
                if (im) {
                  logoSrc = im.getAttribute("src");
                  break;
                }
              }
            }
            if (logoSrc) expLogo.setAttribute("src", logoSrc);

            // حوّل كل blob → dataURL
            var medias = container.querySelectorAll("img, video, iframe");
            for (var i = 0; i < medias.length; i++) {
              var m = medias[i];
              var src = m.getAttribute("src") || "";
              if (/^blob:/i.test(src)) {
                var data = await toDataURL(src);
                m.setAttribute("src", data);
              }
            }
            // روابط التحميل داخل العناصر المضمّنة
            var dlinks = container.querySelectorAll("a.download-link[href]");
            for (var j = 0; j < dlinks.length; j++) {
              var a = dlinks[j];
              var href = a.getAttribute("href") || "";
              if (/^blob:/i.test(href)) {
                var data2 = await toDataURL(href);
                a.setAttribute("href", data2);
              }
              if (!/^#/.test(a.getAttribute("href") || "")) {
                a.setAttribute("target", "_blank");
                a.setAttribute("rel", "noopener noreferrer");
              }
            }
            // اضبط بقية الروابط الخارجية
            var anchors = container.querySelectorAll("a[href]");
            anchors.forEach(function (a) {
              var href = a.getAttribute("href") || "";
              if (!/^#/.test(href)) {
                a.setAttribute("target", "_blank");
                a.setAttribute("rel", "noopener noreferrer");
              }
            });

            // CSS الحالي (يتضمن قواعد الطباعة)
            var css = Array.prototype.map
              .call(document.querySelectorAll("style"), function (s) {
                return s.innerHTML;
              })
              .join("\n");
            // سكربت صغير لتفعيل تبويب واحد مرئي + تمييز الفهرس
            var navScript = [
              "(function(){",
              " function setActive(id){",
              "  var secs=document.querySelectorAll('.tab-content');",
              "  secs.forEach(function(s){ s.classList.remove('active'); });",
              "  var el=document.getElementById(id); if(el){ el.classList.add('active'); }",
              "  var links=document.querySelectorAll('.portfolio-sidebar a');",
              "  links.forEach(function(a){ var on=(a.getAttribute('href')||'')==='#'+id; a.style.backgroundColor=on?'#4361ee':'transparent'; a.style.color=on?'#fff':'#333'; });",
              " }",
              " document.addEventListener('DOMContentLoaded', function(){",
              "  var links=document.querySelectorAll('.portfolio-sidebar a[href^=\"#tab-\"]');",
              "  links.forEach(function(a){ a.addEventListener('click', function(e){ e.preventDefault(); var id=(this.getAttribute('href')||'').slice(1); setActive(id); }); });",
              "  if(links[0]){ var first=(links[0].getAttribute('href')||'').slice(1); setActive(first); }",
              " });",
              "})();",
            ].join("");

            var html =
              '<!DOCTYPE html><html lang="ar" dir="rtl"><head>' +
              '<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>' +
              "<title>" +
              (state.portfolio && state.portfolio.title
                ? state.portfolio.title
                : "ملف الإنجاز") +
              "</title>" +
              "<style>" +
              css +
              "</style></head><body>" +
              container.innerHTML +
              "<script>" +
              navScript.replace(/<\/script>/gi, "<\\/script>") +
              "<\/script>" +
              "</body></html>";

            var blob = new Blob([html], { type: "text/html;charset=utf-8" });
            var url = URL.createObjectURL(blob);
            var ael = document.createElement("a");
            ael.href = url;
            ael.download = "ملف_الإنجاز_صفحة_واحدة.html";
            ael.click();
            setTimeout(function () {
              URL.revokeObjectURL(url);
            }, 1500);
            UI.note("تم تصدير صفحة واحدة بنجاح");
          } catch (err) {
            UI.note("تعذّر تصدير HTML", "error");
          }
        };

        (function init() {
          applySettings();
          const eb = document.getElementById("editorBgPicker");
          if (eb) eb.value = state.settings.editorBg || "#ffffff";
          const pb = document.getElementById("pageBgPicker");
          if (pb) pb.value = state.settings.pageBg || "#f5f7fb";
          const loadedId = loadFromStorage();
          renderTabs();
          UI.setActiveTab(
            loadedId && state.tabs.find((t) => t.id === loadedId)
              ? loadedId
              : state.tabs[0].id
          );

          ["mouseup", "keyup", "touchend"].forEach((ev) =>
            el.editor.addEventListener(ev, saveSel)
          );

          el.editor.addEventListener(
            "mousedown",
            (e) => {
              if (
                e.target &&
                e.target.closest &&
                e.target.closest(".embed-actions")
              ) {
                e.preventDefault();
              }
            },
            true
          );

          document
            .getElementById("mediaFile")
            .addEventListener("change", (e) => {
              el.filePreview.innerHTML = "";
              el.filePreview.style.display = "block";
              if (!e.target.files || !e.target.files[0]) return;
              el.filePreview.textContent = e.target.files[0].name;
            });

          el.editor.addEventListener("input", () => {
            const a = state.tabs.find((x) => x.id === state.activeTabId);
            if (a) a.content = el.editor.innerHTML;
            saveToStorage();
          });

          /* ===== لصق: ذكي أو نصي ===== */
          el.editor.addEventListener("paste", (e) => {
            e.preventDefault();
            const html =
              (e.clipboardData && e.clipboardData.getData("text/html")) || "";
            const txt =
              (e.clipboardData && e.clipboardData.getData("text/plain")) || "";
            let toInsert = "";
            if (state.pasteMode === "plain") {
              toInsert = esc(txt).replace(/\r?\n/g, "<br>");
            } else {
              if (html) {
                if (
                  /<table[\s\S]*?>/i.test(html) ||
                  /class="?Mso|mso-/i.test(html)
                ) {
                  toInsert = sanitizeTablesHTML(html);
                } else {
                  toInsert = sanitizeHTMLBasic(html);
                }
              } else {
                toInsert = esc(txt).replace(/\r?\n/g, "<br>");
              }
            }
            ensureRangeInEditor();
            const sel = window.getSelection();
            if (sel && sel.rangeCount > 0) {
              const r = sel.getRangeAt(0);
              const frag = r.createContextualFragment(toInsert);
              r.deleteContents();
              r.insertNode(frag);
              r.collapse(false);
              sel.removeAllRanges();
              sel.addRange(r);
            }
            upgradeEmbeds(el.editor);
            saveToStorage();
            note(
              state.pasteMode === "smart" ? "تم اللصق (ذكي)" : "تم اللصق (نصي)"
            );
          });

          /* سحب وإفلات للوسائط */
          el.editor.addEventListener("dragover", (e) => e.preventDefault());
          el.editor.addEventListener("drop", (e) => {
            e.preventDefault();
            const dt = e.dataTransfer;
            if (!dt || !dt.files || !dt.files.length) return;
            const files = [...dt.files];
            ensureRangeInEditor();
            const sel = window.getSelection();
            const r = sel && sel.rangeCount > 0 ? sel.getRangeAt(0) : null;
            files.forEach((f) => {
              const t = getFileType(f.name || "");
              const url = URL.createObjectURL(f);
              const useType = ["image", "video", "pdf"].includes(t)
                ? t
                : "other";
              const html = makeEmbedHTML({
                fType: useType,
                src: url,
                name: f.name,
                caption: "",
                downloadHref: url,
                origin: "upload",
              });
              if (r) {
                const frag = r.createContextualFragment(html);
                r.insertNode(frag);
                r.collapse(false);
                sel.removeAllRanges();
                sel.addRange(r);
              } else {
                el.editor.insertAdjacentHTML("beforeend", html);
              }
            });
            upgradeEmbeds(el.editor);
            saveToStorage();
          });

          /* ===== أحداث الجداول ===== */
          document.addEventListener("selectionchange", () => {
            const td = getCellFromSelection();
            if (td) showTableBubbleFor(td);
            else hideTableBubble();
          });
          el.editor.addEventListener("scroll", () => {
            if (state.currentCell) showTableBubbleFor(state.currentCell);
          });

          el.tableBubble.addEventListener("mousedown", (e) =>
            e.preventDefault()
          );
          el.tableBubble.addEventListener("click", (e) => {
            const btn = e.target.closest(".tb-btn");
            if (!btn) return;
            const act = btn.getAttribute("data-act");
            const td = state.currentCell;
            const info = tableInfo(td);
            if (!info) return;
            const { table, rows, rIndex, cIndex } = info;

            if (act === "row-before") {
              const tr = document.createElement("tr");
              for (let i = 0; i < table.rows[0].cells.length; i++) {
                const cell = document.createElement("td");
                tr.appendChild(cell);
              }
              table.tBodies[0].insertBefore(tr, table.rows[rIndex]);
            } else if (act === "row-after") {
              const tr = document.createElement("tr");
              for (let i = 0; i < table.rows[0].cells.length; i++) {
                const cell = document.createElement("td");
                tr.appendChild(cell);
              }
              const next = table.rows[rIndex].nextSibling;
              table.tBodies[0].insertBefore(tr, next);
            } else if (act === "col-before" || act === "col-after") {
              const addAfter = act === "col-after";
              rows.forEach((row) => {
                const ref = row.cells[cIndex];
                const cell = document.createElement(
                  row.rowIndex === 0 && table.tHead ? "th" : "td"
                );
                if (addAfter) {
                  ref.after(cell);
                } else {
                  row.insertBefore(cell, ref);
                }
              });
            } else if (act === "toggle-header") {
              const first = rows[0];
              if (first && first.cells.length) {
                const isHeader = first.cells[0].tagName === "TH";
                [...first.cells].forEach((cell) => {
                  const repl = document.createElement(isHeader ? "td" : "th");
                  repl.innerHTML = cell.innerHTML;
                  cell.parentNode.replaceChild(repl, cell);
                });
              }
            } else if (act === "cell-bg") {
              const color = el.cellBgPicker ? el.cellBgPicker.value : "#ffff99";
              td.style.backgroundColor = color;
            } else if (act === "cell-bg-clear") {
              td.style.removeProperty("background-color");
            } else if (act === "del-row") {
              table.deleteRow(rIndex);
            } else if (act === "del-col") {
              rows.forEach((row) => {
                if (row.cells[cIndex]) row.deleteCell(cIndex);
              });
            } else if (act === "del-table") {
              table.remove();
              hideTableBubble();
            }
            if (table.parentNode) {
              if (table.rows.length === 0 || table.rows[0].cells.length === 0) {
                table.remove();
                hideTableBubble();
              }
            }
            saveToStorage();
          });

          if (el.cellBgPicker) {
            el.cellBgPicker.addEventListener("input", () => {
              if (state.currentCell) {
                state.currentCell.style.backgroundColor = el.cellBgPicker.value;
                saveToStorage();
              }
            });
          }
        })();

        UI.closePreview = function () {
          try {
            document.getElementById("finalPortfolio").style.display = "none";
          } catch (_) {}
        };
        UI.refreshPortfolioHeaderFooter = function () {
          try {
            var subtitleEl = document.getElementById("portfolioHeaderSubtitle");
            if (subtitleEl) {
              var nm = (state.portfolio && state.portfolio.teacherName) || "";
              var label =
                (state.portfolio && state.portfolio.teacherLabel) ||
                "المعلم/ـة";
              subtitleEl.textContent = nm ? label + " / " + nm : "";
            }
            var logoEl = document.getElementById("portfolioHeaderLogo");
            if (logoEl) {
              if (state.portfolio && state.portfolio.logoData) {
                logoEl.src = state.portfolio.logoData;
                logoEl.style.display = "block";
              } else {
                var found = "";
                for (var i = 0; i < state.tabs.length; i++) {
                  var t = state.tabs[i];
                  var tmp = document.createElement("div");
                  tmp.innerHTML = (t && t.content) || "";
                  var im = tmp.querySelector("img");
                  if (im && im.getAttribute("src")) {
                    found = im.getAttribute("src");
                    break;
                  }
                }
                if (found) {
                  logoEl.src = found;
                  logoEl.style.display = "block";
                } else {
                  logoEl.style.display = "none";
                }
              }
            }
            var titleEl = document.getElementById("portfolioHeaderTitle");
            if (titleEl) {
              titleEl.textContent =
                (state.portfolio && state.portfolio.title) || "ملف الإنجاز";
            }
            var fb = document.getElementById("portfolioFooterBlock");
            if (fb) {
              fb.textContent =
                (state.portfolio && state.portfolio.footerText) || "";
            }
          } catch (_) {}
        };
        UI.buildPortfolioSidebar = function () {
          try {
            el.portfolioSidebar.innerHTML = "";
            var box = document.createElement("div");
            box.innerHTML =
              "<h3 style='margin-bottom:8px'>إعدادات الغلاف</h3>" +
              "<label style='display:block;margin-bottom:4px'>الصفة</label>" +
              "<select id='pfLabel' class='form-control' style='margin-bottom:6px'><option>المعلم/ـة</option><option>المعلم</option><option>المعلمة</option></select>" +
              "<label style='display:block;margin-bottom:4px'>الاسم</label>" +
              "<input id='pfName' class='form-control' placeholder='مثال: أحمد محمد' style='margin-bottom:6px'/>" +
              "<label style='display:block;margin-bottom:4px'>الشعار (رفع)</label>" +
              "<input id='pfLogoFile' type='file' accept='.png,.jpg,.jpeg,.webp,.gif' class='form-control' style='margin-bottom:6px'/>" +
              "<div style='margin-bottom:6px'><input id='pfLogoUrl' class='form-control' placeholder='رابط الشعار (اختياري)'/></div>" +
              "<div style='display:flex;flex-direction:column;gap:6px;margin-bottom:6px'><button id='pfLogoClear' class='btn btn-secondary' type='button'>حذف الشعار</button><a id='pfLogoDownload' class='btn btn-secondary' href='#' download='logo.png' style='text-decoration:none;display:none;text-align:center'>تحميل الشعار</a></div>" +
              "<label style='display:block;margin-bottom:4px'>تذييل الصفحة</label>" +
              "<textarea id='pfFooter' class='form-control' rows='3' placeholder='نص يظهر أسفل الصفحة'></textarea>" +
              "<h3 style='margin-top:12px'>فهرس المحتويات</h3>";
            el.portfolioSidebar.appendChild(box);
            var h3s = box.querySelectorAll("h3");
            var anchor = h3s[h3s.length - 1] || null;
            var tl = document.createElement("label");
            tl.style.display = "block";
            tl.style.marginBottom = "4px";
            tl.textContent = "عنوان الملف";
            var ti = document.createElement("input");
            ti.id = "pfTitle";
            ti.className = "form-control";
            ti.placeholder = "مثال: ملف الإنجاز";
            ti.style.marginBottom = "6px";
            ti.value = (state.portfolio && state.portfolio.title) || "";
            ti.addEventListener("input", function () {
              state.portfolio = state.portfolio || {};
              state.portfolio.title = this.value || "";
              UI.refreshPortfolioHeaderFooter();
              saveToStorage();
            });
            if (anchor) {
              box.insertBefore(tl, anchor);
              box.insertBefore(ti, anchor);
            } else {
              box.appendChild(tl);
              box.appendChild(ti);
            }
            var n = document.getElementById("pfName");
            if (n)
              n.value = (state.portfolio && state.portfolio.teacherName) || "";
            var l = document.getElementById("pfLabel");
            if (l)
              l.value =
                (state.portfolio && state.portfolio.teacherLabel) ||
                "المعلم/ـة";
            var ft = document.getElementById("pfFooter");
            if (ft)
              ft.value = (state.portfolio && state.portfolio.footerText) || "";
            var dl = document.getElementById("pfLogoDownload");
            if (dl) {
              if (state.portfolio && state.portfolio.logoData) {
                dl.href = state.portfolio.logoData;
                dl.style.display = "inline-block";
              }
            }
            if (n)
              n.addEventListener(
                "input",
                UI.updatePortfolioSettingsFromSidebar
              );
            if (l)
              l.addEventListener(
                "change",
                UI.updatePortfolioSettingsFromSidebar
              );
            if (ft)
              ft.addEventListener(
                "input",
                UI.updatePortfolioSettingsFromSidebar
              );
            var f = document.getElementById("pfLogoFile");
            if (f) f.addEventListener("change", UI.setLogoFile);
            var urlIn = document.getElementById("pfLogoUrl");
            if (urlIn) {
              var applyLogoUrl = function () {
                var v = (urlIn.value || "").trim();
                if (!v) return;
                state.portfolio = state.portfolio || {};
                state.portfolio.logoData = v;
                UI.refreshPortfolioHeaderFooter();
                var d = document.getElementById("pfLogoDownload");
                if (d) {
                  d.href = state.portfolio.logoData;
                  d.style.display = "inline-flex";
                }
                saveToStorage();
              };
              urlIn.addEventListener("change", applyLogoUrl);
              urlIn.addEventListener("blur", applyLogoUrl);
              urlIn.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                  e.preventDefault();
                  applyLogoUrl();
                }
              });
              urlIn.addEventListener("paste", function () {
                setTimeout(applyLogoUrl, 0);
              });
            }
            var cb = document.getElementById("pfLogoClear");
            if (cb) cb.addEventListener("click", UI.clearLogo);
          } catch (_) {}
        };

        // ==== (A) معاينة الإنجاز بلوحة إدخال الغلاف =====
        UI.previewPortfolio = function () {
          try {
            // خزّن تبويبك الحالي
            var active = state.tabs.find(function (x) {
              return x.id === state.activeTabId;
            });
            if (active) active.content = el.editor.innerHTML;

            // نظّف منطقة المعاينة
            el.portfolioSidebar.innerHTML = "";
            el.portfolioContent.innerHTML = "";

            // عنوان الرأس
            var title =
              (state.portfolio && state.portfolio.title) || "ملف الإنجاز";
            document.getElementById("portfolioHeaderTitle").textContent = title;

            // حدّث الشعار والاسم/الصفة
            UI.refreshPortfolioHeaderFooter();

            // ابنِ لوحة إعدادات الغلاف + فهرس المحتويات
            UI.buildPortfolioSidebar();

            // أنشئ الأقسام
            state.tabs.forEach(function (t, i) {
              // رابط في الفهرس
              var link = document.createElement("a");
              link.href = "#tab-" + i;
              link.textContent = t.title;
              el.portfolioSidebar.appendChild(link);

              // حاوية القسم
              var wrap = document.createElement("div");
              wrap.className = "tab-content";
              wrap.id = "tab-" + i;

              var h2 = document.createElement("h2");
              h2.textContent = t.title;
              h2.style.color = "var(--primary)";
              h2.style.borderBottom = "2px solid var(--primary)";
              h2.style.paddingBottom = "10px";
              h2.style.marginBottom = "20px";

              var body = document.createElement("div");
              body.innerHTML = t.content || "";
              var bars = body.querySelectorAll(".embed-actions");
              bars.forEach(function (x) {
                x.remove();
              });

              wrap.appendChild(h2);
              wrap.appendChild(body);
              el.portfolioContent.appendChild(wrap);
            });

            // تذييل قابل للتحرير في المعاينة
            var f = document.createElement("div");
            f.className = "portfolio-footer";
            f.id = "portfolioFooterBlock";
            f.contentEditable = "true";
            f.textContent =
              (state.portfolio && state.portfolio.footerText) || "";
            f.addEventListener("input", function () {
              state.portfolio.footerText = f.textContent || "";
              try {
                localStorage.setItem(
                  "portfolio_v34",
                  JSON.stringify({
                    version: "3.4",
                    tabs: state.tabs,
                    settings: state.settings,
                    portfolio: state.portfolio,
                    activeTabId: state.activeTabId,
                  })
                );
              } catch (_) {}
            });
            el.portfolioContent.appendChild(f);

            // أظهر المعاينة
            el.finalPortfolio.style.display = "block";

            // فعّل أول تبويب
            UI.showTab(0);
          } catch (err) {
            UI.note("تعذّرت المعاينة", "error");
          }
        };

        // ==== (C) تصدير ZIP (index.html + assets/) ====
        UI.exportZIP = async function () {
          try {
            // احفظ تبويبك
            var active = state.tabs.find(function (x) {
              return x.id === state.activeTabId;
            });
            if (active) active.content = el.editor.innerHTML;

            // تحميل JSZip إن لم يكن موجوداً
            async function ensureJSZip() {
              if (window.JSZip) return window.JSZip;
              await new Promise(function (resolve, reject) {
                var s = document.createElement("script");
                s.src =
                  "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js";
                s.onload = resolve;
                s.onerror = reject;
                document.head.appendChild(s);
              });
              return window.JSZip;
            }
            var JSZipLib = await ensureJSZip();

            // أدوات اسم الملف
            function sanitizeFilename(name) {
              name = (name || "")
                .replace(/[\\\/:*?"<>|]+/g, "_")
                .replace(/\s+/g, " ")
                .trim();
              return name || "file";
            }
            function extFromType(type) {
              var map = {
                "image/png": "png",
                "image/jpeg": "jpg",
                "image/webp": "webp",
                "image/gif": "gif",
                "image/svg+xml": "svg",
                "application/pdf": "pdf",
                "video/mp4": "mp4",
                "video/webm": "webm",
                "audio/mpeg": "mp3",
              };
              return map[type] || "";
            }
            function extFromUrl(url) {
              try {
                var u = (url || "").split("?")[0];
                var m = /\.([a-z0-9]+)$/i.exec(u);
                return m ? m[1].toLowerCase() : "";
              } catch (_) {
                return "";
              }
            }
            function nameFromUrl(url) {
              try {
                var u = (url || "").split("?")[0];
                var p = u.split("/");
                return sanitizeFilename(
                  decodeURIComponent(p[p.length - 1] || "file")
                );
              } catch (_) {
                return "file";
              }
            }
            function dataUrlToBlob(dataUrl) {
              var arr = (dataUrl || "").split(",");
              var m = arr[0].match(/:(.*?);/);
              var mime = m ? m[1] : "application/octet-stream";
              var bstr = atob(arr[1] || "");
              var u8 = new Uint8Array(bstr.length);
              for (var i = 0; i < bstr.length; i++) u8[i] = bstr.charCodeAt(i);
              return new Blob([u8], { type: mime });
            }
            async function blobFromUrl(url) {
              var res = await fetch(url);
              if (!res.ok) throw new Error("fetch failed");
              return await res.blob();
            }

            // ابنِ الـ DOM النهائي
            var container = document.createElement("div");
            var header = document.createElement("div");
            header.className = "portfolio-header";
            header.innerHTML =
              '<div class="portfolio-header-inner" dir="rtl">' +
              '<img id="expLogo" class="portfolio-logo" alt="الشعار"/>' +
              '<div class="portfolio-titles"><h1 id="expTitle"></h1><div id="expSubtitle" class="portfolio-subtitle"></div></div>' +
              "</div>";
            container.appendChild(header);

            var sidebar = document.createElement("div");
            sidebar.className = "portfolio-sidebar";
            sidebar.id = "expSidebar";
            var contentRoot = document.createElement("div");
            contentRoot.className = "portfolio-content";
            contentRoot.id = "expContent";

            state.tabs.forEach(function (t, i) {
              var link = document.createElement("a");
              link.href = "#tab-" + i;
              link.textContent = t.title;
              sidebar.appendChild(link);

              var w = document.createElement("div");
              w.className = "tab-content";
              w.id = "tab-" + i;

              var h2 = document.createElement("h2");
              h2.textContent = t.title;
              h2.style.color = "var(--primary)";
              h2.style.borderBottom = "2px solid var(--primary)";
              h2.style.paddingBottom = "10px";
              h2.style.marginBottom = "20px";

              var body = document.createElement("div");
              body.innerHTML = t.content || "";
              var bars = body.querySelectorAll(".embed-actions");
              bars.forEach(function (x) {
                x.remove();
              });

              w.appendChild(h2);
              w.appendChild(body);
              contentRoot.appendChild(w);
            });

            var f = document.createElement("div");
            f.className = "portfolio-footer";
            f.id = "portfolioFooterBlock";
            f.textContent =
              (state.portfolio && state.portfolio.footerText) || "";
            contentRoot.appendChild(f);

            container.appendChild(sidebar);
            container.appendChild(contentRoot);

            // العنوان/الصفة/الاسم/الشعار
            var expTitle = container.querySelector("#expTitle");
            expTitle.textContent =
              (state.portfolio && state.portfolio.title) || "ملف الإنجاز";
            var expSubtitle = container.querySelector("#expSubtitle");
            var nm = (state.portfolio && state.portfolio.teacherName) || "";
            var label =
              (state.portfolio && state.portfolio.teacherLabel) || "المعلم/ـة";
            expSubtitle.textContent = nm ? label + " / " + nm : "";

            var expLogo = container.querySelector("#expLogo");
            var logoSrc = (state.portfolio && state.portfolio.logoData) || "";
            if (!logoSrc) {
              for (var k = 0; k < state.tabs.length; k++) {
                var tmp = document.createElement("div");
                tmp.innerHTML = state.tabs[k].content || "";
                var im = tmp.querySelector("img[src]");
                if (im) {
                  logoSrc = im.getAttribute("src");
                  break;
                }
              }
            }
            if (logoSrc) expLogo.setAttribute("src", logoSrc);

            // اجمع الأصول واكتبها في assets/
            var usedNames = {};
            function uniqueName(base) {
              base = sanitizeFilename(base || "file");
              var name = base,
                i = 2;
              while (usedNames[name]) {
                var dot = base.lastIndexOf(".");
                name =
                  dot > 0
                    ? base.slice(0, dot) + "-" + i + base.slice(dot)
                    : base + "-" + i;
                i++;
              }
              usedNames[name] = true;
              return name;
            }
            var assets = []; // {name, blob}
            async function addAssetFrom(url, preferName, element, attr) {
              try {
                if (!url) return null;
                var blob = null;
                if (/^data:/i.test(url)) blob = dataUrlToBlob(url);
                else if (/^blob:/i.test(url)) {
                  try {
                    blob = await blobFromUrl(url);
                  } catch (_) {
                    blob = null;
                  }
                } else if (/^https?:/i.test(url)) {
                  try {
                    blob = await blobFromUrl(url);
                  } catch (_) {
                    blob = null;
                  } // قد تفشل CORS، لا بأس
                } else {
                  return null;
                }
                if (!blob) return null;
                var baseName = sanitizeFilename(preferName || nameFromUrl(url));
                if (!/\.[a-z0-9]+$/i.test(baseName)) {
                  var ext = extFromType(blob.type) || extFromUrl(url) || "bin";
                  baseName = baseName + "." + ext;
                }
                var finalName = uniqueName(baseName);
                assets.push({ name: finalName, blob: blob });
                if (element && attr)
                  element.setAttribute(attr, "assets/" + finalName);
                return finalName;
              } catch (_) {
                return null;
              }
            }

            // الشعار
            if (expLogo) {
              var ls = expLogo.getAttribute("src") || "";
              if (ls) {
                await addAssetFrom(ls, "logo", expLogo, "src");
              }
            }

            // الوسائط
            var mediaNodes = container.querySelectorAll(
              ".embed-container .embed-media img, .embed-container .embed-media video, .embed-container .embed-media iframe"
            );
            for (var i = 0; i < mediaNodes.length; i++) {
              var m = mediaNodes[i];
              var src = m.getAttribute("src") || "";
              var prefer =
                (m.closest(".embed-container") &&
                  m.closest(".embed-container").getAttribute("data-name")) ||
                "";
              await addAssetFrom(src, prefer, m, "src");
            }
            // روابط التحميل المضمّنة
            var dlinks = container.querySelectorAll(
              ".embed-container a.download-link[href]"
            );
            for (var j = 0; j < dlinks.length; j++) {
              var a = dlinks[j];
              var href = a.getAttribute("href") || "";
              var prefer =
                a.getAttribute("download") ||
                (a.closest(".embed-container")
                  ? a.closest(".embed-container").getAttribute("data-name")
                  : "");
              var nm2 = await addAssetFrom(href, prefer, a, "href");
              if (nm2) {
                a.removeAttribute("download");
                a.setAttribute("target", "_blank");
                a.setAttribute("rel", "noopener noreferrer");
              }
            }
            // بقية الروابط
            var anchors = container.querySelectorAll("a[href]");
            anchors.forEach(function (a) {
              var href = a.getAttribute("href") || "";
              if (!/^#/.test(href)) {
                a.setAttribute("target", "_blank");
                a.setAttribute("rel", "noopener noreferrer");
              }
            });

            // CSS + سكربت التنقّل
            var css = Array.prototype.map
              .call(document.querySelectorAll("style"), function (s) {
                return s.innerHTML;
              })
              .join("\n");
            var navScript = [
              "(function(){",
              " function setActive(id){",
              "  var secs=document.querySelectorAll('.tab-content');",
              "  secs.forEach(function(s){ s.classList.remove('active'); });",
              "  var el=document.getElementById(id); if(el){ el.classList.add('active'); }",
              "  var links=document.querySelectorAll('.portfolio-sidebar a');",
              "  links.forEach(function(a){ var on=(a.getAttribute('href')||'')==='#'+id; a.style.backgroundColor=on?'#4361ee':'transparent'; a.style.color=on?'#fff':'#333'; });",
              " }",
              " document.addEventListener('DOMContentLoaded', function(){",
              "  var links=document.querySelectorAll('.portfolio-sidebar a[href^=\"#tab-\"]');",
              "  links.forEach(function(a){ a.addEventListener('click', function(e){ e.preventDefault(); var id=(this.getAttribute('href')||'').slice(1); setActive(id); }); });",
              "  if(links[0]){ var first=(links[0].getAttribute('href')||'').slice(1); setActive(first); }",
              " });",
              "})();",
            ].join("");

            var html =
              '<!DOCTYPE html><html lang="ar" dir="rtl"><head>' +
              '<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>' +
              "<title>" +
              (state.portfolio && state.portfolio.title
                ? state.portfolio.title
                : "ملف الإنجاز") +
              "</title>" +
              "<style>" +
              css +
              "</style></head><body>" +
              container.innerHTML +
              "<script>" +
              navScript.replace(/<\/script>/gi, "<\\/script>") +
              "<\/script>" +
              "</body></html>";

            // أنشئ الأرشيف
            var zip = new JSZipLib();
            zip.file("index.html", html);
            var af = zip.folder("assets");
            for (var z = 0; z < assets.length; z++) {
              var it = assets[z];
              var ab = await it.blob.arrayBuffer();
              af.file(it.name, ab);
            }
            var zblob = await zip.generateAsync({ type: "blob" });
            var url = URL.createObjectURL(zblob);
            var ael = document.createElement("a");
            var fname =
              (state.portfolio && state.portfolio.title
                ? state.portfolio.title
                : "portfolio") + "_package.zip";
            ael.href = url;
            ael.download = fname;
            ael.click();
            setTimeout(function () {
              URL.revokeObjectURL(url);
            }, 1500);
            UI.note("تم إنشاء ملف ZIP بنجاح وتم تنزيله");
          } catch (err) {
            UI.note("تعذّر إنشاء ملف ZIP", "error");
          }
        };

        function enableTabReorder() {
          const wrap = document.getElementById("tabsContainer");
          if (!wrap) return;
          const items = [...wrap.children]; // يفترض أن كل طفل يمثل تبويبًا
          let src = -1;

          items.forEach((item, idx) => {
            item.setAttribute("draggable", "true");

            item.addEventListener("dragstart", (e) => {
              src = idx;
              item.classList.add("dragging");
              // تحسين: شفافية أثناء السحب
              e.dataTransfer.effectAllowed = "move";
              try {
                e.dataTransfer.setData("text/plain", String(idx));
              } catch (_) {}
            });

            item.addEventListener("dragover", (e) => {
              e.preventDefault(); // يسمح بالإسقاط
            });

            item.addEventListener("drop", (e) => {
              e.preventDefault();
              const dest = [...wrap.children].indexOf(item);
              if (src === -1 || dest === -1 || dest === src) return;

              // حرّك العنصر في state.tabs
              const moved = state.tabs.splice(src, 1)[0];
              state.tabs.splice(dest, 0, moved);

              // أعِد الرسم واحفظ وفعِّل التبويب المنقول
              renderTabs();
              saveToStorage();
              UI.setActiveTab(state.tabs[dest].id);
            });

            item.addEventListener("dragend", () => {
              item.classList.remove("dragging");
            });
          });
        }

        UI.updatePortfolioSettingsFromSidebar = function () {
          try {
            var nameEl = document.getElementById("pfName");
            var labelEl = document.getElementById("pfLabel");
            var footerEl = document.getElementById("pfFooter");
            if (!state.portfolio)
              state.portfolio = {
                teacherName: "",
                teacherLabel: "المعلم/ـة",
                footerText: "",
                logoData: "",
              };
            if (nameEl) state.portfolio.teacherName = nameEl.value || "";
            if (labelEl)
              state.portfolio.teacherLabel = labelEl.value || "المعلم/ـة";
            if (footerEl) state.portfolio.footerText = footerEl.value || "";
            UI.refreshPortfolioHeaderFooter();
            saveToStorage();
          } catch (_) {}
        };
        UI.setLogoFile = function () {
          try {
            var inp = document.getElementById("pfLogoFile");
            if (!inp || !inp.files || !inp.files[0]) return;
            var f = inp.files[0];
            var rd = new FileReader();
            rd.onload = function (e) {
              state.portfolio = state.portfolio || {};
              state.portfolio.logoData = e.target.result;
              UI.refreshPortfolioHeaderFooter();
              var d = document.getElementById("pfLogoDownload");
              if (d) {
                d.href = state.portfolio.logoData;
                d.style.display = "inline-flex";
              }
              saveToStorage();
            };
            rd.readAsDataURL(f);
          } catch (_) {}
        };
        UI.setLogoUrl = function () {
          try {
            var urlIn = document.getElementById("pfLogoUrl");
            if (!urlIn) return;
            var v = (urlIn.value || "").trim();
            if (!v) return;
            state.portfolio = state.portfolio || {};
            state.portfolio.logoData = v;
            UI.refreshPortfolioHeaderFooter();
            var d = document.getElementById("pfLogoDownload");
            if (d) {
              d.href = state.portfolio.logoData;
              d.style.display = "inline-flex";
            }
            saveToStorage();
          } catch (_) {}
        };
        UI.clearLogo = function () {
          try {
            if (state.portfolio) {
              state.portfolio.logoData = "";
            }
            UI.refreshPortfolioHeaderFooter();
            var d = document.getElementById("pfLogoDownload");
            if (d) {
              d.style.display = "none";
            }
            saveToStorage();
          } catch (_) {}
        };

        // مكان للعمليات الإضافية (embedAction/… إن احتجتها لاحقًا)
        UI.embedAction = function (btn, action) {
          /* اختياري: نفس التنفيذ السابق إن رغبت */
        };
      })();
    </script>
  </body>
</html>
