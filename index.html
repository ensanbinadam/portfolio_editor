<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>محرر ملف الإنجاز | portfolio_editor</title>
    <style>
      :root {
        --primary: #4361ee;
        --secondary: #3f37c9;
        --success: #4cc9f0;
        --dark: #1e1e2c;
        --light: #f8f9fa;
        --gray: #6c757d;
        --danger: #e5383b;
        --warning: #fca311;
        --sidebar-width: 280px;
        --editor-font-size: 16px;
        --page-print-bg: #f5f7fb;
        --editor-print-bg: #ffffff;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", "Cairo", Tahoma, Geneva, Verdana, sans-serif;
      }
      body {
        background: #f5f7fb;
        color: #333;
        line-height: 1.6;
      }
      .container {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(135deg, var(--dark), var(--secondary));
        color: #fff;
        padding: 20px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      .app-title {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }
      .app-title h1 {
        font-size: 1.5rem;
        margin-bottom: 5px;
      }
      .app-title p {
        font-size: 0.9rem;
        opacity: 0.8;
      }
      .tabs-container {
        margin-bottom: 20px;
      }
      .tab {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 8px;
        color: #fff;
        padding: 12px 15px;
        margin-bottom: 10px;
        cursor: pointer;
        width: 100%;
        text-align: right;
        transition: all 0.25s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .tab:hover {
        filter: brightness(1.06);
      }
      .tab.active {
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
        outline: 2px solid rgba(255, 255, 255, 0.7);
        outline-offset: -2px;
        transform: translateY(-1px);
      }
      .tab-title-wrapper {
        display: flex;
        align-items: center;
        gap: 5px;
        overflow: hidden;
        pointer-events: none; /* لتمرير الأحداث للزر الأب */
      }
      .tab-toggle {
        cursor: pointer;
        user-select: none;
        width: 16px;
        text-align: center;
        flex-shrink: 0;
        pointer-events: all; /* لجعله قابل للنقر */
        font-size: 12px;
      }
      .tabs-container .tab:nth-child(6n + 1) {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      }
      .tabs-container .tab:nth-child(6n + 2) {
        background: linear-gradient(135deg, #10b981, #047857);
      }
      .tabs-container .tab:nth-child(6n + 3) {
        background: linear-gradient(135deg, #f59e0b, #b45309);
      }
      .tabs-container .tab:nth-child(6n + 4) {
        background: linear-gradient(135deg, #ef4444, #b91c1c);
      }
      .tabs-container .tab:nth-child(6n + 5) {
        background: linear-gradient(135deg, #06b6d4, #0e7490);
      }
      .tabs-container .tab:nth-child(6n) {
        background: linear-gradient(135deg, #a855f7, #6b21a8);
      }
      .tab-actions {
        display: flex;
        gap: 5px;
      }
      .tab-btn {
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 14px;
        opacity: 0.7;
        transition: opacity 0.3s;
      }
      .tab-btn:hover {
        opacity: 1;
      }
      .sidebar-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
      }
      .sidebar-btn {
        background: rgba(255, 255, 255, 0.15);
        border: none;
        border-radius: 8px;
        color: #fff;
        padding: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
      }
      .sidebar-btn:hover {
        background: rgba(255, 255, 255, 0.25);
      }
      .sidebar-btn.delete {
        background: rgba(229, 56, 59, 0.2);
      }
      .sidebar-btn.delete:hover {
        background: rgba(229, 56, 59, 0.3);
      }
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .toolbar {
        background: #fff;
        padding: 15px 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .toolbar-group {
        display: flex;
        gap: 6px;
        padding: 5px;
        border-radius: 6px;
        background: #f0f2f5;
        align-items: center;
      }
      .toolbar-btn {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      .toolbar-btn:hover {
        background: #f0f2f5;
        border-color: #ccc;
      }
      .toolbar-btn.active {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }
      .toolbar-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #fff;
        cursor: pointer;
      }
      .color-input {
        width: 34px;
        height: 34px;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 0;
        background: #fff;
        cursor: pointer;
      }
      .color-label {
        font-size: 18px;
        line-height: 1;
      }
      .editor {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        background: #fff;
        margin: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      .editor-content {
        min-height: 500px;
        padding: 20px;
        border: 1px solid #eaeaea;
        border-radius: 8px;
        outline: none;
        font-size: var(--editor-font-size);
      }
      .editor-content h1 {
        font-size: 2em;
        margin: 0.6em 0 0.4em;
      }
      .editor-content h2 {
        font-size: 1.6em;
        margin: 0.6em 0 0.4em;
      }
      .editor-content h3 {
        font-size: 1.3em;
        margin: 0.6em 0 0.4em;
      }
      .action-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
        padding: 20px;
        background: #fff;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }
      .action-btn {
        padding: 12px 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .action-btn.export {
        background: var(--primary);
        color: #fff;
      }
      .action-btn.import {
        background: #fff;
        color: var(--primary);
        border: 2px solid var(--primary);
      }
      .action-btn.generate {
        background: var(--success);
        color: #fff;
      }
      .action-btn.pdf {
        background: #111827;
        color: #fff;
      }
      .action-btn:hover {
        filter: brightness(0.95);
      }
      #jsError {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: #e5383b;
        color: #fff;
        padding: 10px 14px;
        border-radius: 8px;
        z-index: 1300;
        display: none;
      }

      /* ===== Embeds ===== */
      .embed-container {
        margin: 15px 0;
        border: 1px dashed #ddd;
        border-radius: 8px;
        padding: 10px;
        position: relative;
        background: #fff;
      }
      .embed-container:focus-within {
        outline: 2px dashed var(--secondary);
        outline-offset: 6px;
      }
      .embed-container {
        position: relative;
      }

      .embed-actions {
        position: absolute;
        top: -15px;
        left: 10px;
        background: #fff;
        padding: 5px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: none;
        gap: 6px;
        z-index: 9999; /* كان 5: نرفعه فوق الفيديو/iframe */
        pointer-events: auto; /* تأكيد قابلية النقر */
      }
      .embed-container:hover .embed-actions,
      .embed-container:focus-within .embed-actions {
        display: flex;
      }

      .embed-container:hover .embed-actions {
        display: flex;
      }
      .embed-btn {
        background: #f0f2f5;
        border: none;
        border-radius: 4px;
        padding: 5px 8px;
        cursor: pointer;
        margin: 0 2px;
        font-size: 12px;
      }
      .embed-caption {
        margin-top: 8px;
        font-size: 0.92rem;
        color: #444;
        background: #fafafa;
        border: 1px dashed #ddd;
        border-radius: 6px;
        padding: 6px 8px;
      }
      .embed-caption:empty:before {
        content: attr(data-placeholder);
        color: #9aa1a9;
      }
      .download-link {
        display: block;
        text-align: center;
        margin-top: 10px;
        color: var(--primary);
        text-decoration: none;
      }
      .download-link:hover {
        text-decoration: underline;
      }
      .embed-media {
        display: inline-block;
        max-width: 100%;
      }
      .resizable-x {
        resize: horizontal;
        overflow: auto;
      }
      .resizable-both {
        resize: both;
        overflow: auto;
      }
      .embed-media > img {
        display: block;
        width: 100%;
        height: auto;
      }
      .embed-media > video,
      .embed-media > iframe {
        display: block;
        width: 100%;
        height: 100%;
      }

      /* ===== جدول المحرر + الشريط العائم ===== */
      .rte-table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
      }
      .rte-table th,
      .rte-table td {
        border: 1px solid #e5e7eb;
        padding: 8px;
        background: #fff;
        vertical-align: top;
      }
      .rte-table.no-border th,
      .rte-table.no-border td {
        border: 1px solid transparent;
      }
      .rte-table th {
        background: #f8fafc;
        font-weight: 700;
      }
      .rte-table td:focus,
      .rte-table th:focus {
        outline: 2px solid rgba(67, 97, 238, 0.35);
      }
      /* ===== شريط أدوات الجدول ===== */
      .table-toolbar {
        width: 100%;
        display: flex; /* Will be toggled by JS */
        flex-direction: column;
        gap: 6px;
        background: #eef2ff;
        padding: 8px;
        border-radius: 8px;
        margin-top: 8px;
        border: 1px solid #dbeafe;
      }
      .table-toolbar .tb-row {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .table-toolbar .tb-btn {
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #fff;
        color: #333;
        padding: 6px 8px;
        cursor: pointer;
        font-size: 12px;
        transition: background-color 0.2s;
      }
      .table-toolbar .tb-btn:hover {
        background: #f0f2f5;
      }
      .table-toolbar .tb-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f9fafb;
      }
      .table-toolbar .tb-label {
        font-size: 12px;
        margin-left: 4px;
        color: #4b5563;
        font-weight: 500;
      }
      .table-toolbar .tb-input {
        width: 45px;
        background: #fff;
        color: #333;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 4px;
        text-align: center;
        -moz-appearance: textfield;
      }
      .table-toolbar .tb-input::-webkit-outer-spin-button,
      .table-toolbar .tb-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .table-toolbar .sep {
        width: 1px;
        height: 20px;
        background: #d1d5db;
        margin: 0 4px;
      }
      .table-toolbar .tb-color {
        width: 30px;
        height: 30px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        padding: 0;
      }
      .table-toolbar .tb-select {
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #fff;
        color: #333;
        padding: 4px;
        font-size: 12px;
        margin: 0 2px;
      }

      /* ===== Notification ===== */
      .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 20px;
        background: var(--dark);
        color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s;
        z-index: 1200;
      }
      .notification.show {
        transform: translateY(0);
        opacity: 1;
      }
      .notification.success {
        background: var(--success);
      }
      .notification.error {
        background: var(--danger);
      }

      /* ===== Preview ===== */
      .final-portfolio {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--page-print-bg);
        z-index: 1100;
        overflow-y: auto;
      }
      .portfolio-header {
        background: var(--primary);
        color: #fff;
        padding: 20px;
        padding-right: calc(280px + 20px);
      }
      .header-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }
      .header-btn {
        background: #ffffff;
        border: none;
        color: #1f2937;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      .header-btn.export {
        background: #111827;
        color: #fff;
      }
      .portfolio-header-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }
      .portfolio-logo {
        width: 80px;
        height: 80px;
        object-fit: contain;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
      }
      .portfolio-logo:not([src]),
      .portfolio-logo[src=""] {
        display: none;
      }
      .portfolio-titles h1 {
        margin: 0;
      }
      .portfolio-subtitle {
        opacity: 0.95;
        font-size: 1.05rem;
      }
      .portfolio-sidebar {
        width: 250px;
        background: #f0f2f5;
        height: 100vh;
        position: fixed;
        top: 0;
        right: 0;
        padding: 20px;
        overflow-y: auto;
      }
      .portfolio-sidebar a {
        display: block;
        padding: 8px 10px;
        margin-bottom: 5px;
        text-decoration: none;
        border-radius: 6px;
        color: #fff !important;
        transition: filter 0.2s ease;
      }
      .portfolio-sidebar a:hover {
        filter: brightness(1.06);
      }
      .portfolio-sidebar a:nth-of-type(6n + 1) {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      }
      .portfolio-sidebar a:nth-of-type(6n + 2) {
        background: linear-gradient(135deg, #10b981, #047857);
      }
      .portfolio-sidebar a:nth-of-type(6n + 3) {
        background: linear-gradient(135deg, #f59e0b, #b45309);
      }
      .portfolio-sidebar a:nth-of-type(6n + 4) {
        background: linear-gradient(135deg, #ef4444, #b91c1c);
      }
      .portfolio-sidebar a:nth-of-type(6n + 5) {
        background: linear-gradient(135deg, #06b6d4, #0e7490);
      }
      .portfolio-sidebar a:nth-of-type(6n) {
        background: linear-gradient(135deg, #a855f7, #6b21a8);
      }
      .portfolio-content {
        margin-right: 250px;
        padding: 20px;
        background: var(--editor-print-bg);
      }
      .portfolio-footer {
        margin: 20px auto 0;
        text-align: center;
        color: #333;
        border-top: 1px solid #e0e0e0;
        padding-top: 12px;
      }
      .tab-content {
        display: none;
        border: 2px dashed #e5e7eb;
        border-radius: 10px;
        padding: 16px;
        background: #fff;
        margin-bottom: 16px;
      }
      .portfolio-content .tab-content:nth-of-type(6n + 1) {
        border-color: #1d4ed8;
      }
      .portfolio-content .tab-content:nth-of-type(6n + 2) {
        border-color: #047857;
      }
      .portfolio-content .tab-content:nth-of-type(6n + 3) {
        border-color: #b45309;
      }
      .portfolio-content .tab-content:nth-of-type(6n + 4) {
        border-color: #b91c1c;
      }
      .portfolio-content .tab-content:nth-of-type(6n + 5) {
        border-color: #0e7490;
      }
      .portfolio-content .tab-content:nth-of-type(6n) {
        border-color: #6b21a8;
      }
      .tab-content.active {
        display: block;
      }
      .close-portfolio {
        position: absolute;
        top: 20px;
        left: 20px;
        background: #fff;
        color: #4361ee;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* ===== مودالات (الإصلاح هنا) ===== */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1400;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .modal-content {
        width: min(680px, 100%);
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        direction: rtl;
      }
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .modal-title {
        font-size: 1.15rem;
        margin: 0;
      }
      .close-modal {
        background: transparent;
        border: none;
        font-size: 26px;
        cursor: pointer;
        line-height: 1;
      }
      .form-group {
        margin-bottom: 12px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }
      .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        background: #fff;
      }
      .form-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
      }
      .btn {
        padding: 10px 14px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
      }
      .btn-primary {
        background: var(--primary);
        color: #fff;
      }
      .btn-secondary {
        background: #f0f2f5;
        color: #111827;
      }
      .file-preview {
        margin-top: 8px;
        background: #f8fafc;
        border: 1px dashed #e5e7eb;
        border-radius: 8px;
        padding: 8px;
      }

      @media (max-width: 992px) {
        .container {
          flex-direction: column;
        }
        .sidebar {
          width: 100%;
          height: auto;
        }
        .toolbar {
          overflow-x: auto;
        }
      }
      @media print {
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        html,
        body {
          background: var(--page-print-bg) !important;
        }
        .header-actions,
        .header-btn,
        .sidebar,
        .toolbar,
        .action-buttons,
        .modal,
        .notification,
        .close-portfolio {
          display: none !important;
        }
        .final-portfolio {
          position: static !important;
          display: block !important;
          background: var(--page-print-bg) !important;
          height: auto !important;
        }
        .portfolio-sidebar {
          display: none !important;
        }
        .portfolio-content {
          margin: 0 !important;
          background: var(--editor-print-bg) !important;
          box-shadow: none !important;
          font-size: inherit !important;
        }
        .tab-content {
          display: block !important;
          break-inside: avoid;
          page-break-inside: avoid;
          margin-bottom: 16px;
        }
        .portfolio-header {
          background: var(--primary) !important;
          color: #fff !important;
          padding-right: 20px !important;
          padding-left: 20px !important;
        }
        .portfolio-header-inner {
          justify-content: flex-start !important;
        }
        @page {
          size: A4;
          margin: 12mm;
        }
      }

      .footer {
        font-family: "Cairo", Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text);
        text-align: center;
        padding: 14px 12px;
        border-top: 1px solid #e5e7eb;
        background: transparent;
        line-height: 1.7;
        font-size: 0.95rem;
      }
      .footer .line {
        margin: 2px 0;
      }
      .footer a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 700;
      }
      .footer a:hover {
        text-decoration: underline;
      }
      .footer .sep {
        margin: 0 6px;
        color: var(--muted);
      }
      @media print {
        .footer {
          page-break-inside: avoid;
          font-size: 0.9rem;
        }
        .footer a {
          color: #1f3af5 !important;
          text-decoration: none;
        }
      }
      .embed-container {
        position: relative;
      }
      .embed-actions {
        z-index: 10000;
        pointer-events: auto;
      }
      .tab.dragging {
        opacity: 0.4;
      }
      .tab.drop-parent {
        outline: 2px dashed var(--success);
        outline-offset: 2px;
      }
      .drop-indicator {
        position: absolute;
        height: 4px;
        background: var(--success);
        border-radius: 2px;
        pointer-events: none;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div id="jsError"></div>
    <div class="container">
      <aside class="sidebar">
        <div class="app-title">
          <h1>محرر ملف الإنجاز</h1>
          <p>نسخةالإصدار الاول ـ مرحبا بك</p>
        </div>
        <div class="tabs-container" id="tabsContainer"></div>
        <div class="sidebar-actions">
          <button class="sidebar-btn" type="button" onclick="UI.addTab(null)">
            تبويب جديد
          </button>
          <button
            class="sidebar-btn delete"
            type="button"
            onclick="UI.deleteActive()"
          >
            حذف التبويب
          </button>
          <button class="sidebar-btn" type="button" onclick="UI.newProject()">
            مشروع جديد
          </button>
        </div>
      </aside>

      <main class="main-content">
        <div class="toolbar">
          <div class="toolbar-group">
            <select
              class="toolbar-select"
              id="formatSelect"
              aria-label="تنسيق"
              onchange="UI.format(this.value)"
            >
              <option value="p">نص عادي</option>
              <option value="h1">عنوان رئيسي</option>
              <option value="h2">عنوان فرعي</option>
              <option value="h3">عنوان ثانوي</option>
              <option value="blockquote">اقتباس</option>
            </select>
          </div>

          <div class="toolbar-group">
            <button
              class="toolbar-btn"
              type="button"
              id="formatPainterBtn"
              title="نسخ التنسيق"
              onclick="UI.toggleFormatPainter()"
            >
              🖌️
            </button>
          </div>

          <div class="toolbar-group">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="عريض"
              onclick="UI.exec('bold')"
            >
              <b>B</b>
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="مائل"
              onclick="UI.exec('italic')"
            >
              <i>I</i>
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="تحته خط"
              onclick="UI.exec('underline')"
            >
              <u>U</u>
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="يتوسطه خط"
              onclick="UI.exec('strikeThrough')"
            >
              <s>S</s>
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="مرتفع"
              onclick="UI.exec('superscript')"
            >
              X<sup>2</sup>
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="منخفض"
              onclick="UI.exec('subscript')"
            >
              X<sub>2</sub>
            </button>
          </div>

          <div class="toolbar-group">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="قائمة نقطية"
              onclick="UI.exec('insertUnorderedList')"
            >
              • قائمة
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="قائمة رقمية"
              onclick="UI.exec('insertOrderedList')"
            >
              1. قائمة
            </button>
          </div>

          <!-- أدوات إضافية: المسافة البادئة والخط الأفقي -->
          <div class="toolbar-group" title="تنسيق الفقرة">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="زيادة المسافة البادئة"
              onclick="UI.exec('indent')"
            >
              ⇥
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إنقاص المسافة البادئة"
              onclick="UI.exec('outdent')"
            >
              ⇤
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إدراج خط أفقي"
              onclick="UI.exec('insertHorizontalRule')"
            >
              ―
            </button>
          </div>

          <div class="toolbar-group">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="محاذاة يمين"
              onclick="UI.exec('justifyRight')"
            >
              ⟸
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="توسيط"
              onclick="UI.exec('justifyCenter')"
            >
              ↔
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="محاذاة يسار"
              onclick="UI.exec('justifyLeft')"
            >
              ⟹
            </button>
          </div>

          <div class="toolbar-group" title="تكبير/تصغير الخط">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="تصغير الخط"
              onclick="UI.font(-2)"
            >
              A−
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="تكبير الخط"
              onclick="UI.font(+2)"
            >
              A+
            </button>
          </div>

          <div class="toolbar-group" title="لون الخط">
            <span class="color-label">🎨</span>
            <input
              type="color"
              id="fontColorPicker"
              class="color-input"
              aria-label="لون الخط"
              onchange="UI.color(this.value)"
            />
          </div>

          <div class="toolbar-group" title="الخلفيات">
            <span class="color-label">🖼️</span>
            <input
              type="color"
              id="editorBgPicker"
              class="color-input"
              aria-label="خلفية المحرر"
              value="#ffffff"
              onchange="UI.setEditorBg(this.value)"
            />
            <span class="color-label">🧩</span>
            <input
              type="color"
              id="pageBgPicker"
              class="color-input"
              aria-label="خلفية الصفحة"
              value="#f5f7fb"
              onchange="UI.setPageBg(this.value)"
            />
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إعادة المظهر"
              onclick="UI.resetAppearance()"
            >
              إعادة
            </button>
          </div>

          <div class="toolbar-group" title="روابط">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إضافة رابط"
              onclick="UI.openLinkModalForSelection()"
            >
              🔗 رابط
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="فك الرابط"
              onclick="UI.unlinkSelection()"
            >
              ⛓️ فك
            </button>
          </div>

          <div class="toolbar-group">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إدراج صورة"
              onclick="UI.openMedia()"
            >
              صورة
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إدراج ملف"
              onclick="UI.openMedia()"
            >
              ملف
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إدراج فيديو"
              onclick="UI.openMedia()"
            >
              فيديو
            </button>
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إدراج ملف أوفيس"
              onclick="UI.openOffice()"
            >
              أوفيس
            </button>
          </div>

          <div class="toolbar-group" title="اللصق">
            <span style="padding: 0 6px; font-size: 13px">اللصق:</span>
            <button
              class="toolbar-btn"
              type="button"
              onclick="UI.setPasteMode('smart')"
            >
              ذكي
            </button>
            <button
              class="toolbar-btn"
              type="button"
              onclick="UI.setPasteMode('plain')"
            >
              نصي
            </button>
          </div>

          <div class="toolbar-group" title="جدول">
            <button
              class="toolbar-btn"
              type="button"
              aria-label="إدراج جدول"
              onclick="UI.openTableModal()"
            >
              جدول
            </button>
          </div>

          <div id="tableToolbar" class="table-toolbar" style="display: none;">
            <div class="tb-row">
              <button class="tb-btn" data-act="row-before" title="إضافة صف قبل">صف ↑</button>
              <button class="tb-btn" data-act="row-after" title="إضافة صف بعد">صف ↓</button>
              <button class="tb-btn" data-act="col-before" title="إضافة عمود قبل">عمود ←</button>
              <button class="tb-btn" data-act="col-after" title="إضافة عمود بعد">عمود →</button>
              <span class="sep"></span>
              <button class="tb-btn" data-act="del-row" title="حذف الصف">حذف صف</button>
              <button class="tb-btn" data-act="del-col" title="حذف العمود">حذف عمود</button>
              <button class="tb-btn" data-act="del-table" title="حذف الجدول">حذف جدول</button>
            </div>
            <div class="tb-row">
              <button class="tb-btn" data-act="merge-right" title="دمج يمين">دمج ↔</button>
              <button class="tb-btn" data-act="merge-down" title="دمج أسفل">دمج ↕</button>
              <button class="tb-btn" data-act="split-cell" title="تقسيم الخلية">تقسيم</button>
              <span class="sep"></span>
              <button class="tb-btn" data-act="toggle-header" title="تبديل صف العنوان">رأس</button>
              <button class="tb-btn" data-act="autofit-table" title="ضبط تلقائي لعرض الجدول">↔ ضبط</button>
              <span class="sep"></span>
              <button class="tb-btn" data-act="valign-top" title="محاذاة للأعلى">أعلى</button>
              <button class="tb-btn" data-act="valign-middle" title="توسيط عمودي">وسط</button>
              <button class="tb-btn" data-act="valign-bottom" title="محاذاة للأسفل">أسفل</button>
            </div>
            <div class="tb-row">
              <label class="tb-label">حدود:</label>
              <input type="number" id="tblBorderWidth" min="0" max="10" value="1" class="tb-input" title="حجم الحد (px)"/>
              <select id="tblBorderStyle" class="tb-select" title="نمط الحد">
                <option value="solid">صلب</option>
                <option value="dashed">متقطع</option>
                <option value="dotted">منقط</option>
              </select>
              <input type="color" id="tblBorderColor" class="tb-color" title="لون الحد"/>
              <span class="sep"></span>
              <label class="tb-label">خلفية:</label>
              <input type="color" id="cellBgPicker" class="tb-color" title="لون الخلفية"/>
              <button class="tb-btn" data-act="cell-bg-cell" title="تطبيق على الخلية">خلية</button>
              <button class="tb-btn" data-act="cell-bg-row" title="تطبيق على الصف">صف</button>
              <button class="tb-btn" data-act="cell-bg-col" title="تطبيق على العمود">عمود</button>
              <button class="tb-btn" data-act="cell-bg-clear" title="مسح اللون">مسح</button>
            </div>
          </div>
        </div>

        <div class="editor" id="editorWrapper">
          <div class="editor-content" id="editor" contenteditable="true">
            <h1>محرر ملف الإنجاز | portfolio_editor</h1>
            <p>
              إصلاح ظهور نصوص المودالات أسفل الصفحة + مزايا اللصق الذكي وتلوين
              خلايا الجداول كما في النسخة السابقة.
            </p>
          </div>

          <!-- شريط تحكم الجداول العائم -->
          </div>
        </div>

        <div class="action-buttons">
          <button
            class="action-btn export"
            type="button"
            aria-label="تصدير المشروع"
            onclick="UI.exportProject()"
          >
            تصدير المشروع
          </button>
          <button
            class="action-btn import"
            type="button"
            aria-label="استيراد مشروع"
            onclick="UI.importProject()"
          >
            استيراد مشروع
          </button>
          <button
            class="action-btn generate"
            type="button"
            aria-label="معاينة ملف الإنجاز"
            onclick="UI.previewPortfolio()"
          >
            معاينة ملف الإنجاز
          </button>
          <button
            class="action-btn pdf"
            style="display: none"
            type="button"
            aria-label="تصدير PDF"
            onclick="UI.exportPDF()"
          >
            تصدير PDF (بنفس الألوان)
          </button>
        </div>
      </main>
    </div>

    <!-- النوافذ -->
    <div class="modal" id="newTabModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">إنشاء تبويب جديد</h2>
          <button
            class="close-modal"
            onclick="UI.hide(document.getElementById('newTabModal'))"
          >
            &times;
          </button>
        </div>
        <div class="form-group">
          <label for="tabTitle">اسم التبويب</label>
          <input
            type="text"
            class="form-control"
            id="tabTitle"
            placeholder="أدخل اسم التبويب"
            onkeypress="if(event.key==='Enter'){UI.createTab()}"
          />
        </div>
        <div class="form-actions">
          <button
            class="btn btn-secondary"
            onclick="UI.hide(document.getElementById('newTabModal'))"
          >
            إلغاء
          </button>
          <button class="btn btn-primary" onclick="UI.createTab()">
            إنشاء
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="mediaModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="mediaModalTitle">إدراج وسائط</h2>
          <button
            class="close-modal"
            onclick="UI.hide(document.getElementById('mediaModal'))"
          >
            &times;
          </button>
        </div>
        <div
          class="file-type-buttons"
          style="display: flex; gap: 10px; margin-bottom: 10px"
        >
          <button
            class="toolbar-btn"
            onclick="UI.toggleMediaType('upload')"
            id="btnUpload"
          >
            رفع ملف
          </button>
          <button
            class="toolbar-btn"
            onclick="UI.toggleMediaType('url')"
            id="btnUrl"
          >
            رابط خارجي
          </button>
          <button
            class="toolbar-btn"
            onclick="UI.toggleMediaType('gdrive')"
            id="btnGdrive"
          >
            🔗 رابط Drive
          </button>
        </div>
        <div id="uploadFileSection">
          <div class="form-group">
            <label for="mediaFile">اختر ملف للرفع</label>
            <input
              type="file"
              class="form-control"
              id="mediaFile"
              accept=".jpg,.jpeg,.png,.gif,.webp,.mp4,.webm,.ogg,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx"
            />
            <small>يدعم الصور، الفيديو، PDF، وملفات Office</small>
          </div>
          <div
            class="file-preview"
            id="filePreview"
            style="display: none"
          ></div>
        </div>
        <div id="urlFileSection" style="display: none">
          <div class="form-group">
            <label for="mediaUrl">أدخل رابط الملف</label>
            <input
              type="text"
              class="form-control"
              id="mediaUrl"
              placeholder="https://example.com/file.pdf"
            />
          </div>
          <div class="form-group">
            <label for="fileType">نوع الملف</label>
            <select class="form-control" id="fileType">
              <option value="auto">تحديد تلقائي</option>
              <option value="image">صورة</option>
              <option value="video">فيديو</option>
              <option value="pdf">PDF</option>
              <option value="word">Word</option>
              <option value="excel">Excel</option>
              <option value="powerpoint">PowerPoint</option>
            </select>
          </div>
        </div>
        <div id="gdriveFileSection" style="display: none">
          <div class="form-group">
            <label for="gdriveUrl">ألصق رابط المشاركة من جوجل درايف هنا</label>
            <input
              type="text"
              class="form-control"
              id="gdriveUrl"
              placeholder="https://drive.google.com/file/d/..."
            />
            <small
              >سيتم تحويل الرابط تلقائيًا إلى رابط مباشر للعرض والتحميل.</small
            >
          </div>
          <div class="form-group">
            <label for="gdriveFileType">نوع الملف (مهم للعرض الصحيح)</label>
            <select class="form-control" id="gdriveFileType">
              <option value="auto">تحديد تلقائي (غير دقيق)</option>
              <option value="image">صورة</option>
              <option value="video">فيديو</option>
              <option value="pdf">PDF</option>
              <option value="word">Word</option>
              <option value="excel">Excel</option>
              <option value="powerpoint">PowerPoint</option>
              <option value="other">ملف آخر (للتحميل فقط)</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="mediaCaption">وصف (اختياري)</label>
          <input
            type="text"
            class="form-control"
            id="mediaCaption"
            placeholder="وصف الملف"
          />
        </div>
        <div class="form-actions">
          <button
            class="btn btn-secondary"
            onclick="UI.hide(document.getElementById('mediaModal'))"
          >
            إلغاء
          </button>
          <button class="btn btn-primary" onclick="UI.insertMedia()">تم</button>
        </div>
      </div>
    </div>

    <div class="modal" id="linkModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">إدراج/تعديل رابط</h2>
          <button
            class="close-modal"
            onclick="UI.hide(document.getElementById('linkModal'))"
          >
            &times;
          </button>
        </div>
        <div class="form-group">
          <label for="linkUrl">عنوان الرابط (URL)</label>
          <input
            type="text"
            class="form-control"
            id="linkUrl"
            placeholder="https://example.com أو mailto:user@example.com"
          />
        </div>
        <div
          class="form-group"
          style="display: flex; gap: 8px; align-items: center"
        >
          <input type="checkbox" id="linkNewTab" checked />
          <label for="linkNewTab">فتح في تبويب جديد</label>
        </div>
        <div class="form-actions">
          <button
            class="btn btn-secondary"
            onclick="UI.hide(document.getElementById('linkModal'))"
          >
            إلغاء
          </button>
          <button class="btn btn-primary" onclick="UI.confirmLink()">
            حفظ الرابط
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="tableModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">إدراج جدول</h2>
          <button
            class="close-modal"
            onclick="UI.hide(document.getElementById('tableModal'))"
          >
            &times;
          </button>
        </div>
        <div class="form-group">
          <label>عدد الصفوف</label>
          <input
            type="number"
            min="1"
            max="50"
            value="3"
            id="tblRows"
            class="form-control"
          />
        </div>
        <div class="form-group">
          <label>عدد الأعمدة</label>
          <input
            type="number"
            min="1"
            max="20"
            value="3"
            id="tblCols"
            class="form-control"
          />
        </div>
        <div class="form-actions">
          <button
            class="btn btn-secondary"
            onclick="UI.hide(document.getElementById('tableModal'))"
          >
            إلغاء
          </button>
          <button class="btn btn-primary" onclick="UI.createTable()">
            إدراج
          </button>
        </div>
      </div>
    </div>

    <div class="final-portfolio" id="finalPortfolio">
      <button class="close-portfolio" onclick="UI.closePreview()">
        &times;
      </button>
      <div class="portfolio-header">
        <div class="portfolio-header-inner" dir="rtl">
          <img id="portfolioHeaderLogo" class="portfolio-logo" alt="شعار" />
          <div class="portfolio-titles">
            <h1 id="portfolioHeaderTitle">ملف الإنجاز</h1>
            <div id="portfolioHeaderSubtitle" class="portfolio-subtitle"></div>
          </div>
          <div class="header-actions">
            <button
              class="header-btn"
              type="button"
              onclick="UI.closePreview()"
            >
              رجوع للمحرر
            </button>
            <button
              class="header-btn"
              type="button"
              onclick="UI.exportZIP()"
              title="حزمة ZIP (للنشر)"
              aria-label="حزمة ZIP (للنشر)"
            >
              حزمة ZIP (للنشر)
            </button>
            <button
              class="header-btn export"
              type="button"
              onclick="UI.exportHTML()"
              title="تصدير HTML (ملف واحد)"
              aria-label="تصدير HTML (ملف واحد)"
            >
              تصدير HTML
            </button>
          </div>
        </div>
      </div>
      <div class="portfolio-sidebar" id="portfolioSidebar">
        <h3>فهرس المحتويات</h3>
      </div>
      <div class="portfolio-content" id="portfolioContent"></div>
    </div>

    <div class="notification" id="notification">
      <span id="notificationMessage"></span>
    </div>

    <!-- مكوّن تذييل جاهز -->
    <!-- مكوّن تذييل جاهز -->
    <footer class="footer" dir="rtl">
      <div class="line">
        <span>برمجة: أ/فاطمة هزازي، أ/عبدالعزيز العبدالجبار</span>
        <span class="sep">•</span>
        <span>باستخدام</span>
        <a href="https://chatgpt.com" target="_blank" rel="noopener noreferrer"
          >ChatGPT</a
        >
        <a
          href="https://gemini.google.com/"
          target="_blank"
          rel="noopener noreferrer"
          >Gemini</a
        >
      </div>
      <div class="line">جميع الحقوق محفوظة لملتقى معلمي ومعلمات الرياضيات</div>
      <div class="line">
        <span>للاستفسار والتواصل: </span>
        <a href="https://t.me/ITG_KSA" target="_blank" rel="noopener noreferrer"
          >ملتقى التعليم التفاعلي</a
        >
      </div>
    </footer>

    <script>
      (function () {
        window.onerror = function (msg) {
          const b = document.getElementById("jsError");
          b.textContent = "خطأ: " + msg;
          b.style.display = "block";
        };
        window.onunhandledrejection = function (e) {
          const b = document.getElementById("jsError");
          b.textContent =
            "وعد مرفوض: " + ((e.reason && e.reason.message) || e.reason || "");
          b.style.display = "block";
        };

        const state = {
          tabs: [{ id: id(), title: "الغلاف", content: "" }],
          activeTabId: null,
          mediaType: "upload",
          settings: {
            editorFontSize: 16,
            pageBg: "#f5f7fb",
            editorBg: "#ffffff",
          },
          portfolio: {
            teacherName: "",
            teacherLabel: "المعلم/ـة",
            footerText: "",
            logoData: "",
          },
          savedRange: null,
          linkContext: null,
          currentCell: null,
          pasteMode: "smart",
        };
        state.formatPainterActive = false;
        state.copiedFormats = null;
        state.newTabParentId = null;

        const el = {
          tabsContainer: document.getElementById("tabsContainer"),
          editor: document.getElementById("editor"),
          editorWrapper: document.getElementById("editorWrapper"),
          finalPortfolio: document.getElementById("finalPortfolio"),
          portfolioSidebar: document.getElementById("portfolioSidebar"),
          portfolioContent: document.getElementById("portfolioContent"),
          portfolioHeaderTitle: document.getElementById("portfolioHeaderTitle"),
          filePreview: document.getElementById("filePreview"),
          linkUrl: document.getElementById("linkUrl"),
          linkNewTab: document.getElementById("linkNewTab"),
          tableToolbar: document.getElementById("tableToolbar"),
          cellBgPicker: document.getElementById("cellBgPicker"),
          formatPainterBtn: document.getElementById("formatPainterBtn"),
        };

        function note(msg, type) {
          const n = document.getElementById("notification");
          document.getElementById("notificationMessage").textContent = msg;
          n.className = "notification " + (type || "success");
          n.classList.add("show");
          setTimeout(() => n.classList.remove("show"), 2200);
        }
        function show(m) {
          m.style.display = "flex";
        }
        function hide(m) {
          m.style.display = "none";
        }
        function id() {
          return Date.now().toString(36) + Math.random().toString(36).slice(2);
        }
        function esc(s) {
          return (s || "").replace(
            /[&<>\"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[m])
          );
        }
        function sanitizeUrl(url) {
          const t = (url || "").trim();
          if (!t) return "";
          if (/^(https?:|mailto:|tel:)/i.test(t)) return t;
          return "https://" + t.replace(/^\/+/, "");
        }

        function applySettings() {
          el.editor.style.setProperty(
            "--editor-font-size",
            state.settings.editorFontSize + "px"
          );
          document.body.style.backgroundColor = state.settings.pageBg;
          el.editorWrapper.style.backgroundColor = state.settings.editorBg;
          document.documentElement.style.setProperty(
            "--page-print-bg",
            state.settings.pageBg
          );
          document.documentElement.style.setProperty(
            "--editor-print-bg",
            state.settings.editorBg
          );
        }

        const STORAGE_KEY = "portfolio_v37";
        function saveToStorage() {
          try {
            const a = state.tabs.find((x) => x.id === state.activeTabId);
            if (a) a.content = el.editor.innerHTML;
            const data = {
              version: "3.6",
              tabs: state.tabs,
              settings: state.settings,
              portfolio: state.portfolio,
              activeTabId: state.activeTabId,
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          } catch (_) {}
        }
        function loadFromStorage() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return null;
            const d = JSON.parse(raw);
            if (!d || !Array.isArray(d.tabs) || !d.tabs.length) return null;
            state.tabs = d.tabs;
            // Migration for sub-tabs
            state.tabs.forEach((t) => {
              if (t.isCollapsed === undefined) t.isCollapsed = false;
              if (t.parentId === undefined) t.parentId = null;
            });

            state.settings = d.settings || state.settings;
            state.portfolio = d.portfolio || state.portfolio;
            applySettings();
            const eb = document.getElementById("editorBgPicker");
            if (eb) eb.value = state.settings.editorBg || "#ffffff";
            const pb = document.getElementById("pageBgPicker");
            if (pb) pb.value = state.settings.pageBg || "#f5f7fb";
            return d.activeTabId || state.tabs[0].id;
          } catch (_) {
            return null;
          }
        }

        function ensureRangeInEditor() {
          const sel = window.getSelection();
          if (
            !sel ||
            sel.rangeCount === 0 ||
            !el.editor.contains(sel.anchorNode)
          ) {
            el.editor.focus();
            const r = document.createRange();
            r.selectNodeContents(el.editor);
            r.collapse(false);
            const s = window.getSelection();
            s.removeAllRanges();
            s.addRange(r);
            return r;
          }
          return sel.getRangeAt(0);
        }
        function saveSel() {
          const s = window.getSelection();
          if (s && s.rangeCount > 0 && el.editor.contains(s.anchorNode))
            state.savedRange = s.getRangeAt(0);
        }
        function restoreSel() {
          const s = window.getSelection();
          const r = state.savedRange;
          if (!r) return;
          try {
            const c = r.commonAncestorContainer;
            if (!document.contains(c) || !el.editor.contains(c)) throw 0;
            s.removeAllRanges();
            s.addRange(r);
          } catch (_) {
            state.savedRange = null;
          }
        }

        /* === جداول: أدوات === */
        function getCellFromSelection() {
          const s = window.getSelection();
          if (!s || s.rangeCount === 0) return null;
          let n = s.anchorNode;
          if (n && n.nodeType === 3) n = n.parentElement;
          while (n && n !== el.editor) {
            if (n.tagName === "TD" || n.tagName === "TH") return n;
            n = n.parentElement;
          }
          return null;
        }
        function tableInfo(td) {
          if (!td) return null;
          const tr = td.parentElement;
          const table = td.closest("table");
          if (!table) return null;
          const rows = [...table.rows];
          const rIndex = tr.rowIndex;
          const cells = [...tr.cells];
          let cIndex = cells.indexOf(td);
          return { table, tr, td, rows, rIndex, cIndex };
        }
        function showTableToolbar(td) {
          if (!td) return hideTableToolbar();
          state.currentCell = td;
          const b = el.tableToolbar;
          if (!b) return;

          // Update UI state from the selected cell
          const table = td.closest("table");
          if (table) {
            const cur = getComputedStyle(td).backgroundColor;
            const hex = rgbToHex(cur) || "#ffffff";
            if (el.cellBgPicker) el.cellBgPicker.value = hex;

            const borderWidthInput = document.getElementById("tblBorderWidth");
            const borderColorInput = document.getElementById("tblBorderColor");
            const sampleCell = table.querySelector("td, th") || td;
            const borderStyleInput = document.getElementById("tblBorderStyle");

            const computedStyle = window.getComputedStyle(sampleCell);
            const width = parseInt(computedStyle.borderWidth, 10);
            const color = rgbToHex(computedStyle.borderColor);
            const style = computedStyle.borderTopStyle;

            if (borderWidthInput) borderWidthInput.value = isNaN(width) ? 1 : width;
            if (borderColorInput) borderColorInput.value = color || "#e5e7eb";
            if (borderStyleInput) borderStyleInput.value = style || "solid";

            const splitBtn = b.querySelector('[data-act="split-cell"]');
            if (splitBtn)
              splitBtn.disabled = td.rowSpan <= 1 && td.colSpan <= 1;
            const mergeRightBtn = b.querySelector('[data-act="merge-right"]');
            if (mergeRightBtn)
              mergeRightBtn.disabled =
                !td.nextElementSibling ||
                td.nextElementSibling.rowSpan !== td.rowSpan;

            const map = buildTableMap(table);
            const coords = getCoordsOfCell(td, map);
            const mergeDownBtn = b.querySelector('[data-act="merge-down"]');
            if (mergeDownBtn) {
              if (!coords) mergeDownBtn.disabled = true;
              else {
                const belowCell = map[coords.r + td.rowSpan]?.[coords.c];
                mergeDownBtn.disabled = !belowCell || belowCell.colSpan !== td.colSpan || getCoordsOfCell(belowCell, map)?.c !== coords.c;
              }
            }
          }
          b.style.display = "flex";
        }
        function hideTableToolbar() {
          if (el.tableToolbar) el.tableToolbar.style.display = "none";
          state.currentCell = null;
        }
        function rgbToHex(rgb) {
          const m = /rgba?\((\d+),\s*(\d+),\s*(\d+)/.exec(rgb || "");
          if (!m) return null;
          const r = Number(m[1]),
            g = Number(m[2]),
            b = Number(m[3]);
          const to = (n) => ("0" + n.toString(16)).slice(-2);
          return "#" + to(r) + to(g) + to(b);
        }

        /* === لصق ذكي (Word Tables) === */
        function sanitizeHTMLBasic(html) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const allowed = new Set([
            "P",
            "BR",
            "B",
            "STRONG",
            "I",
            "EM",
            "U",
            "A",
            "UL",
            "OL",
            "LI",
            "H1",
            "H2",
            "H3",
          ]);
          doc.body.querySelectorAll("*").forEach((n) => {
            const tag = n.tagName;
            if (!allowed.has(tag)) {
              const p = n.parentNode;
              while (n.firstChild) p.insertBefore(n.firstChild, n);
              p.removeChild(n);
              return;
            }
            [...n.attributes].forEach((a) => {
              if (!(tag === "A" && a.name.toLowerCase() === "href"))
                n.removeAttribute(a.name);
            });
            if (tag === "A") {
              const h = n.getAttribute("href") || "";
              n.setAttribute("href", sanitizeUrl(h));
            }
          });
          doc.body.innerHTML = doc.body.innerHTML.replace(
            /<\/?o:p[^>]*>/gi,
            ""
          );
          return doc.body.innerHTML;
        }

        function sanitizeTablesHTML(html) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");

          const allowed = new Set([
            "P",
            "BR",
            "B",
            "STRONG",
            "I",
            "EM",
            "U",
            "A",
            "UL",
            "OL",
            "LI",
            "H1",
            "H2",
            "H3",
            "TABLE",
            "TBODY",
            "THEAD",
            "TR",
            "TD",
            "TH",
            "CAPTION",
            "COLGROUP",
            "COL",
          ]);

          const keepAttrsPerTag = {
            A: ["href"],
            TD: ["rowspan", "colspan", "style"],
            TH: ["rowspan", "colspan", "style"],
            TABLE: ["style"],
            P: ["style"],
            H1: ["style"],
            H2: ["style"],
            H3: ["style"],
            LI: ["style"],
          };

          const allowStyles = (el) => {
            const tag = el.tagName;
            const raw = (el.getAttribute("style") || "").toLowerCase();
            if (!raw) {
              el.removeAttribute("style");
              return;
            }

            const map = {};
            raw.split(";").forEach((part) => {
              const kv = part.split(":");
              if (kv.length < 2) return;
              const k = kv[0].trim(),
                v = kv.slice(1).join(":").trim();
              if (!k) return;
              map[k] = v;
            });

            const out = [];
            if (tag === "TD" || tag === "TH") {
              if (map["background"])
                out.push("background-color:" + map["background"]);
              if (map["background-color"])
                out.push("background-color:" + map["background-color"]);
              if (map["text-align"])
                out.push("text-align:" + map["text-align"]);
              if (map["vertical-align"])
                out.push("vertical-align:" + map["vertical-align"]);
            } else {
              if (map["text-align"])
                out.push("text-align:" + map["text-align"]);
            }
            if (out.length) el.setAttribute("style", out.join("; "));
            else el.removeAttribute("style");
          };

          [...doc.body.querySelectorAll("*")].forEach((n) => {
            const tag = n.tagName;

            if (!allowed.has(tag)) {
              const p = n.parentNode;
              while (n.firstChild) p.insertBefore(n.firstChild, n);
              p.removeChild(n);
              return;
            }

            const keep = keepAttrsPerTag[tag] || [];
            [...n.attributes].forEach((a) => {
              const name = a.name.toLowerCase();
              if (!keep.includes(a.name)) n.removeAttribute(a.name);
              if (tag === "A" && name === "href") {
                n.setAttribute(
                  "href",
                  sanitizeUrl(n.getAttribute("href") || "")
                );
              }
            });

            if (keep.includes("style")) allowStyles(n);

            if (tag === "TABLE") {
              n.className = "rte-table";
              n.removeAttribute("border");
              n.removeAttribute("cellpadding");
              n.removeAttribute("cellspacing");
            }
          });

          doc.body.innerHTML = doc.body.innerHTML
            .replace(/<\/?o:p[^>]*>/gi, "")
            .replace(/\sclass="?Mso[^"]*"?/gi, "")
            .replace(/\smso-[^:]+:[^;"]+;?/gi, "");

          if (!doc.body.querySelector("table")) return sanitizeHTMLBasic(html);
          return doc.body.innerHTML;
        }

        /* === واجهة المستخدم === */
        window.UI = {
          show,
          hide,
          note,
          setPasteMode: (m) => {
            state.pasteMode = m === "plain" ? "plain" : "smart";
            note(
              "تم اختيار اللصق: " +
                (state.pasteMode === "smart" ? "ذكي" : "نصي")
            );
          },
          toggleFormatPainter: () => {
            if (state.formatPainterActive) {
              state.formatPainterActive = false;
              state.copiedFormats = null;
              el.formatPainterBtn.classList.remove("active");
              el.editor.style.cursor = "";
              note("تم إيقاف نسخ التنسيق");
              return;
            }

            const sel = window.getSelection();
            if (
              !sel ||
              sel.isCollapsed ||
              !el.editor.contains(sel.anchorNode)
            ) {
              return note("حدد نصًا لنسخ تنسيقه أولاً", "error");
            }

            const formats = {};
            const inlineFormats = [
              "bold",
              "italic",
              "underline",
              "strikeThrough",
              "superscript",
              "subscript",
            ];
            inlineFormats.forEach((cmd) => {
              if (document.queryCommandState(cmd)) formats[cmd] = true;
            });

            formats.foreColor = document.queryCommandValue("foreColor");
            formats.formatBlock = document.queryCommandValue("formatBlock");

            const parentA = sel.anchorNode.parentElement.closest("a");
            if (parentA) {
              formats.link = {
                href: parentA.getAttribute("href"),
                target: parentA.getAttribute("target"),
              };
            }

            state.copiedFormats = formats;
            state.formatPainterActive = true;
            el.formatPainterBtn.classList.add("active");
            el.editor.style.cursor = "copy";
            note("تم نسخ التنسيق. حدد نصًا آخر لتطبيقه.");
          },

          applyCopiedFormat: () => {
            if (!state.formatPainterActive || !state.copiedFormats) return;
            const sel = window.getSelection();
            if (!sel || sel.isCollapsed) return UI.toggleFormatPainter();

            ensureRangeInEditor();
            const formats = state.copiedFormats;
            [
              "bold",
              "italic",
              "underline",
              "strikeThrough",
              "superscript",
              "subscript",
            ].forEach((cmd) => {
              if (!!formats[cmd] !== document.queryCommandState(cmd))
                document.execCommand(cmd, false, null);
            });
            if (
              (formats.formatBlock || "p").toLowerCase() !==
              document.queryCommandValue("formatBlock").toLowerCase()
            )
              UI.format(formats.formatBlock);
            document.execCommand(
              "foreColor",
              false,
              formats.foreColor || "#000000"
            );
            document.execCommand("unlink", false, null);
            if (formats.link)
              document.execCommand("createLink", false, formats.link.href);

            UI.toggleFormatPainter();
            note("تم تطبيق التنسيق");
          },

          exec: (cmd) => {
            try {
              ensureRangeInEditor();
              document.execCommand(cmd, false, null);
              el.editor.focus();
              saveToStorage();
            } catch (_) {}
          },
          format: (tag) => {
            ensureRangeInEditor();
            const block = tag.toLowerCase() === "p" ? "P" : tag.toUpperCase();
            try {
              document.execCommand("formatBlock", false, "<" + block + ">");
            } catch (_) {
              try {
                document.execCommand("formatBlock", false, block);
              } catch (__) {}
            }
            el.editor.focus();
            saveToStorage();
          },
          font: (d) => {
            state.settings.editorFontSize = Math.max(
              10,
              Math.min(36, state.settings.editorFontSize + d)
            );
            applySettings();
            saveToStorage();
          },
          color: (val) => {
            ensureRangeInEditor();
            try {
              document.execCommand("foreColor", false, val);
            } catch (_) {}
            el.editor.focus();
            saveToStorage();
          },
          setEditorBg: (v) => {
            state.settings.editorBg = v;
            applySettings();
            saveToStorage();
          },
          setPageBg: (v) => {
            state.settings.pageBg = v;
            applySettings();
            saveToStorage();
          },
          resetAppearance: () => {
            state.settings.editorFontSize = 16;
            state.settings.pageBg = "#f5f7fb";
            state.settings.editorBg = "#ffffff";
            applySettings();
            saveToStorage();
          },

          toggleTabCollapse: (tabId) => {
            const tab = state.tabs.find((t) => t.id === tabId);
            if (tab) {
              tab.isCollapsed = !tab.isCollapsed;
              renderTabs();
              saveToStorage();
            }
          },

          addTab: (parentId = null) => {
            state.newTabParentId = parentId;
            document.getElementById("tabTitle").value = "";
            show(document.getElementById("newTabModal"));
          },
          createTab: () => {
            const t = document.getElementById("tabTitle").value.trim();
            if (!t) return note("أدخل اسم التبويب", "error");
            const nt = {
              id: id(),
              title: t,
              content: "",
              parentId: state.newTabParentId,
              isCollapsed: false,
            };
            state.tabs.push(nt);
            UI.setActiveTab(nt.id);
            hide(document.getElementById("newTabModal"));
            document.getElementById("tabTitle").value = "";
            saveToStorage();
          },
          setActiveTab: (tid) => {
            if (state.activeTabId) {
              const a = state.tabs.find((x) => x.id === state.activeTabId);
              if (a) a.content = el.editor.innerHTML;
            }
            state.activeTabId = tid;
            const n = state.tabs.find((x) => x.id === tid);
            el.editor.innerHTML = n ? n.content || "" : "";
            upgradeEmbeds(el.editor);
            renderTabs();
            saveToStorage();
            hideTableToolbar();
          },
          renameTab: (tid) => {
            const t = state.tabs.find((x) => x.id === tid);
            if (!t) return;
            const v = prompt("اسم جديد:", t.title);
            if (v && v.trim()) {
              t.title = v.trim();
              renderTabs();
              saveToStorage();
              note("تم التعديل");
            }
          },
          duplicateTab: (tid) => {
            const t = state.tabs.find((x) => x.id === tid);
            if (!t) return;
            const nt = {
              id: id(),
              title: t.title + " - نسخة",
              content: t.content,
            };
            state.tabs.push(nt);
            UI.setActiveTab(nt.id);
            saveToStorage();
            note("تم النسخ");
          },
          deleteActive: () => {
            if (!state.activeTabId) return;
            const activeTab = state.tabs.find(
              (t) => t.id === state.activeTabId
            );
            if (!activeTab) return;

            const getDescendants = (parentId) => {
              const children = state.tabs.filter(
                (t) => t.parentId === parentId
              );
              return [
                ...children,
                ...children.flatMap((c) => getDescendants(c.id)),
              ];
            };
            const descendants = getDescendants(activeTab.id);
            const idsToDelete = new Set([
              activeTab.id,
              ...descendants.map((d) => d.id),
            ]);

            if (
              !activeTab.parentId &&
              state.tabs.filter((t) => !t.parentId).length <= 1
            ) {
              return note("لا يمكن حذف آخر تبويب رئيسي", "error");
            }

            let confirmMsg = `حذف التبويب "${activeTab.title}"؟`;
            if (descendants.length > 0) {
              confirmMsg += `\nسيتم حذف ${descendants.length} تبويب فرعي معه.`;
            }

            if (confirm(confirmMsg)) {
              const currentIndex = state.tabs.findIndex(
                (t) => t.id === activeTab.id
              );
              state.tabs = state.tabs.filter((t) => !idsToDelete.has(t.id));

              let newActiveTab = null;
              if (state.tabs.length > 0) {
                const prevTab = state.tabs[currentIndex - 1];
                const parentTab = state.tabs.find(
                  (t) => t.id === activeTab.parentId
                );
                newActiveTab = prevTab || parentTab || state.tabs[0];
              }

              if (newActiveTab) {
                UI.setActiveTab(newActiveTab.id);
              } else {
                el.editor.innerHTML = "";
                renderTabs();
              }
              saveToStorage();
              note("تم الحذف");
            }
          },
          newProject: () => {
            if (
              !confirm(
                "هل تريد بدء مشروع جديد؟ سيؤدي هذا لمسح المحفوظات المحلية."
              )
            )
              return;
            try {
              localStorage.removeItem(STORAGE_KEY);
            } catch (_) {}
            state.tabs = [{ id: id(), title: "الغلاف", content: "" }];
            state.activeTabId = null;
            state.mediaType = "upload";
            state.settings = {
              editorFontSize: 16,
              pageBg: "#f5f7fb",
              editorBg: "#ffffff",
            };
            state.portfolio = {
              teacherName: "",
              teacherLabel: "المعلم/ـة",
              footerText: "",
              logoData: "",
              title: "الغلاف",
            };
            applySettings();
            renderTabs();
            UI.setActiveTab(state.tabs[0].id);
            note("تم بدء مشروع جديد");
          },

          openMedia: () => {
            saveSel();
            state.mode = "insert";
            state.replaceTarget = null;
            document.getElementById("mediaModalTitle").textContent =
              "إدراج وسائط";
            UI.toggleMediaType("upload");
            const fInp = document.getElementById("mediaFile");
            if (fInp) fInp.value = "";
            el.filePreview.innerHTML = "";
            el.filePreview.style.display = "none";
            const uInp = document.getElementById("mediaUrl");
            if (uInp) uInp.value = "";
            const fType = document.getElementById("fileType");
            if (fType) fType.value = "auto";
            const gInp = document.getElementById("gdriveUrl");
            if (gInp) gInp.value = "";
            const gType = document.getElementById("gdriveFileType");
            if (gType) gType.value = "auto";
            const cap = document.getElementById("mediaCaption");
            if (cap) cap.value = "";
            show(document.getElementById("mediaModal"));
          },
          openOffice: () => {
            UI.openMedia();
            UI.toggleMediaType("url");
            document.getElementById("fileType").value = "word";
          },
          toggleMediaType: (t) => {
            state.mediaType = t;
            document.getElementById("uploadFileSection").style.display =
              t === "upload" ? "block" : "none";
            document.getElementById("urlFileSection").style.display =
              t === "url" ? "block" : "none";
            document.getElementById("gdriveFileSection").style.display =
              t === "gdrive" ? "block" : "none";
          },
          insertMedia: insertMediaImpl,

          openLinkModalForSelection: () => {
            state.linkContext = null;
            saveSel();
            const sel = window.getSelection();
            const a =
              sel && sel.anchorNode
                ? closest("A", sel.anchorNode.parentElement)
                : null;
            document.getElementById("linkUrl").value = a
              ? a.getAttribute("href") || ""
              : "";
            document.getElementById("linkNewTab").checked = a
              ? a.getAttribute("target") === "_blank"
              : true;
            show(document.getElementById("linkModal"));
          },
          unlinkSelection: () => {
            const sel = window.getSelection();
            const a =
              sel && sel.anchorNode
                ? closest("A", sel.anchorNode.parentElement)
                : null;
            if (a) {
              unwrapAnchor(a);
              saveToStorage();
            }
            note("تم فك الرابط");
          },
          confirmLink: confirmLinkImpl,

          exportProject,
          importProject,
          previewPortfolio,
          showTab,
          exportPDF,

          openTableModal: () => {
            saveSel();
            show(document.getElementById("tableModal"));
          },
          createTable: () => {
            restoreSel();
            ensureRangeInEditor();
            const r = Math.max(
              1,
              Math.min(
                50,
                parseInt(document.getElementById("tblRows").value || "3", 10)
              )
            );
            const c = Math.max(
              1,
              Math.min(
                20,
                parseInt(document.getElementById("tblCols").value || "3", 10)
              )
            );
            const table = document.createElement("table");
            table.className = "rte-table";
            table.style.width = "100%";
            const colgroup = document.createElement("colgroup");
            for (let j = 0; j < c; j++) {
              const col = document.createElement("col");
              col.setAttribute('data-col-index', j);
              colgroup.appendChild(col);
            }
            table.appendChild(colgroup);
            const tbody = document.createElement("tbody");
            for (let i = 0; i < r; i++) {
              const tr = document.createElement("tr");
              for (let j = 0; j < c; j++) {
                const td = document.createElement("td");
                td.innerHTML = "";
                tr.appendChild(td);
              }
              tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            const sel = window.getSelection();
            const range = sel.getRangeAt(0);
            range.deleteContents();
            range.insertNode(table);
            range.setStart(table.rows[0].cells[0], 0);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
            hide(document.getElementById("tableModal"));
            saveToStorage();
            note("تم إدراج جدول");
          },
        };

        function renderTabs() {
          el.tabsContainer.innerHTML = "";
          const tabsByParent = state.tabs.reduce((acc, tab) => {
            const parentId = tab.parentId || "root";
            if (!acc[parentId]) acc[parentId] = [];
            acc[parentId].push(tab);
            return acc;
          }, {});

          const renderLevel = (tabs, level) => {
            tabs.forEach((t) => {
              const children = tabsByParent[t.id] || [];
              const hasChildren = children.length > 0;

              const b = document.createElement("button");
              b.className =
                "tab " + (t.id === state.activeTabId ? "active" : "");
              b.type = "button";
              b.dataset.tabId = t.id;
              b.draggable = true;
              b.style.paddingRight = `${15 + level * 20}px`;

              let toggleIcon = "";
              if (hasChildren) {
                toggleIcon = `<span class="tab-toggle" onclick="event.stopPropagation(); UI.toggleTabCollapse('${
                  t.id
                }')">${t.isCollapsed ? "▶" : "▼"}</span>`;
              } else {
                toggleIcon = `<span class="tab-toggle"></span>`; // for alignment
              }

              const prefix = level > 0 ? " " : "";
              b.innerHTML = `
                <div class="tab-title-wrapper">
                    ${toggleIcon}
                    <span>${prefix}${esc(t.title)}</span>
                </div>
                <div class="tab-actions">
                    <button class="tab-btn" title="إضافة تبويب فرعي" onclick="event.stopPropagation(); UI.addTab('${
                      t.id
                    }')">+</button>
                    <button class="tab-btn" title="تعديل" onclick="event.stopPropagation(); UI.renameTab('${
                      t.id
                    }')">✎</button>
                    <button class="tab-btn" title="نسخ" onclick="event.stopPropagation(); UI.duplicateTab('${
                      t.id
                    }')">⧉</button>
                </div>`;

              b.onclick = () => UI.setActiveTab(t.id);
              el.tabsContainer.appendChild(b);

              if (hasChildren && !t.isCollapsed) {
                renderLevel(children, level + 1);
              }
            });
          };
          renderLevel(tabsByParent["root"] || [], 0);
          enableDragAndDrop();
        }
        function closest(tag, node) {
          while (node && node.nodeType === 1) {
            if (node.tagName === tag) return node;
            node = node.parentElement;
          }
          return null;
        }
        function unwrapAnchor(a) {
          const p = a.parentNode;
          while (a.firstChild) p.insertBefore(a.firstChild, a);
          p.removeChild(a);
        }
        function wrapWithLink(node, url, newTab) {
          const a = document.createElement("a");
          a.href = url;
          if (newTab) {
            a.target = "_blank";
            a.rel = "noopener noreferrer";
          }
          node.parentNode.insertBefore(a, node);
          a.appendChild(node);
        }

        function buildTableMap(table) {
          const map = [];
          const rows = table.rows;
          for (let i = 0; i < rows.length; i++) {
            if (!map[i]) map[i] = [];
          }

          for (let r = 0; r < rows.length; r++) {
            for (let c = 0; c < rows[r].cells.length; c++) {
              const cell = rows[r].cells[c];
              let map_c = 0;
              while (map[r][map_c]) {
                map_c++;
              }
              for (let i = 0; i < cell.rowSpan; i++) {
                for (let j = 0; j < cell.colSpan; j++) {
                  if (!map[r + i]) map[r + i] = [];
                  map[r + i][map_c + j] = cell;
                }
              }
            }
          }
          return map;
        }

        function getCoordsOfCell(cell, map) {
          for (let r = 0; r < map.length; r++) {
            for (let c = 0; c < (map[r] || []).length; c++) {
              if (map[r][c] === cell) return { r, c };
            }
          }
          return null;
        }

        function buildToc(tabs, forExport = false) {
          const tocFragment = document.createDocumentFragment();
          const tabsByParent = tabs.reduce((acc, tab) => {
            const parentId = tab.parentId || "root";
            if (!acc[parentId]) acc[parentId] = [];
            acc[parentId].push(tab);
            return acc;
          }, {});

          const createLink = (tab) => {
            const link = document.createElement("a");
            link.href = "#tab-" + tab.id;
            link.textContent = tab.title;
            if (!forExport) {
              link.onclick = (e) => (e.preventDefault(), UI.showTab(tab.id));
            }
            return link;
          };

          const buildLevel = (levelTabs, container) => {
            if (!levelTabs) return;
            levelTabs.forEach((tab) => {
              container.appendChild(createLink(tab));
              const children = tabsByParent[tab.id];
              if (children && children.length > 0) {
                const subContainer = document.createElement("div");
                subContainer.style.paddingRight = "20px";
                buildLevel(children, subContainer);
                container.appendChild(subContainer);
              }
            });
          };

          buildLevel(tabsByParent["root"], tocFragment);
          return tocFragment;
        }

        function getFileType(name) {
          const ext = (name.split(".").pop() || "").toLowerCase();
          if (["jpg", "jpeg", "png", "gif", "webp", "bmp"].includes(ext))
            return "image";
          if (["mp4", "webm", "ogg", "mov", "avi"].includes(ext))
            return "video";
          if (ext === "pdf") return "pdf";
          if (["doc", "docx"].includes(ext)) return "word";
          if (["xls", "xlsx"].includes(ext)) return "excel";
          if (["ppt", "pptx"].includes(ext)) return "powerpoint";
          return "other";
        }
        function office(url) {
          return (
            "https://view.officeapps.live.com/op/embed.aspx?src=" +
            encodeURIComponent(url)
          );
        }

        function makeEmbedHTML({
          fType,
          src,
          name,
          caption,
          downloadHref,
          origin,
        }) {
          const eid = id();
          let inner = "";
          const useIframeForMedia =
            origin === "gdrive" &&
            (fType === "video" || fType === "image" || fType === "auto");

          if (fType === "image" && !useIframeForMedia) {
            inner = `<div class="embed-media resizable-x" style="width:100%">
                     <img src="${src}" alt="${esc(caption || name || "صورة")}"/>
                   </div>`;
          } else if (fType === "video" && !useIframeForMedia) {
            inner = `<div class="embed-media resizable-both" style="width:100%;height:360px">
                     <video src="${src}" controls></video>
                   </div>`;
          } else if (
            useIframeForMedia ||
            fType === "pdf" ||
            ["word", "excel", "powerpoint"].includes(fType)
          ) {
            const height = useIframeForMedia ? "420px" : "500px";
            inner = `<div class="embed-media resizable-both" style="width:100%;height:${height}">
                     <iframe src="${src}" allow="autoplay; fullscreen" style="border:0;"></iframe>
                   </div>`;
          } else {
            inner = `<div class="embed-media resizable-x" style="width:100%">
                     <p><strong>${esc(
                       caption || name || "ملف مرفق"
                     )}</strong></p>
                   </div>`;
          }
          const d = downloadHref
            ? `<a href="${downloadHref}" download class="download-link">تحميل</a>`
            : "";

          const captionEl = `<figcaption class="embed-caption" contenteditable="true" data-placeholder="وصف (اختياري)...">${esc(
            caption
          )}</figcaption>`;

          return `<div class="embed-container" contenteditable="false" draggable="false" data-embed-id="${eid}" data-type="${fType}" data-origin="${
            origin || ""
          }" data-name="${esc(name || "")}">
                         ${inner}
                         ${captionEl}
                         ${d}
                       </div>`;
        }

        function upgradeEmbeds(scope) {
          scope.querySelectorAll(".embed-container").forEach((c) => {
            if (!c.querySelector(".embed-actions")) {
              const bar = document.createElement("div");
              bar.className = "embed-actions";
              bar.innerHTML = `
              <button class="embed-btn" type="button" data-action="edit">✎</button>
              <button class="embed-btn" type="button" data-action="replace">🔁</button>
              <button class="embed-btn" type="button" data-action="link">🔗</button>
              <button class="embed-btn" type="button" data-action="unlink">⛓️</button>
              <button class="embed-btn" type="button" data-action="smaller">−</button>
              <button class="embed-btn" type="button" data-action="bigger">+</button>
              <button class="embed-btn" type="button" data-action="fit">100%</button>
              <button class="embed-btn" type="button" data-action="setwidth">↔</button>
              <button class="embed-btn" type="button" data-action="setheight">↕</button>
              <button class="embed-btn" type="button" data-action="remove">🗑</button>`;
              c.insertBefore(bar, c.firstChild);
            }
            if (!c.querySelector(".embed-media")) {
              const m = c.querySelector("img,video,iframe");
              if (m) {
                const wrap = document.createElement("div");
                const isImg = m.tagName === "IMG";
                wrap.className =
                  "embed-media " + (isImg ? "resizable-x" : "resizable-both");
                wrap.style.width = "100%";
                m.style.width = "100%";
                m.style.height = isImg ? "auto" : "100%";
                m.parentNode.insertBefore(wrap, m); // <— تصحيح
                wrap.appendChild(m);
              }
            }
            c.setAttribute("draggable", "false");
            c.querySelectorAll("img,video,iframe").forEach((el) =>
              el.setAttribute("draggable", "false")
            );

            c.setAttribute("contenteditable", "false");
          });
        }

        function insertMediaImpl() {
          const caption = (
            document.getElementById("mediaCaption").value || ""
          ).trim();
          let html = "";
          if (state.mediaType === "upload") {
            const inp = document.getElementById("mediaFile");
            if (!inp.files || !inp.files[0]) return note("اختر ملفًا", "error");
            const f = inp.files[0];
            const t = getFileType(f.name || "");
            const url = URL.createObjectURL(f);
            const useType = ["image", "video", "pdf"].includes(t) ? t : "other";
            html = makeEmbedHTML({
              fType: useType,
              src: url,
              name: f.name,
              caption,
              downloadHref: url,
              origin: "upload",
            });
          } else if (state.mediaType === "url") {
            const url = (
              document.getElementById("mediaUrl").value || ""
            ).trim();
            if (!url) return note("أدخل الرابط", "error");

            let t = document.getElementById("fileType").value;
            if (t === "auto") {
              const fake = url.split("?")[0].split("#")[0];
              t = getFileType(fake);
            }

            let preview = url;
            if (["word", "excel", "powerpoint"].includes(t))
              preview = office(url);

            html = makeEmbedHTML({
              fType: t,
              src: preview,
              name: url.split("/").pop(),
              caption: caption, // أو اتركها caption فقط إن أردت الاختصار
              downloadHref: url, // ← كانت خطأ: downloadHref=url
              origin: "url",
            });
          } else if (state.mediaType === "gdrive") {
            const shareUrl = (
              document.getElementById("gdriveUrl").value || ""
            ).trim();
            if (!shareUrl)
              return note("أدخل رابط المشاركة من جوجل درايف", "error");

            let match = shareUrl.match(/\/d\/([a-zA-Z0-9_-]{25,})/);
            if (!match) {
              match = shareUrl.match(/id=([a-zA-Z0-9_-]{25,})/);
            }

            if (!match || !match[1]) {
              return note(
                "رابط جوجل درايف غير صالح. تأكد من أنه رابط مشاركة ملف.",
                "error"
              );
            }
            const fileId = match[1];
            const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;

            let t = document.getElementById("gdriveFileType").value;
            let fType = t;
            let previewSrc;

            const isGoogleDoc = /docs\.google\.com\/document/i.test(shareUrl);
            const isGoogleSheet = /docs\.google\.com\/spreadsheets/i.test(
              shareUrl
            );
            const isGoogleSlide = /docs\.google\.com\/presentation/i.test(
              shareUrl
            );

            if (isGoogleDoc || t === "word") {
              previewSrc = `https://docs.google.com/document/d/${fileId}/preview`;
              fType = "word";
            } else if (isGoogleSheet || t === "excel") {
              previewSrc = `https://docs.google.com/spreadsheets/d/${fileId}/preview`;
              fType = "excel";
            } else if (isGoogleSlide || t === "powerpoint") {
              previewSrc = `https://docs.google.com/presentation/d/${fileId}/embed?start=false&loop=false&delayms=3000`;
              fType = "powerpoint";
            } else if (t !== "other") {
              // This handles 'auto', 'image', 'video', 'pdf'
              previewSrc = `https://drive.google.com/file/d/${fileId}/preview`;
            } else {
              // This is for 'other'
              previewSrc = "";
            }

            html = makeEmbedHTML({
              fType: fType,
              src: previewSrc,
              name: "ملف من Google Drive",
              caption: caption,
              downloadHref: downloadUrl,
              origin: "gdrive",
            });
          }

          restoreSel();
          ensureRangeInEditor();
          const sel = window.getSelection();
          if (sel && sel.rangeCount > 0) {
            const r = sel.getRangeAt(0);
            const frag = r.createContextualFragment(html);
            r.deleteContents();
            r.insertNode(frag);
            r.collapse(false);
            sel.removeAllRanges();
            sel.addRange(r);
          } else {
            el.editor.insertAdjacentHTML("beforeend", html);
          }
          hide(document.getElementById("mediaModal"));
          note("تم الإدراج");
          upgradeEmbeds(el.editor);
          saveToStorage();
        }

        function confirmLinkImpl() {
          const raw = document.getElementById("linkUrl").value || "";
          const url = sanitizeUrl(raw);
          if (!url) return note("أدخل رابطًا صحيحًا", "error");
          const newTab = document.getElementById("linkNewTab").checked;
          if (state.linkContext) {
            const media = state.linkContext;
            const existing = closest("A", media.parentElement);
            if (existing) {
              existing.setAttribute("href", url);
              if (newTab) {
                existing.setAttribute("target", "_blank");
                existing.setAttribute("rel", "noopener noreferrer");
              } else {
                existing.removeAttribute("target");
                existing.removeAttribute("rel");
              }
            } else {
              wrapWithLink(media, url, newTab);
            }
            state.linkContext = null;
            UI.hide(document.getElementById("linkModal"));
            saveToStorage();
            return note("تم ربط الوسائط");
          }
          restoreSel();
          const sel = window.getSelection();
          if (sel && !sel.isCollapsed) {
            const r = sel.getRangeAt(0);
            const a = document.createElement("a");
            a.href = url;
            if (newTab) {
              a.target = "_blank";
              a.rel = "noopener noreferrer";
            }
            const contents = r.extractContents();
            a.appendChild(contents);
            r.insertNode(a);
            r.selectNodeContents(a);
            sel.removeAllRanges();
            sel.addRange(r);
            UI.hide(document.getElementById("linkModal"));
            saveToStorage();
            return note("تم إنشاء الرابط");
          }
          note("حدّدي نصًا أو استخدمي زر 🔗 على الوسائط", "error");
        }

        function exportProject() {
          const a = state.tabs.find((x) => x.id === state.activeTabId);
          if (a) a.content = el.editor.innerHTML;
          const data = {
            version: "3.6",
            exportDate: new Date().toISOString(),
            tabs: state.tabs,
            settings: state.settings,
            portfolio: state.portfolio,
          };
          const uri =
            "data:application/json;charset=utf-8," +
            encodeURIComponent(JSON.stringify(data, null, 2));
          const link = document.createElement("a");
          link.href = uri;
          link.download = "ملف_الإنجاز_v3_6.json";
          link.click();
          note("تم التصدير");
        }
        function importProject() {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = ".json";
          input.onchange = (e) => {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = (v) => {
              try {
                const d = JSON.parse(v.target.result);
                if (d.tabs && Array.isArray(d.tabs)) {
                  state.tabs = d.tabs;
                  state.settings = d.settings || state.settings;
                  state.portfolio = d.portfolio || state.portfolio;
                  applySettings();
                  const eb = document.getElementById("editorBgPicker");
                  if (eb) eb.value = state.settings.editorBg || "#ffffff";
                  const pb = document.getElementById("pageBgPicker");
                  if (pb) pb.value = state.settings.pageBg || "#f5f7fb";
                  UI.setActiveTab(state.tabs[0].id);
                  note("تم الاستيراد");
                } else note("ملف غير صالح", "error");
              } catch (err) {
                note("خطأ في قراءة الملف", "error");
              }
            };
            r.readAsText(f);
          };
          input.click();
        }
        function previewPortfolio() {
          const a = state.tabs.find((x) => x.id === state.activeTabId);
          if (a) a.content = el.editor.innerHTML;
          document.getElementById("portfolioHeaderTitle").textContent =
            (state.portfolio && state.portfolio.title) || "ملف الإنجاز";
          UI.refreshPortfolioHeaderFooter();
          UI.buildPortfolioSidebar(); // يبني إعدادات الغلاف + عنوان الفهرس
          const tocFragment = buildToc(state.tabs, false);
          el.portfolioSidebar.appendChild(tocFragment);

          el.portfolioContent.innerHTML = "";
          state.tabs.forEach((t) => {
            const w = document.createElement("div");
            w.className = "tab-content";
            w.id = "tab-" + t.id;
            const h2 = document.createElement("h2");
            h2.textContent = t.title;
            h2.style.cssText =
              "color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px;";

            const body = document.createElement("div");
            body.innerHTML = t.content;
            body.querySelectorAll(".embed-actions").forEach((x) => x.remove());
            w.appendChild(h2);
            w.appendChild(body);
            el.portfolioContent.appendChild(w);
          });
          const f = document.createElement("div");
          f.className = "portfolio-footer";
          f.id = "portfolioFooterBlock";
          f.setAttribute("contenteditable", "true");
          f.textContent = (state.portfolio && state.portfolio.footerText) || "";
          f.addEventListener("input", () => {
            state.portfolio.footerText = f.textContent || "";
            saveToStorage();
          });
          el.portfolioContent.appendChild(f);
          el.finalPortfolio.style.display = "block";
          if (state.tabs.length > 0) UI.showTab(state.tabs[0].id);
        }
        // تنقّل بين أقسام المعاينة
        function showTab(tabId) {
          document.querySelectorAll(".tab-content").forEach((sec) => {
            const isActive = sec.id === "tab-" + tabId;
            sec.classList.toggle("active", isActive);
            sec.style.display = isActive ? "block" : "none";
          });

          const sb = document.getElementById("portfolioSidebar");
          if (sb) {
            [...sb.querySelectorAll("a[href^='#tab-']")].forEach((a) => {
              a.classList.toggle(
                "active",
                a.getAttribute("href") === "#tab-" + tabId
              );
            });
          }
          document
            .querySelector(".portfolio-content")
            ?.scrollTo({ top: 0, behavior: "smooth" });
        }

        function exportPDF() {
          UI.previewPortfolio();
          setTimeout(() => {
            window.print();
          }, 400);
        }

        // ==== (B) تصدير صفحة واحدة (HTML) ====
        UI.exportHTML = async function () {
          try {
            // احفظ محتوى التبويب الحالي
            var active = state.tabs.find(function (x) {
              return x.id === state.activeTabId;
            });
            if (active) active.content = el.editor.innerHTML;

            // مساعد: blob/http -> dataURL
            async function toDataURL(url) {
              try {
                var res = await fetch(url);
                var blob = await res.blob();
                return await new Promise(function (resolve) {
                  var fr = new FileReader();
                  fr.onload = function () {
                    resolve(fr.result);
                  };
                  fr.readAsDataURL(blob);
                });
              } catch (e) {
                return url; // fallback
              }
            }

            // ابنِ الـ DOM النهائي مشابه للمعاينة
            var container = document.createElement("div");

            // رأس
            var header = document.createElement("div");
            header.className = "portfolio-header";
            header.innerHTML =
              '<div class="portfolio-header-inner" dir="rtl">' +
              '<img id="expLogo" class="portfolio-logo" alt="شعار"/>' +
              '<div class="portfolio-titles">' +
              '<h1 id="expTitle"></h1>' +
              '<div id="expSubtitle" class="portfolio-subtitle"></div>' +
              "</div>" +
              '<div class="header-actions">' +
              '<button class="header-btn export" type="button" onclick="window.print()">طباعة</button>' +
              "</div>" +
              "</div>";
            container.appendChild(header);

            var sidebar = document.createElement("div");
            sidebar.className = "portfolio-sidebar";
            var contentRoot = document.createElement("div");
            contentRoot.className = "portfolio-content";

            // الفهرس + الأقسام
            sidebar.appendChild(buildToc(state.tabs, true));
            state.tabs.forEach(function (t) {
              var w = document.createElement("div");
              w.className = "tab-content";
              w.id = "tab-" + t.id;
              var h2 = document.createElement("h2");
              h2.textContent = t.title;
              h2.style.color = "var(--primary)";
              h2.style.borderBottom = "2px solid var(--primary)";
              h2.style.paddingBottom = "10px";
              h2.style.marginBottom = "20px";

              var body = document.createElement("div");
              body.innerHTML = t.content || "";
              var bars = body.querySelectorAll(".embed-actions");
              bars.forEach(function (x) {
                x.remove();
              });

              w.appendChild(h2);
              w.appendChild(body);
              contentRoot.appendChild(w);
            });

            // تذييل
            var f = document.createElement("div");
            f.className = "portfolio-footer";
            f.textContent =
              (state.portfolio && state.portfolio.footerText) || "";
            contentRoot.appendChild(f);

            container.appendChild(sidebar);
            container.appendChild(contentRoot);

            // عنوان/اسم/صفة/شعار
            var expTitle = container.querySelector("#expTitle");
            expTitle.textContent =
              (state.portfolio && state.portfolio.title) || "ملف الإنجاز";
            var expSubtitle = container.querySelector("#expSubtitle");
            var nm = (state.portfolio && state.portfolio.teacherName) || "";
            var label =
              (state.portfolio && state.portfolio.teacherLabel) || "المعلم/ـة";
            expSubtitle.textContent = nm ? label + " / " + nm : "";

            var expLogo = container.querySelector("#expLogo");
            var logoSrc = (state.portfolio && state.portfolio.logoData) || "";
            if (!logoSrc) {
              // أول صورة داخل التبويبات
              for (var k = 0; k < state.tabs.length; k++) {
                var tmp = document.createElement("div");
                tmp.innerHTML = state.tabs[k].content || "";
                var im = tmp.querySelector("img[src]");
                if (im) {
                  logoSrc = im.getAttribute("src");
                  break;
                }
              }
            }
            if (logoSrc) expLogo.setAttribute("src", logoSrc);

            // حوّل كل blob → dataURL
            var medias = container.querySelectorAll("img, video, iframe");
            for (var i = 0; i < medias.length; i++) {
              var m = medias[i];
              var src = m.getAttribute("src") || "";
              if (/^blob:/i.test(src)) {
                var data = await toDataURL(src);
                m.setAttribute("src", data);
              }
            }
            // روابط التحميل داخل العناصر المضمّنة
            var dlinks = container.querySelectorAll("a.download-link[href]");
            for (var j = 0; j < dlinks.length; j++) {
              var a = dlinks[j];
              var href = a.getAttribute("href") || "";
              if (/^blob:/i.test(href)) {
                var data2 = await toDataURL(href);
                a.setAttribute("href", data2);
              }
              if (!/^#/.test(a.getAttribute("href") || "")) {
                a.setAttribute("target", "_blank");
                a.setAttribute("rel", "noopener noreferrer");
              }
            }
            // اضبط بقية الروابط الخارجية
            var anchors = container.querySelectorAll("a[href]");
            anchors.forEach(function (a) {
              var href = a.getAttribute("href") || "";
              if (!/^#/.test(href)) {
                a.setAttribute("target", "_blank");
                a.setAttribute("rel", "noopener noreferrer");
              }
            });

            // CSS الحالي (يتضمن قواعد الطباعة)
            var css = Array.prototype.map
              .call(document.querySelectorAll("style"), function (s) {
                return s.innerHTML;
              })
              .join("\n");
            // سكربت صغير لتفعيل تبويب واحد مرئي + تمييز الفهرس
            var navScript = [
              "(function(){" +
                " function setActive(id){" +
                "  document.querySelectorAll('.tab-content').forEach(function(s){ s.style.display='none'; s.classList.remove('active'); });" +
                "  var el=document.getElementById(id); if(el){ el.style.display='block'; el.classList.add('active'); }" +
                "  document.querySelectorAll('.portfolio-sidebar a').forEach(function(a){ a.classList.remove('active'); if((a.getAttribute('href')||'')==='#'+id) a.classList.add('active'); });" +
                " }" +
                " document.addEventListener('DOMContentLoaded', function(){" +
                "  document.querySelectorAll('.portfolio-sidebar a[href^=\"#tab-\"]').forEach(function(a){ a.addEventListener('click', function(e){ e.preventDefault(); var id=(this.getAttribute('href')||'').slice(1); setActive(id); }); });" +
                "  var firstTab = document.querySelector('.portfolio-sidebar a');" +
                "  if(firstTab){ setActive((firstTab.getAttribute('href')||'').slice(1)); }" +
                " });" +
                "})();",
            ].join("");

            var html =
              '<!DOCTYPE html><html lang="ar" dir="rtl"><head>' +
              '<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>' +
              "<title>" +
              (state.portfolio && state.portfolio.title
                ? state.portfolio.title
                : "ملف الإنجاز") +
              "</title>" +
              "<style>" +
              css +
              "</style></head><body>" +
              container.innerHTML +
              "<script>" +
              navScript.replace(/<\/script>/gi, "<\\/script>") +
              "<\/script>" +
              "</body></html>";

            var blob = new Blob([html], { type: "text/html;charset=utf-8" });
            var url = URL.createObjectURL(blob);
            var ael = document.createElement("a");
            ael.href = url;
            ael.download = "ملف_الإنجاز_صفحة_واحدة.html";
            ael.click();
            setTimeout(function () {
              URL.revokeObjectURL(url);
            }, 1500);
            UI.note("تم تصدير صفحة واحدة بنجاح");
          } catch (err) {
            UI.note("تعذّر تصدير HTML", "error");
          }
        };

        function enableDragAndDrop() {
          const container = el.tabsContainer;
          let draggedId = null;
          let dropIndicator = document.getElementById("dropIndicator");
          if (!dropIndicator) {
            dropIndicator = document.createElement("div");
            dropIndicator.id = "dropIndicator";
            dropIndicator.className = "drop-indicator";
            container.appendChild(dropIndicator);
          }

          container.ondragstart = (e) => {
            const target = e.target.closest(".tab");
            if (!target) return;
            draggedId = target.dataset.tabId;
            e.dataTransfer.setData("text/plain", draggedId);
            e.dataTransfer.effectAllowed = "move";
            setTimeout(() => target.classList.add("dragging"), 0);
          };

          container.ondragover = (e) => {
            e.preventDefault();
            const target = e.target.closest(".tab");
            if (!target || target.dataset.tabId === draggedId) {
              return;
            }

            const rect = target.getBoundingClientRect();
            const offset = e.clientY - rect.top;
            const zoneHeight = rect.height / 3;

            dropIndicator.style.display = "block";
            target.classList.remove("drop-parent");

            if (offset < zoneHeight) {
              // Drop Before
              dropIndicator.style.top = target.offsetTop + "px";
              target.dataset.dropZone = "before";
            } else if (offset > rect.height - zoneHeight) {
              // Drop After
              dropIndicator.style.top = target.offsetTop + rect.height + "px";
              target.dataset.dropZone = "after";
            } else {
              // Drop Inside
              dropIndicator.style.display = "none";
              target.classList.add("drop-parent");
              target.dataset.dropZone = "inside";
            }
          };

          container.ondragleave = (e) => {
            const target = e.target.closest(".tab");
            if (target) {
              target.classList.remove("drop-parent");
              target.removeAttribute("data-drop-zone");
            }
          };

          container.ondrop = (e) => {
            e.preventDefault();
            if (!draggedId) return;

            const targetEl = e.target.closest(".tab");
            if (!targetEl) return;

            const targetId = targetEl.dataset.tabId;
            const dropZone = targetEl.dataset.dropZone;

            const draggedTab = state.tabs.find((t) => t.id === draggedId);
            const targetTab = state.tabs.find((t) => t.id === targetId);
            if (!draggedTab || !targetTab || draggedId === targetId) return;

            // Prevent dropping a tab into its own descendant
            const isDescendant = (childId, parentId) => {
              // A tab cannot be a descendant of itself.
              if (childId === parentId) return true;

              // Create a map for O(1) lookups, which is more efficient and safer.
              const tabMap = new Map(state.tabs.map((t) => [t.id, t]));

              let currentTab = tabMap.get(childId);

              // Traverse up the hierarchy from the child.
              // The loop counter is a safeguard against infinite loops from corrupted data.
              for (let i = 0; i < state.tabs.length && currentTab; i++) {
                // If we find the parentId in the ancestry, then it's a descendant.
                if (currentTab.parentId === parentId) {
                  return true;
                }

                // Move up to the parent for the next iteration.
                currentTab = tabMap.get(currentTab.parentId);
              }

              // If the loop completes without finding the parent, it's not a descendant.
              return false;
            };
            if (dropZone === "inside" && isDescendant(targetId, draggedId)) {
              return note("لا يمكن نقل تبويب إلى أحد فروعه", "error");
            }

            const draggedIndex = state.tabs.findIndex(
              (t) => t.id === draggedId
            );
            const [movedTab] = state.tabs.splice(draggedIndex, 1);

            if (dropZone === "inside") {
              movedTab.parentId = targetId;
              state.tabs.push(movedTab); // Add to end to become last child
            } else {
              movedTab.parentId = targetTab.parentId;
              const newTargetIndex = state.tabs.findIndex(
                (t) => t.id === targetId
              );
              state.tabs.splice(
                newTargetIndex + (dropZone === "after" ? 1 : 0),
                0,
                movedTab
              );
            }

            renderTabs();
            saveToStorage();
          };

          container.ondragend = (e) => {
            draggedId = null;
            dropIndicator.style.display = "none";
            document
              .querySelectorAll(".tab.dragging, .tab.drop-parent")
              .forEach((el) => el.classList.remove("dragging", "drop-parent"));
          };
        }

        (function init() {
          applySettings();
          const eb = document.getElementById("editorBgPicker");
          if (eb) eb.value = state.settings.editorBg || "#ffffff";
          const pb = document.getElementById("pageBgPicker");
          if (pb) pb.value = state.settings.pageBg || "#f5f7fb";
          const loadedId = loadFromStorage();
          renderTabs();
          UI.setActiveTab(
            loadedId && state.tabs.find((t) => t.id === loadedId)
              ? loadedId
              : state.tabs[0].id
          );

          ["mouseup", "keyup", "touchend"].forEach((ev) =>
            el.editor.addEventListener(ev, saveSel)
          );

          el.editor.addEventListener("mouseup", (e) => {
            if (e.target.closest("#formatPainterBtn")) return;
            if (state.formatPainterActive) {
              const sel = window.getSelection();
              if (sel && !sel.isCollapsed) {
                setTimeout(() => {
                  if (state.formatPainterActive) UI.applyCopiedFormat();
                }, 50);
              }
            }
          });

          // لا تمنع الافتراضي حتى يصل click للأزرار
          el.editor.addEventListener(
            "mousedown",
            (e) => {
              if (e.target && e.target.closest(".embed-actions"))
                e.stopPropagation();
            },
            true
          );

          // تفويض النقر على أزرار شريط الوسائط
          el.editor.addEventListener(
            "click",
            (e) => {
              const btn = e.target.closest(".embed-actions .embed-btn");
              if (!btn) return;
              e.preventDefault();
              e.stopPropagation();
              const action = btn.dataset.action;
              if (action) UI.embedAction(btn, action);
            },
            true
          );

          document
            .getElementById("mediaFile")
            .addEventListener("change", (e) => {
              el.filePreview.innerHTML = "";
              el.filePreview.style.display = "block";
              if (!e.target.files || !e.target.files[0]) return;
              el.filePreview.textContent = e.target.files[0].name;
            });

          el.editor.addEventListener("input", () => {
            const a = state.tabs.find((x) => x.id === state.activeTabId);
            if (a) a.content = el.editor.innerHTML;
            saveToStorage();
          });

          /* ===== لصق: ذكي أو نصي ===== */
          el.editor.addEventListener("paste", (e) => {
            e.preventDefault();
            const html =
              (e.clipboardData && e.clipboardData.getData("text/html")) || "";
            const txt =
              (e.clipboardData && e.clipboardData.getData("text/plain")) || "";
            let toInsert = "";
            if (state.pasteMode === "plain") {
              toInsert = esc(txt).replace(/\r?\n/g, "<br>");
            } else {
              if (html) {
                if (
                  /<table[\s\S]*?>/i.test(html) ||
                  /class="?Mso|mso-/i.test(html)
                ) {
                  toInsert = sanitizeTablesHTML(html);
                } else {
                  toInsert = sanitizeHTMLBasic(html);
                }
              } else {
                toInsert = esc(txt).replace(/\r?\n/g, "<br>");
              }
            }
            ensureRangeInEditor();
            const sel = window.getSelection();
            if (sel && sel.rangeCount > 0) {
              const r = sel.getRangeAt(0);
              const frag = r.createContextualFragment(toInsert);
              r.deleteContents();
              r.insertNode(frag);
              r.collapse(false);
              sel.removeAllRanges();
              sel.addRange(r);
            }
            upgradeEmbeds(el.editor);
            saveToStorage();
            note(
              state.pasteMode === "smart" ? "تم اللصق (ذكي)" : "تم اللصق (نصي)"
            );
          });

          /* سحب وإفلات للوسائط */
          el.editor.addEventListener("dragover", (e) => e.preventDefault());
          el.editor.addEventListener("drop", (e) => {
            e.preventDefault();
            const dt = e.dataTransfer;
            if (!dt || !dt.files || !dt.files.length) return;
            const files = [...dt.files];
            ensureRangeInEditor();
            const sel = window.getSelection();
            const r = sel && sel.rangeCount > 0 ? sel.getRangeAt(0) : null;
            files.forEach((f) => {
              const t = getFileType(f.name || "");
              const url = URL.createObjectURL(f);
              const useType = ["image", "video", "pdf"].includes(t)
                ? t
                : "other";
              const html = makeEmbedHTML({
                fType: useType,
                src: url,
                name: f.name,
                caption: "",
                downloadHref: url,
                origin: "upload",
              });
              if (r) {
                const frag = r.createContextualFragment(html);
                r.insertNode(frag);
                r.collapse(false);
                sel.removeAllRanges();
                sel.addRange(r);
              } else {
                el.editor.insertAdjacentHTML("beforeend", html);
              }
            });
            upgradeEmbeds(el.editor);
            saveToStorage();
          });

          /* ===== أحداث الجداول ===== */
          document.addEventListener("selectionchange", () => {
            const td = getCellFromSelection();
            if (td) showTableToolbar(td);
            else hideTableToolbar();
          });
          el.editor.addEventListener("scroll", () => {
            if (state.currentCell) showTableToolbar(state.currentCell);
          });
          initTableResizing();

          if (el.tableToolbar) {
            el.tableToolbar.addEventListener("mousedown", (e) =>
            e.preventDefault()
          );
            el.tableToolbar.addEventListener("click", (e) => {
            const btn = e.target.closest(".tb-btn");
            if (!btn) return;
            const act = btn.getAttribute("data-act");
            const td = state.currentCell;
            if (!td) return;
            const table = td.closest("table");
            if (!table) return;
            // Simple actions that don't need the table map
            if (act.startsWith("valign-")) {
              td.style.verticalAlign = act.split("-")[1];
            } else if (act === "cell-bg-cell") {
              td.style.backgroundColor = el.cellBgPicker.value;
            } else if (act === "cell-bg-clear") {
              td.style.removeProperty("background-color");
            } else if (act === "del-table") {
              table.remove();
              hideTableToolbar();
            } else if (act === "autofit-table") {
                table.style.width = 'auto';
                table.style.tableLayout = 'auto';
                note("تم ضبط عرض الجدول تلقائياً");
            } else {
              // Complex actions that need the table map
              const map = buildTableMap(table);
              const coords = getCoordsOfCell(td, map);
              const rIndex = td.parentElement.rowIndex;

              if (act === "row-before") {
                const newRow = table.insertRow(rIndex);
                for (let i = 0; i < (map[0] || []).length; i++) newRow.insertCell();
              } else if (act === "row-after") {
                const newRow = table.insertRow(rIndex + td.rowSpan);
                for (let i = 0; i < (map[0] || []).length; i++) newRow.insertCell();
              } else if (act === "del-row") {
                table.deleteRow(rIndex);
              } else if (act === "col-before" || act === "col-after") {
                if (!coords) return;
                const addAfter = act === "col-after";
                const insertAt = coords.c + (addAfter ? td.colSpan : 0);
                for (let r = 0; r < map.length; ) {
                  const cellOnLeft = map[r][insertAt - 1];
                  if (cellOnLeft && getCoordsOfCell(cellOnLeft, map).c + cellOnLeft.colSpan > insertAt) {
                    cellOnLeft.colSpan++;
                    r += cellOnLeft.rowSpan;
                  } else {
                    const newCell = document.createElement('td');
                    const refCell = map[r][insertAt];
                    if (table.rows[r]) {
                      table.rows[r].insertBefore(newCell, refCell || null);
                    }
                    r++;
                  }
                }
              } else if (act === "del-col") {
                if (!coords) return;
                for (let r = 0; r < map.length; ) {
                  const cell = map[r][coords.c];
                  if (cell) {
                    if (cell.colSpan > 1) cell.colSpan--;
                    else cell.remove();
                    r += cell.rowSpan;
                  } else {
                    r++;
                  }
                }
              } else if (act === "toggle-header") {
                const firstRow = table.rows[0];
                if (firstRow) {
                  const isHeader = firstRow.cells[0]?.tagName === "TH";
                  [...firstRow.cells].forEach((cell) => {
                    const repl = document.createElement(isHeader ? "td" : "th");
                    repl.innerHTML = cell.innerHTML;
                    for(const attr of ['rowspan', 'colspan', 'style']) {
                        if(cell.hasAttribute(attr)) repl.setAttribute(attr, cell.getAttribute(attr));
                    }
                    cell.parentNode.replaceChild(repl, cell);
                  });
                }
              } else if (act === "merge-right") {
                const rightCell = td.nextElementSibling;
                if (rightCell && rightCell.rowSpan === td.rowSpan) {
                  const contentToMove = rightCell.innerHTML;
                  td.colSpan += rightCell.colSpan;
                  if (contentToMove.trim() && contentToMove !== "<br>") td.innerHTML += " " + contentToMove;
                  rightCell.remove();
                } else {
                  return note("لا يمكن دمج هذه الخلية يميناً", "warning");
                }
              } else if (act === "merge-down") {
                if (!coords) return;
                const belowCell = map[coords.r + td.rowSpan]?.[coords.c];
                if (belowCell && belowCell.colSpan === td.colSpan && getCoordsOfCell(belowCell, map).c === coords.c) {
                  const contentToMove = belowCell.innerHTML;
                  td.rowSpan += belowCell.rowSpan;
                  if (contentToMove.trim() && contentToMove !== "<br>") td.innerHTML += "<br>" + contentToMove;
                  belowCell.remove();
                } else {
                  return note("لا يمكن دمج هذه الخلية للأسفل", "warning");
                }
              } else if (act === "split-cell") {
                if (!coords) return;
                const colSpan = td.colSpan;
                const rowSpan = td.rowSpan;
                if (colSpan <= 1 && rowSpan <= 1) return note("الخلية غير مدمجة", "warning");
                td.colSpan = 1;
                td.rowSpan = 1;
                for (let j = 1; j < colSpan; j++) td.insertAdjacentElement("afterend", document.createElement("td"));
                for (let i = 1; i < rowSpan; i++) {
                  const targetRow = table.rows[coords.r + i];
                  if (!targetRow) continue;
                  const refCell = map[coords.r + i]?.[coords.c];
                  for (let j = 0; j < colSpan; j++) {
                    targetRow.insertBefore(document.createElement("td"), refCell || null);
                  }
                }
              } else if (act === "cell-bg-row") {
                const color = el.cellBgPicker.value;
                const tr = td.closest("tr");
                if (tr) [...tr.cells].forEach((cell) => (cell.style.backgroundColor = color));
              } else if (act === "cell-bg-col") {
                if (!coords) return;
                const color = el.cellBgPicker.value;
                const cellsToColor = new Set();
                for (let r = 0; r < map.length; r++) {
                  const cellInCol = map[r][coords.c];
                  if (cellInCol) cellsToColor.add(cellInCol);
                }
                cellsToColor.forEach((cell) => (cell.style.backgroundColor = color));
              }
            }

            // Final cleanup and save
            if (table.parentNode) {
              if (table.rows.length === 0 || (table.rows[0] && table.rows[0].cells.length === 0)) {
                table.remove();
                hideTableToolbar();
              } else if (document.body.contains(table)) {
                const newTd = table.contains(td) ? td : table.querySelector('td, th');
                if (newTd) showTableToolbar(newTd);
                else hideTableToolbar();
              }
            }

            saveToStorage();
          });

          const tblBorderWidth = document.getElementById("tblBorderWidth");
          const tblBorderColor = document.getElementById("tblBorderColor");
          const tblBorderStyle = document.getElementById("tblBorderStyle");
          const applyTableBorders = () => {
            if (!state.currentCell) return;
            const table = state.currentCell.closest("table");
            if (!table) return;

            const width = tblBorderWidth.value;
            const color = tblBorderColor.value;
            const style = tblBorderStyle.value;

            table.classList.remove("no-border");

            const cells = table.querySelectorAll("th, td");
            cells.forEach((cell) => {
              cell.style.border = `${width}px ${style} ${color}`;
            });
            saveToStorage();
          };
          if (tblBorderWidth && tblBorderColor && tblBorderStyle) {
            tblBorderWidth.addEventListener("input", applyTableBorders);
            tblBorderColor.addEventListener("input", applyTableBorders);
            tblBorderStyle.addEventListener("change", applyTableBorders);
          }
        }
        })();

        UI.closePreview = function () {
          try {
            document.getElementById("finalPortfolio").style.display = "none";
          } catch (_) {}
        };
        function initTableResizing() {
            const handle = document.createElement('div');
            handle.className = 'col-resize-handle';
            el.editorWrapper.appendChild(handle);

            let targetCol = null;
            let table = null;
            let startX = 0;
            let startWidth = 0;

            const onMouseMove = (e) => {
                if (!targetCol) return;
                const width = startWidth + (e.clientX - startX);
                if (width > 20) { // Minimum width
                    targetCol.style.width = width + 'px';
                    table.style.width = 'auto'; 
                    table.style.tableLayout = 'fixed';
                }
            };

            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                handle.classList.remove('active');
                handle.classList.remove('visible');
                targetCol = null;
                table = null;
                saveToStorage();
            };

            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                table = state.currentCell.closest('table');
                if(!table) return;
                targetCol = table.querySelector(`col[data-col-index="${handle.dataset.colIndex}"]`);
                if (!targetCol) return;

                startX = e.clientX;
                startWidth = targetCol.offsetWidth;
                handle.classList.add('active');

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            el.editor.addEventListener('mousemove', (e) => {
                if (handle.classList.contains('active')) return;
                const cell = e.target.closest('td, th');
                if (!cell) {
                    handle.classList.remove('visible');
                    return;
                }
                const rect = cell.getBoundingClientRect();
                if (Math.abs(rect.right - e.clientX) < 5) {
                    const tableRect = cell.closest('table').getBoundingClientRect();
                    const editorRect = el.editorWrapper.getBoundingClientRect();
                    const map = buildTableMap(cell.closest('table'));
                    const coords = getCoordsOfCell(cell, map);
                    if (!coords) return;
                    handle.style.left = (rect.right - editorRect.left - 3 + el.editorWrapper.scrollLeft) + 'px';
                    handle.style.top = (tableRect.top - editorRect.top + el.editorWrapper.scrollTop) + 'px';
                    handle.style.height = tableRect.height + 'px';
                    handle.dataset.colIndex = coords.c + cell.colSpan - 1;
                    handle.classList.add('visible');
                } else {
                    handle.classList.remove('visible');
                }
            });
        };
        UI.refreshPortfolioHeaderFooter = function () {
          try {
            var subtitleEl = document.getElementById("portfolioHeaderSubtitle");
            if (subtitleEl) {
              var nm = (state.portfolio && state.portfolio.teacherName) || "";
              var label =
                (state.portfolio && state.portfolio.teacherLabel) ||
                "المعلم/ـة";
              subtitleEl.textContent = nm ? label + " / " + nm : "";
            }
            var logoEl = document.getElementById("portfolioHeaderLogo");
            if (logoEl) {
              if (state.portfolio && state.portfolio.logoData) {
                logoEl.src = state.portfolio.logoData;
                logoEl.style.display = "block";
              } else {
                var found = "";
                for (var i = 0; i < state.tabs.length; i++) {
                  var t = state.tabs[i];
                  var tmp = document.createElement("div");
                  tmp.innerHTML = (t && t.content) || "";
                  var im = tmp.querySelector("img");
                  if (im && im.getAttribute("src")) {
                    found = im.getAttribute("src");
                    break;
                  }
                }
                if (found) {
                  logoEl.src = found;
                  logoEl.style.display = "block";
                } else {
                  logoEl.style.display = "none";
                }
              }
            }
            var titleEl = document.getElementById("portfolioHeaderTitle");
            if (titleEl) {
              titleEl.textContent =
                (state.portfolio && state.portfolio.title) || "ملف الإنجاز";
            }
            var fb = document.getElementById("portfolioFooterBlock");
            if (fb) {
              fb.textContent =
                (state.portfolio && state.portfolio.footerText) || "";
            }
          } catch (_) {}
        };
        UI.buildPortfolioSidebar = function () {
          try {
            el.portfolioSidebar.innerHTML = "";
            var box = document.createElement("div");
            box.innerHTML =
              "<h3 style='margin-bottom:8px'>إعدادات الغلاف</h3>" +
              "<label style='display:block;margin-bottom:4px'>الصفة</label>" +
              "<select id='pfLabel' class='form-control' style='margin-bottom:6px'><option>المعلم/ـة</option><option>المعلم</option><option>المعلمة</option></select>" +
              "<label style='display:block;margin-bottom:4px'>الاسم</label>" +
              "<input id='pfName' class='form-control' placeholder='مثال: أحمد محمد' style='margin-bottom:6px'/>" +
              "<label style='display:block;margin-bottom:4px'>الشعار (رفع)</label>" +
              "<input id='pfLogoFile' type='file' accept='.png,.jpg,.jpeg,.webp,.gif' class='form-control' style='margin-bottom:6px'/>" +
              "<div style='margin-bottom:6px'><input id='pfLogoUrl' class='form-control' placeholder='رابط الشعار (اختياري)'/></div>" +
              "<div style='display:flex;flex-direction:column;gap:6px;margin-bottom:6px'><button id='pfLogoClear' class='btn btn-secondary' type='button'>حذف الشعار</button><a id='pfLogoDownload' class='btn btn-secondary' href='#' download='logo.png' style='text-decoration:none;display:none;text-align:center'>تحميل الشعار</a></div>" +
              "<label style='display:block;margin-bottom:4px'>تذييل الصفحة</label>" +
              "<textarea id='pfFooter' class='form-control' rows='3' placeholder='نص يظهر أسفل الصفحة'></textarea>" +
              "<h3 style='margin-top:12px'>فهرس المحتويات</h3>";
            el.portfolioSidebar.appendChild(box);
            var h3s = box.querySelectorAll("h3");
            var anchor = h3s[h3s.length - 1] || null;
            var tl = document.createElement("label");
            tl.style.display = "block";
            tl.style.marginBottom = "4px";
            tl.textContent = "عنوان الملف";
            var ti = document.createElement("input");
            ti.id = "pfTitle";
            ti.className = "form-control";
            ti.placeholder = "مثال: ملف الإنجاز";
            ti.style.marginBottom = "6px";
            ti.value = (state.portfolio && state.portfolio.title) || "";
            ti.addEventListener("input", function () {
              state.portfolio = state.portfolio || {};
              state.portfolio.title = this.value || "";
              UI.refreshPortfolioHeaderFooter();
              saveToStorage();
            });
            if (anchor) {
              box.insertBefore(tl, anchor);
              box.insertBefore(ti, anchor);
            } else {
              box.appendChild(tl);
              box.appendChild(ti);
            }
            var n = document.getElementById("pfName");
            if (n)
              n.value = (state.portfolio && state.portfolio.teacherName) || "";
            var l = document.getElementById("pfLabel");
            if (l)
              l.value =
                (state.portfolio && state.portfolio.teacherLabel) ||
                "المعلم/ـة";
            var ft = document.getElementById("pfFooter");
            if (ft)
              ft.value = (state.portfolio && state.portfolio.footerText) || "";
            var dl = document.getElementById("pfLogoDownload");
            if (dl) {
              if (state.portfolio && state.portfolio.logoData) {
                dl.href = state.portfolio.logoData;
                dl.style.display = "inline-block";
              }
            }
            if (n)
              n.addEventListener(
                "input",
                UI.updatePortfolioSettingsFromSidebar
              );
            if (l)
              l.addEventListener(
                "change",
                UI.updatePortfolioSettingsFromSidebar
              );
            if (ft)
              ft.addEventListener(
                "input",
                UI.updatePortfolioSettingsFromSidebar
              );
            var f = document.getElementById("pfLogoFile");
            if (f) f.addEventListener("change", UI.setLogoFile);
            var urlIn = document.getElementById("pfLogoUrl");
            if (urlIn) {
              var applyLogoUrl = function () {
                var v = (urlIn.value || "").trim();
                if (!v) return;
                state.portfolio = state.portfolio || {};
                state.portfolio.logoData = v;
                UI.refreshPortfolioHeaderFooter();
                var d = document.getElementById("pfLogoDownload");
                if (d) {
                  d.href = state.portfolio.logoData;
                  d.style.display = "inline-flex";
                }
                saveToStorage();
              };
              urlIn.addEventListener("change", applyLogoUrl);
              urlIn.addEventListener("blur", applyLogoUrl);
              urlIn.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                  e.preventDefault();
                  applyLogoUrl();
                }
              });
              urlIn.addEventListener("paste", function () {
                setTimeout(applyLogoUrl, 0);
              });
            }
            var cb = document.getElementById("pfLogoClear");
            if (cb) cb.addEventListener("click", UI.clearLogo);
          } catch (_) {}
        };

        // ==== (C) تصدير ZIP (index.html + assets/) ====
        UI.exportZIP = async function () {
          try {
            // احفظ تبويبك
            var active = state.tabs.find(function (x) {
              return x.id === state.activeTabId;
            });
            if (active) active.content = el.editor.innerHTML;

            // تحميل JSZip إن لم يكن موجوداً
            async function ensureJSZip() {
              if (window.JSZip) return window.JSZip;
              await new Promise(function (resolve, reject) {
                var s = document.createElement("script");
                s.src =
                  "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js";
                s.onload = resolve;
                s.onerror = reject;
                document.head.appendChild(s);
              });
              return window.JSZip;
            }
            var JSZipLib = await ensureJSZip();

            // أدوات اسم الملف
            function sanitizeFilename(name) {
              name = (name || "")
                .replace(/[\\\/:*?"<>|]+/g, "_")
                .replace(/\s+/g, " ")
                .trim();
              return name || "file";
            }
            function extFromType(type) {
              var map = {
                "image/png": "png",
                "image/jpeg": "jpg",
                "image/webp": "webp",
                "image/gif": "gif",
                "image/svg+xml": "svg",
                "application/pdf": "pdf",
                "video/mp4": "mp4",
                "video/webm": "webm",
                "audio/mpeg": "mp3",
              };
              return map[type] || "";
            }
            function extFromUrl(url) {
              try {
                var u = (url || "").split("?")[0];
                var m = /\.([a-z0-9]+)$/i.exec(u);
                return m ? m[1].toLowerCase() : "";
              } catch (_) {
                return "";
              }
            }
            function nameFromUrl(url) {
              try {
                var u = (url || "").split("?")[0];
                var p = u.split("/");
                return sanitizeFilename(
                  decodeURIComponent(p[p.length - 1] || "file")
                );
              } catch (_) {
                return "file";
              }
            }
            function dataUrlToBlob(dataUrl) {
              var arr = (dataUrl || "").split(",");
              var m = arr[0].match(/:(.*?);/);
              var mime = m ? m[1] : "application/octet-stream";
              var bstr = atob(arr[1] || "");
              var u8 = new Uint8Array(bstr.length);
              for (var i = 0; i < bstr.length; i++) u8[i] = bstr.charCodeAt(i);
              return new Blob([u8], { type: mime });
            }
            async function blobFromUrl(url) {
              var res = await fetch(url);
              if (!res.ok) throw new Error("fetch failed");
              return await res.blob();
            }

            // ابنِ الـ DOM النهائي
            var container = document.createElement("div");
            var header = document.createElement("div");
            header.className = "portfolio-header";
            header.innerHTML =
              '<div class="portfolio-header-inner" dir="rtl">' +
              '<img id="expLogo" class="portfolio-logo" alt="الشعار"/>' +
              '<div class="portfolio-titles"><h1 id="expTitle"></h1><div id="expSubtitle" class="portfolio-subtitle"></div></div>' +
              "</div>";
            container.appendChild(header);

            var sidebar = document.createElement("div");
            sidebar.className = "portfolio-sidebar";
            sidebar.id = "expSidebar";
            var contentRoot = document.createElement("div");
            contentRoot.className = "portfolio-content";
            contentRoot.id = "expContent";

            sidebar.appendChild(buildToc(state.tabs, true));
            state.tabs.forEach(function (t) {
              var w = document.createElement("div");
              w.className = "tab-content";
              w.id = "tab-" + t.id;
              var h2 = document.createElement("h2");
              h2.textContent = t.title;
              h2.style.color = "var(--primary)";
              h2.style.borderBottom = "2px solid var(--primary)";
              h2.style.paddingBottom = "10px";
              h2.style.marginBottom = "20px";

              var body = document.createElement("div");
              body.innerHTML = t.content || "";
              var bars = body.querySelectorAll(".embed-actions");
              bars.forEach(function (x) {
                x.remove();
              });

              w.appendChild(h2);
              w.appendChild(body);
              contentRoot.appendChild(w);
            });

            var f = document.createElement("div");
            f.className = "portfolio-footer";
            f.id = "portfolioFooterBlock";
            f.textContent =
              (state.portfolio && state.portfolio.footerText) || "";
            contentRoot.appendChild(f);

            container.appendChild(sidebar);
            container.appendChild(contentRoot);

            // العنوان/الصفة/الاسم/الشعار
            var expTitle = container.querySelector("#expTitle");
            expTitle.textContent =
              (state.portfolio && state.portfolio.title) || "ملف الإنجاز";
            var expSubtitle = container.querySelector("#expSubtitle");
            var nm = (state.portfolio && state.portfolio.teacherName) || "";
            var label =
              (state.portfolio && state.portfolio.teacherLabel) || "المعلم/ـة";
            expSubtitle.textContent = nm ? label + " / " + nm : "";

            var expLogo = container.querySelector("#expLogo");
            var logoSrc = (state.portfolio && state.portfolio.logoData) || "";
            if (!logoSrc) {
              for (var k = 0; k < state.tabs.length; k++) {
                var tmp = document.createElement("div");
                tmp.innerHTML = state.tabs[k].content || "";
                var im = tmp.querySelector("img[src]");
                if (im) {
                  logoSrc = im.getAttribute("src");
                  break;
                }
              }
            }
            if (logoSrc) expLogo.setAttribute("src", logoSrc);

            // اجمع الأصول واكتبها في assets/
            var usedNames = {};
            function uniqueName(base) {
              base = sanitizeFilename(base || "file");
              var name = base,
                i = 2;
              while (usedNames[name]) {
                var dot = base.lastIndexOf(".");
                name =
                  dot > 0
                    ? base.slice(0, dot) + "-" + i + base.slice(dot)
                    : base + "-" + i;
                i++;
              }
              usedNames[name] = true;
              return name;
            }
            var assets = []; // {name, blob}
            async function addAssetFrom(url, preferName, element, attr) {
              try {
                if (!url) return null;
                var blob = null;
                if (/^data:/i.test(url)) blob = dataUrlToBlob(url);
                else if (/^blob:/i.test(url)) {
                  try {
                    blob = await blobFromUrl(url);
                  } catch (_) {
                    blob = null;
                  }
                } else if (/^https?:/i.test(url)) {
                  try {
                    blob = await blobFromUrl(url);
                  } catch (_) {
                    blob = null;
                  } // قد تفشل CORS، لا بأس
                } else {
                  return null;
                }
                if (!blob) return null;
                var baseName = sanitizeFilename(preferName || nameFromUrl(url));
                if (!/\.[a-z0-9]+$/i.test(baseName)) {
                  var ext = extFromType(blob.type) || extFromUrl(url) || "bin";
                  baseName = baseName + "." + ext;
                }
                var finalName = uniqueName(baseName);
                assets.push({ name: finalName, blob: blob });
                if (element && attr)
                  element.setAttribute(attr, "assets/" + finalName);
                return finalName;
              } catch (_) {
                return null;
              }
            }

            // الشعار
            if (expLogo) {
              var ls = expLogo.getAttribute("src") || "";
              if (ls) {
                await addAssetFrom(ls, "logo", expLogo, "src");
              }
            }

            // الوسائط
            var mediaNodes = container.querySelectorAll(
              ".embed-container .embed-media img, .embed-container .embed-media video, .embed-container .embed-media iframe"
            );
            for (var i = 0; i < mediaNodes.length; i++) {
              var m = mediaNodes[i];
              var src = m.getAttribute("src") || "";
              var prefer =
                (m.closest(".embed-container") &&
                  m.closest(".embed-container").getAttribute("data-name")) ||
                "";
              await addAssetFrom(src, prefer, m, "src");
            }
            // روابط التحميل المضمّنة
            var dlinks = container.querySelectorAll(
              ".embed-container a.download-link[href]"
            );
            for (var j = 0; j < dlinks.length; j++) {
              var a = dlinks[j];
              var href = a.getAttribute("href") || "";
              var prefer =
                a.getAttribute("download") ||
                (a.closest(".embed-container")
                  ? a.closest(".embed-container").getAttribute("data-name")
                  : "");
              var nm2 = await addAssetFrom(href, prefer, a, "href");
              if (nm2) {
                a.removeAttribute("download");
                a.setAttribute("target", "_blank");
                a.setAttribute("rel", "noopener noreferrer");
              }
            }
            // بقية الروابط
            var anchors = container.querySelectorAll("a[href]");
            anchors.forEach(function (a) {
              var href = a.getAttribute("href") || "";
              if (!/^#/.test(href)) {
                a.setAttribute("target", "_blank");
                a.setAttribute("rel", "noopener noreferrer");
              }
            });

            // CSS + سكربت التنقّل
            var css = Array.prototype.map
              .call(document.querySelectorAll("style"), function (s) {
                return s.innerHTML;
              })
              .join("\n");
            var navScript = [
              "(function(){" +
                " function setActive(id){" +
                "  document.querySelectorAll('.tab-content').forEach(function(s){ s.style.display='none'; s.classList.remove('active'); });" +
                "  var el=document.getElementById(id); if(el){ el.style.display='block'; el.classList.add('active'); }" +
                "  document.querySelectorAll('.portfolio-sidebar a').forEach(function(a){ a.classList.remove('active'); if((a.getAttribute('href')||'')==='#'+id) a.classList.add('active'); });" +
                " }" +
                " document.addEventListener('DOMContentLoaded', function(){" +
                "  document.querySelectorAll('.portfolio-sidebar a[href^=\"#tab-\"]').forEach(function(a){ a.addEventListener('click', function(e){ e.preventDefault(); var id=(this.getAttribute('href')||'').slice(1); setActive(id); }); });" +
                "  var firstTab = document.querySelector('.portfolio-sidebar a');" +
                "  if(firstTab){ setActive((firstTab.getAttribute('href')||'').slice(1)); }" +
                " });" +
                "})();",
            ].join("");

            var html =
              '<!DOCTYPE html><html lang="ar" dir="rtl"><head>' +
              '<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>' +
              "<title>" +
              (state.portfolio && state.portfolio.title
                ? state.portfolio.title
                : "ملف الإنجاز") +
              "</title>" +
              "<style>" +
              css +
              "</style></head><body>" +
              container.innerHTML +
              "<script>" +
              navScript.replace(/<\/script>/gi, "<\\/script>") +
              "<\/script>" +
              "</body></html>";

            // أنشئ الأرشيف
            var zip = new JSZipLib();
            zip.file("index.html", html);
            var af = zip.folder("assets");
            for (var z = 0; z < assets.length; z++) {
              var it = assets[z];
              var ab = await it.blob.arrayBuffer();
              af.file(it.name, ab);
            }
            var zblob = await zip.generateAsync({ type: "blob" });
            var url = URL.createObjectURL(zblob);
            var ael = document.createElement("a");
            var fname =
              (state.portfolio && state.portfolio.title
                ? state.portfolio.title
                : "portfolio") + "_package.zip";
            ael.href = url;
            ael.download = fname;
            ael.click();
            setTimeout(function () {
              URL.revokeObjectURL(url);
            }, 1500);
            UI.note("تم إنشاء ملف ZIP بنجاح وتم تنزيله");
          } catch (err) {
            UI.note("تعذّر إنشاء ملف ZIP", "error");
          }
        };

        UI.updatePortfolioSettingsFromSidebar = function () {
          try {
            var nameEl = document.getElementById("pfName");
            var labelEl = document.getElementById("pfLabel");
            var footerEl = document.getElementById("pfFooter");
            if (!state.portfolio)
              state.portfolio = {
                teacherName: "",
                teacherLabel: "المعلم/ـة",
                footerText: "",
                logoData: "",
              };
            if (nameEl) state.portfolio.teacherName = nameEl.value || "";
            if (labelEl)
              state.portfolio.teacherLabel = labelEl.value || "المعلم/ـة";
            if (footerEl) state.portfolio.footerText = footerEl.value || "";
            UI.refreshPortfolioHeaderFooter();
            saveToStorage();
          } catch (_) {}
        };
        UI.setLogoFile = function () {
          try {
            var inp = document.getElementById("pfLogoFile");
            if (!inp || !inp.files || !inp.files[0]) return;
            var f = inp.files[0];
            var rd = new FileReader();
            rd.onload = function (e) {
              state.portfolio = state.portfolio || {};
              state.portfolio.logoData = e.target.result;
              UI.refreshPortfolioHeaderFooter();
              var d = document.getElementById("pfLogoDownload");
              if (d) {
                d.href = state.portfolio.logoData;
                d.style.display = "inline-flex";
              }
              saveToStorage();
            };
            rd.readAsDataURL(f);
          } catch (_) {}
        };
        UI.setLogoUrl = function () {
          try {
            var urlIn = document.getElementById("pfLogoUrl");
            if (!urlIn) return;
            var v = (urlIn.value || "").trim();
            if (!v) return;
            state.portfolio = state.portfolio || {};
            state.portfolio.logoData = v;
            UI.refreshPortfolioHeaderFooter();
            var d = document.getElementById("pfLogoDownload");
            if (d) {
              d.href = state.portfolio.logoData;
              d.style.display = "inline-flex";
            }
            saveToStorage();
          } catch (_) {}
        };
        UI.clearLogo = function () {
          try {
            if (state.portfolio) {
              state.portfolio.logoData = "";
            }
            UI.refreshPortfolioHeaderFooter();
            var d = document.getElementById("pfLogoDownload");
            if (d) {
              d.style.display = "none";
            }
            saveToStorage();
          } catch (_) {}
        };

        // تفويض النقر: يعمل سواء الأزرار inline أو data-action
        document.addEventListener(
          "click",
          function (e) {
            const btn = e.target.closest(".embed-actions .embed-btn");
            if (!btn) return;
            e.preventDefault();
            e.stopPropagation();
            UI.embedAction(
              btn,
              btn.dataset.action || btn.getAttribute("data-action")
            );
          },
          true
        );

        // منع سحب الوسائط داخل المحرّر (يمنع تكرار العنصر عند السحب)
        document.addEventListener(
          "dragstart",
          function (e) {
            if (
              e.target &&
              e.target.closest &&
              e.target.closest(".embed-container, .embed-actions, .embed-media")
            ) {
              e.preventDefault();
            }
          },
          true
        );

        // تنفيذ كامل لأوامر الشريط العائم للوسائط
        UI.embedAction = function (ref, action) {
          try {
            const btn = ref && ref.nodeType === 1 ? ref : null;
            const cont =
              (btn && btn.closest(".embed-container")) ||
              (ref && ref.closest && ref.closest(".embed-container")) ||
              ref;
            if (!cont) return;

            const mediaWrap = cont.querySelector(".embed-media");
            const mediaEl =
              (mediaWrap && mediaWrap.querySelector("img,video,iframe")) ||
              mediaWrap;

            const act = (
              action ||
              (btn &&
                (btn.dataset?.action ||
                  btn.getAttribute("data-action") ||
                  (btn.getAttribute("aria-label") || "").toLowerCase())) ||
              ""
            ).toLowerCase();

            if (act === "remove") {
              cont.remove();
              saveToStorage();
              return note("تم الحذف");
            }

            if (act === "edit") {
              const cap = cont.querySelector(".embed-caption");
              const cur = (cap && cap.textContent.trim()) || "";
              const v = prompt("حرّر الوصف:", cur);
              if (v !== null) {
                if (cap) cap.textContent = v;
                const img = cont.querySelector("img");
                if (img) img.alt = v || img.alt || "صورة";
                saveToStorage();
                note("تم التعديل");
              }
              return;
            }

            if (act === "replace") {
              state.mode = "replace";
              state.replaceTarget = cont;
              document.getElementById("mediaModalTitle").textContent =
                "استبدال وسائط";
              UI.toggleMediaType("upload");
              show(document.getElementById("mediaModal"));
              return;
            }

            if (act === "fit") {
              if (mediaWrap) mediaWrap.style.width = "100%";
              saveToStorage();
              return note("العرض: 100%");
            }

            if (act === "smaller" || act === "bigger") {
              if (mediaWrap) {
                const pw =
                  (cont.parentElement || el.editor).getBoundingClientRect()
                    .width || 1;
                const cw = mediaWrap.getBoundingClientRect().width || 1;
                let pct = Math.round((cw / pw) * 100);
                pct += act === "bigger" ? 10 : -10;
                pct = Math.max(20, Math.min(100, pct));
                mediaWrap.style.width = pct + "%";
                saveToStorage();
                return note("العرض: " + pct + "%");
              }
            }

            if (act === "setwidth") {
              let v = prompt("أدخل العرض (مثال: 70% أو 400px):", "80%");
              if (!v) return;
              v = v.trim();
              if (!/%$|px$/i.test(v)) v += "%";
              if (mediaWrap) mediaWrap.style.width = v;
              saveToStorage();
              return note("تم ضبط العرض على " + v);
            }

            if (act === "setheight") {
              let v = prompt("الارتفاع بالبكسل (مثال: 500):", "500");
              if (!v) return;
              v = String(v).replace(/[^0-9]/g, "");
              if (!v) return;
              if (mediaWrap) {
                mediaWrap.style.height = v + "px";
                if (
                  mediaEl &&
                  (mediaEl.tagName === "VIDEO" || mediaEl.tagName === "IFRAME")
                ) {
                  mediaEl.style.height = "100%";
                }
              }
              saveToStorage();
              return note("تم ضبط الارتفاع على " + v + "px");
            }

            if (act === "link") {
              state.linkContext = mediaWrap;
              document.getElementById("linkUrl").value = "";
              document.getElementById("linkNewTab").checked = true;
              show(document.getElementById("linkModal"));
              return;
            }

            if (act === "unlink") {
              const a = closest("A", mediaWrap.parentElement);
              if (a) {
                unwrapAnchor(a);
                saveToStorage();
                note("تم فك الرابط");
              }
              return;
            }
          } catch (e) {
            note("تعذر تنفيذ الأمر", "error");
            console.error(e);
          }
        };
      })();
    </script>
  </body>
</html>
